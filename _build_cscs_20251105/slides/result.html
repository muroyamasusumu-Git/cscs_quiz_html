<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1">
<title>1日の結果</title>
<style>
/* ===== 共通ベース ===== */
html,body{
  margin:0; padding:0;
  background:#111; color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;
  height:auto !important; min-height:0 !重要;  /* ← 追加（ビルド出力を最優先に） */
}
.wrap{ width:min(1000px,90vw); margin:40px auto; line-height:1.5; font-size:32px; }

/* ===== topmeta（横並び構成） ===== */
.topmeta{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  flex-wrap:wrap;
  border-bottom:1px solid #2a2a2a;
  margin-bottom:22px;
  padding-bottom:8px;
}
.top-left-group{
  display:flex;
  align-items:baseline;
  gap:20px;
  flex-wrap:wrap;
}
.top-title{
  font-size:.75em;
  font-weight:700;
  letter-spacing:.02em;
  opacity:.95;
}
.top-subtitle{
  font-size:.65em;
  color:#ccc;
  opacity:.9;
}
.top-date{
  font-size:.55em;
  color:#a8b0b8;
}

/* ===== コントロール/要約/表 ===== */
.controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:12px 0 16px;}
select,button,a.btn{
  background:#202020;
  border:1px solid #3a3a3a;
  border-radius:6px;
  color:#fff;
  padding:6px 10px;
  text-decoration:none;
  cursor:pointer;
  font-size:.6em;
}
.summary{font-size:.75em;margin:1em 0;line-height:1.6;}
.summary .pill{
  display:inline-block;
  background:#1d1d1d;
  border:1px solid #343434;
  border-radius:999px;
  padding:2px 8px;
  font-size:.8em;
  margin-left:.6em;
}
table{
  width:100%;
  border-collapse:collapse;
  background:#161616;
  border-radius:8px;
  overflow:hidden;
  font-size:.6em;
}
th,td{padding:8px 12px;border-bottom:1px solid #333;text-align:left;vertical-align:top;}
th{background:#1c1c1c;font-weight:600;}
tr:nth-child(even){background:#181818;}

/* ===== リンクと固定ボタン ===== */
a{color:#66d9ff;text-decoration:none;}
a:hover{text-decoration:underline;}
.back-to-top{
  position:fixed;
  left:16px; bottom:16px;
  padding:6px 10px;
  background:rgba(255,255,255,.08);
  color:#66d9ff;
  border-radius:6px;
  text-decoration:none;
  z-index:10050;
  transition:background .2s, opacity .2s;
}
.back-to-top:hover{background:rgba(255,255,255,.15);opacity:1;}
</style>
</head>
<body>
  <div class="wrap">

    <!-- === 共通ヘッダー（横並び：タイトル＋本日の結果＋日付） === -->
    <div class="topmeta">
      <div class="top-left-group">
        <div class="top-title">NSCA CSCS 試験対策問題集</div>
        <div class="top-subtitle">本日の結果</div>
      </div>
      <div class="top-date" id="topDate"></div>
    </div>

    <div class="controls">
      <label>履歴(run)：<select id="runSelect"></select></label>
      <a class="btn" id="restartBtn" href="q001_a.html?newrun=1">新しい履歴で最初から</a>
      <button class="btn" id="deleteRunBtn" type="button">この履歴を削除</button>
    </div>

    <div class="summary" id="summary">読み込み中...</div>
    <table id="resultTable"></table>
  </div>

  <a class="back-to-top" href="../../index.html">［TOPへ戻る］</a>

<script>
(function(){
  // --- ヘルパ ---
  function getDayFromPath(){
    const m=(window.location.pathname||"").match(/_build_cscs_(\d{8})/);
    return m?m[1]:"unknown";
  }
  function runKey(day){ return `cscs_current_runId_${day}`; }
  function getRunsForDay(day, all){
    const set = new Set(all.filter(r=>r && r.day===day && Number.isInteger(r.runId)).map(r=>r.runId));
    return Array.from(set).sort((a,b)=>a-b);
  }
  function formatJa(day){ // "20251003" -> "2025年10月3日"
    if(!/^\d{8}$/.test(day)) return day;
    const y=day.slice(0,4), m=parseInt(day.slice(4,6),10), d=parseInt(day.slice(6,8),10);
    return `${y}年${m}月${d}日`;
  }

  const KEY="cscs_results";
  let all=[]; try{ all = JSON.parse(localStorage.getItem(KEY)||"[]"); }catch(e){ all=[]; }
  const day = localStorage.getItem("cscs_last_day") || getDayFromPath();
  const total = 30;
  const runSel = document.getElementById("runSelect");

  // ▼ 追加：問題文を nav_manifest.json から引くための簡易ローダ
  //   - qtextMap: "q001" → "問題文テキスト"
  //   - 初回 render() 時に未ロードなら非同期で取得→完了後に再 render()
  let qtextMap = null;
  let navLoading = false;
  function ensureNavManifest(cb){
    if (qtextMap && qtextMap.size) { cb && cb(); return; }
    if (navLoading) { return; }
    navLoading = true;
    fetch("nav_manifest.json")
      .then(r => r.ok ? r.json() : Promise.reject(new Error("failed to load nav_manifest.json")))
      .then(data => {
        const map = new Map();
        try{
          const arr = (data && data.questions) ? data.questions : [];
          arr.forEach(q => {
            const n = q && typeof q.Number === "number" ? q.Number : 0;
            const stem = n ? ("q" + String(n).padStart(3, "0")) : "";
            if (stem) {
              const qt = (q.Question || "").toString().trim();
              map.set(stem, qt);
            }
          });
        }catch(_){}
        qtextMap = map;
        navLoading = false;
        cb && cb();
      })
      .catch(_ => { navLoading = false; /* 失敗時は空のまま */ });
  }

  // ▼ 正解率用ヘルパ：日付=day の全履歴から stem ごとに {total, correct} を作る
  function buildAccuracyMap(allResults, day){
    const byStem = new Map();
    const rows = (allResults || []).filter(r => r && r.day === day);
    rows.forEach(r => {
      const key = r.stem;
      if (!key) return;
      const agg = byStem.get(key) || { total: 0, correct: 0 };
      agg.total += 1;
      if (r.correct) agg.correct += 1;
      byStem.set(key, agg);
    });
    return byStem;
  }
  function formatPct(correct, total){
    if (!total) return "0% (0/0)";
    const pct = Math.round((correct / total) * 100);
    return `${pct}% (${correct}/${total})`;
  }
  // ▼ 不正解回数ログ（cscs_wrong_log）を読むヘルパ
  function getWrongLog(){
    try { return JSON.parse(localStorage.getItem("cscs_wrong_log") || "{}"); }
    catch (_){ return {}; }
  }
  function wrongCountForStem(day, stem, wrongLog){
    // stem: "q001" → "001"
    const qnum = (stem || "").slice(1);
    const qid  = `${day}-${qnum}`;
    return wrongLog[qid] || 0;
  }

  // ▼ 追加カウンタ（b_judge_record.js で記録している想定鍵）
  function readInt(key, def=0){
    const v = localStorage.getItem(key);
    if (v == null) return def;
    const n = parseInt(v, 10);
    return Number.isFinite(n) ? n : def;
  }
  function readBool01(key){
    const v = localStorage.getItem(key);
    if (v == null) return 0;
    if (v === "1" || v === "true") return 1;
    return 0;
  }

  // ヘッダー右側に日付を表示
  document.getElementById("topDate").textContent = formatJa(day);

  function rebuildRunOptions(){
    try{ all = JSON.parse(localStorage.getItem(KEY)||"[]"); }catch(_){ all = []; }
    const runs = getRunsForDay(day, all);
    runSel.innerHTML = "";
    if (runs.length===0){
      const opt=document.createElement("option");
      opt.value="1"; opt.textContent="run #1";
      runSel.appendChild(opt);
      runSel.value="1";
      return;
    }
    runs.forEach(r=>{
      const opt=document.createElement("option");
      opt.value=String(r); opt.textContent=`run #${r}`;
      runSel.appendChild(opt);
    });

    // ★ 変更点：保存済みの現在runがあればそれを優先、無ければ最新runを選択
    const saved = localStorage.getItem(runKey(day));
    if (saved && runs.includes(parseInt(saved,10))) {
      runSel.value = String(parseInt(saved,10));
    } else {
      runSel.value = String(runs[runs.length-1]); // デフォルト: 最新 run
    }
  }

  function render(){
    const runId = parseInt(runSel.value,10);
    const results = all.filter(r=>r && r.day===day && r.runId===runId);
    const summary=document.getElementById("summary");
    const table=document.getElementById("resultTable");
    table.innerHTML="";

    if(results.length===0){
      // カウンタもゼロで出す
      const uniq = readBool01(`cscs_daily_unique_done:${day}`);
      const ca   = readInt(`cscs_correct_attempts_${day}`, 0);
      const wa   = readInt(`cscs_wrong_attempts_${day}`, 0);
      const s3t  = readInt(`cscs_streak3_today_${day}`, 0);
      const s3   = readInt("cscs_streak3_total", 0);
      summary.innerHTML = [
        `日付：<strong>${formatJa(day)}</strong>`,
        `run：<strong>#${runId}</strong>`,
        `正解数：<strong>0</strong> / ${total}（0%）`,
        `<span class="pill">今日のユニーク正解：${uniq ? "1" : "0"}</span>`,
        `<span class="pill">今日の正解試行：${ca}</span>`,
        `<span class="pill">今日の不正試行：${wa}</span>`,
        `<span class="pill">3連正解（今日/累計）：${s3t} / ${s3}</span>`
      ].join("　");
      return;
    }

    // 同一 stem は最後の回答を採用
    const lastByStem = new Map();
    results.sort((a,b)=>a.ts-b.ts).forEach(r=> lastByStem.set(r.stem, r));
    const picked = Array.from(lastByStem.values()).sort((a,b)=>a.stem.localeCompare(b.stem));

    const correct = picked.filter(r=>r.correct).length;

    // 追加カウンタ読み出し
    const uniq = readBool01(`cscs_daily_unique_done:${day}`);
    const ca   = readInt(`cscs_correct_attempts_${day}`, 0);
    const wa   = readInt(`cscs_wrong_attempts_${day}`, 0);
    const s3t  = readInt(`cscs_streak3_today_${day}`, 0);
    const s3   = readInt("cscs_streak3_total", 0);

    summary.innerHTML=[
      `日付：<strong>${formatJa(day)}</strong>`,
      `run：<strong>#${runId}</strong>`,
      `正解数：<strong>${correct}</strong> / ${total}（${Math.round(correct/total*100)}%）`,
      `<span class="pill">今日のユニーク正解：${uniq ? "1" : "0"}</span>`,
      `<span class="pill">今日の正解試行：${ca}</span>`,
      `<span class="pill">今日の不正試行：${wa}</span>`,
      `<span class="pill">3連正解（今日/累計）：${s3t} / ${s3}</span>`
    ].join("　");

    const header=document.createElement("tr");
    header.innerHTML="<th>番号</th><th>問題文</th><th>選択</th><th>正解</th><th>判定</th><th>正解率</th><th>不正解回数</th>";
    table.appendChild(header);

    const wrongLog = getWrongLog();
    const accMap   = buildAccuracyMap(all, day);

    // ▼ nav_manifest が未読込なら読み込んでから再描画（初回のみ）
    if (!qtextMap || !qtextMap.size) {
      ensureNavManifest(render);
    }

    picked.forEach(r=>{
      const tr=document.createElement("tr");
      const wrongCnt = wrongCountForStem(day, r.stem, wrongLog);
      const agg = accMap.get(r.stem) || { total: 0, correct: 0 };
      const rate = formatPct(agg.correct, agg.total);
      const qtext = (qtextMap && qtextMap.get(r.stem)) ? qtextMap.get(r.stem) : (navLoading ? "取得中…" : "");

      // 番号セルは A へリンク（例：q001 → q001_a.html）
      const numCell = `<a href="${r.stem}_a.html">${r.stem}</a>`;

      tr.innerHTML=`<td>${numCell}</td>
        <td>${qtext}</td>
        <td>${r.choice}</td>
        <td>${r.correctChoice}</td>
        <td style='color:${r.correct?"#fff34d":"#c9c9c9"}'>${r.correct?"◎ 正解":"× 不正解"}</td>
        <td>${rate}</td>
        <td>${wrongCnt}</td>`;
      table.appendChild(tr);
    });

    localStorage.setItem(runKey(day), String(runId));
  }

  rebuildRunOptions();
  runSel.addEventListener("change", render);
  render();

  // --- この履歴(run)を削除 ---
  document.getElementById("deleteRunBtn").addEventListener("click", () => {
    const runId = parseInt(runSel.value, 10);
    if (!confirm(`run #${runId} を削除しますか？\nこの日のこの履歴の回答がすべて消えます。`)) return;

    try {
      let arr=[]; try{ arr = JSON.parse(localStorage.getItem(KEY)||"[]"); }catch(_){ arr = []; }
      arr = arr.filter(r => !(r && r.day===day && r.runId===runId));
      localStorage.setItem(KEY, JSON.stringify(arr));

      const k = runKey(day);
      const remainingRuns = Array.from(new Set(arr.filter(r=>r && r.day===day).map(r=>r.runId))).sort((a,b)=>a-b);
      if (remainingRuns.length) localStorage.setItem(k, String(remainingRuns[remainingRuns.length-1]));
      else localStorage.removeItem(k);

      all = arr;
      rebuildRunOptions();
      render();
      alert("削除しました。");
    } catch(e) {
      console && console.warn && console.warn(e);
      alert("削除に失敗しました。");
    }
  });
})();
</script>
</body></html>