<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1">
<meta name="cscs-qid" content="20251116-002">
  <meta charset="utf-8">
  <style>
html, body {
  margin: 0;
  padding: 0;
  background: #111;
  color: #fff;
  width: 100%;
  height: 100%;
}

.wrap {
  margin: 40px auto;
  font-family: -apple-system, BlinkMacSystemFont,
               "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo", sans-serif;
  line-height: 1.5;
  font-size: 32px;
}


.top-title  { opacity:.95; color:#fff; }
.top-date   { color:#a8b0b8; opacity:.95; }
.top-number { color:#c9c9c9; }
.top-level  { color:#a8a8a8; }
.crumb-field{font-size:26px;font-weight:400}
.crumb-sep{opacity:.6}
.crumb-theme{font-size:22px;opacity:.85}

/* ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨ï¼ˆå·¦å³ãƒ–ãƒ­ãƒƒã‚¯ï¼‹å³ç«¯æ—¥ä»˜ï¼‰ */
.topmeta {
  display: flex;
  justify-content: space-between;  /* å·¦å³ã‚’åˆ†ã‘ã‚‹ */
  align-items: center;
  gap: 16px;
  font-size: 24px;
  font-weight: 500;
  color: rgba(255, 255, 255, 0.7);
  opacity: 0.85;
  margin-bottom: 6px;
  flex-wrap: wrap;
}

/* å·¦ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼ç•ªå·ï¼ãƒ¬ãƒ™ãƒ«ï¼‰ */
.topmeta-left {
  display: flex;
  flex-wrap: wrap;
  gap: 14px;
  align-items: center;
}

/* å³ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆæ—¥ä»˜ã ã‘å³ç«¯ã«å¯„ã›ã‚‹ï¼‰ */
.topmeta-right {
  margin-left: auto;
  text-align: right;
  white-space: nowrap;
}

.qno {
  font-size: 20px;
  opacity: .9;
  margin: 6px 0 2px;
}

/* å•é¡Œæ–‡ */
h1 {
  font-size: 44px;
  margin: 10px 0 10px;
  color: #66d9ff;     /* æ˜ã‚‹ã„æ°´è‰² */
  line-height: 1.10;  /* ã‚¿ã‚¤ãƒˆã« */
  overflow-wrap: anywhere;
  word-break: break-word;
}

/* é¸æŠè‚¢ */
.opts {
  padding-left: 1.1em;
  margin-left: 15px;
  margin-top: 0;
}

ol.opts {
    margin-bottom: 20px;
}

.opts li {
  margin-top: 2px;
  margin-bottom: 2px;
}

/* åŒºåˆ‡ã‚Šç·š */
.hr {
  height: 1px;
  background: #444;
  margin: 0 0 8px;
}

/* æ­£è§£ */
.answer { margin-top: 12px; font-weight: 600; }
.answer { word-break: break-word; }
.answer {
  font-size: 40px;
  margin-top: 0;
  margin-left: 0;
  color: #fff34d;  /* æ˜ã‚‹ã„é»„è‰² */
}

/* Bãƒ‘ãƒ¼ãƒˆã®ã€Œæ­£è§£: Aã€€æœ¬ã€€æ–‡ã€ã®â€œæœ¬æ–‡â€ã ã‘å°‘ã—å°ã•ã */
.answer .opt-small {
  font-size: 0.85em;   /* â† ã»ã‚“ã®å°‘ã—å°ã•ãï¼ˆ0.85ã€œ0.95ã§èª¿æ•´ï¼‰ */
  line-height: 1.25;  /* ä»»æ„ï¼šè¡Œé–“ã‚’å°‘ã—è©°ã‚ã‚‹ */
  opacity: 0.95;      /* ä»»æ„ï¼šã‚ãšã‹ã«è½ã¨ã—ã¦ä¸»å½¹ã®Aã‚’å¼·èª¿ */
  margin-left: 10px;
}

/* è§£èª¬ */
.explain {
  font-size: 16px;
  margin-top: 4px;
  margin-left: 0;
  opacity: .92;
  white-space: pre-wrap;
}

/* ãƒ’ãƒ³ãƒˆï¼ˆBæœªè¡¨ç¤ºæ®µéšï¼‰ */
.hint {
  font-size: 22px;
  opacity: .6;
  margin-top: 0;
  margin-left: 0;
}
  
/* ç”»é¢å…¨ä½“ã‚¯ãƒªãƒƒã‚¯ç”¨ã®é€æ˜ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
.next-overlay {
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: transparent;
  cursor: pointer;
  display: block;
}


/* åˆ¤å®šç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘å°‘ã—æ§ãˆã‚ã« */
#judge {
  font-size: 28px;
  margin-top: 12px;
  opacity: 0.9;
}


/* å·¦ä¸‹ [TOPã¸æˆ»ã‚‹] ãƒœã‚¿ãƒ³ */
.back-to-top {
  position: fixed;
  left: 16px;
  bottom: 16px;
  padding: 6px 10px;
  background: rgba(255,255,255,0.08);
  color: #66d9ff;
  font-size: 16px;
  border-radius: 6px;
  text-decoration: none;
  z-index: 10050; /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤(9999)ã‚„ä»–è¦ç´ ã‚ˆã‚Šå‰é¢ã«ã—ã¦ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã« */
  transition: background 0.2s, opacity 0.2s;
}
.back-to-top:hover {
  background: rgba(255,255,255,0.15);
  opacity: 1.0;
}


/* é¸æŠè‚¢ãƒªãƒ³ã‚¯ã®è‰²ã‚’å¸¸ã«æœ¬æ–‡è‰²ã«ï¼ˆiOSã®visited/activeã®é’/ç´«ã‚‚æ½°ã™ï¼‰ */
ol.opts a.opt-link,
ol.opts a.opt-link:link,
ol.opts a.opt-link:visited,
ol.opts a.opt-link:active,
ol.opts a.opt-link:hover,
ol.opts a.opt-link:focus {
  color: inherit !important;
  -webkit-text-fill-color: currentColor !important; /* iOS Safari */
  text-decoration: none;
}
ol.opts a.opt-link:hover,
ol.opts a.opt-link:focus { text-decoration: underline; }

/* iOSã®ã‚¿ãƒƒãƒ—æ™‚ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ§ãˆã‚ã« */
a { -webkit-tap-highlight-color: rgba(255,255,255,0.12); }

</style>

<script src="../../assets/correct_star.js" defer></script>


<script src="../../assets/b_judge.js" data-stem="q002" data-audio-base="/_build_cscs_20251116/audio" data-ext=".wav"></script>


<script>
// CSCS backfill æŠ‘æ­¢ã‚·ãƒ ï¼ˆTTLå†…ã®ã¿ backfill ã‚’ç„¡åŠ¹åŒ–ã€‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨˜éŒ²ã¯ç¨¼åƒï¼‰
(() => {
  const epoch = Number(localStorage.getItem('cscs_reset_epoch') || 0);
  const ttl   = Number(localStorage.getItem('cscs_reset_ttl_ms') || 0);
  const suppressed = (Date.now() - epoch) < ttl;
  window.__CSCS_BACKFILL_SUPPRESSED__ = suppressed;

  // b_judge_record.js ãŒå®šç¾©ã™ã‚‹ backfill é–¢æ•°ã‚’ NOOP ã«å·®ã—æ›¿ãˆ
  function patch(){
    if (!suppressed) return;                  // æŠ‘æ­¢æœŸé–“å¤–ãªã‚‰ä½•ã‚‚ã—ãªã„
    const f1 = window.cscsBackfillIfNeeded;
    const f2 = window.cscs_backfill_if_needed;
    if (!f1 && !f2) { setTimeout(patch, 0); return; }  // æœ¬ä½“æœªèª­è¾¼ãªã‚‰æ¬¡ã®tickã§å†è©¦è¡Œ
    const noop = () => console.info('ğŸš« backfill suppressed (TTL)');
    if (typeof f1 === 'function') window.cscsBackfillIfNeeded    = noop;
    if (typeof f2 === 'function') window.cscs_backfill_if_needed = noop;
  }
  setTimeout(patch, 0);
})();
</script>

<script src="../../assets/b_judge_record.js" defer></script>


<link rel="stylesheet" href="../../assets/wrong_badge.css">
<script src="../../assets/wrong_badge.js" defer></script>


<link rel="stylesheet" href="../../assets/fav_modal.css">
<script src="../../assets/fav_modal.js" defer></script>


<link rel="stylesheet" href="../../assets/deep_dive.css">
<script src="../../assets/deep_dive.js" data-mode="dynamic" data-autoload="1" defer></script>
<script>window.DeepDive&&typeof window.DeepDive.init==="function"&&window.DeepDive.init({mode:"dynamic"});</script>
<script src="../../assets/deep_dive_inline.js" defer></script>


<script src="../../assets/consistency_check_debug.js" data-part="b" defer></script>


  <script>
    (function(){
      function isDeepDiveOpen(){
        try{
          const p = document.getElementById('dd-panel');
          return p && p.style && p.style.display !== 'none';
        }catch(_){ return false; }
      }
      function clickIsInsideDeepDive(target){
        return !!(target && (target.closest && (
          target.closest('#dd-panel') ||         // ãƒ‘ãƒãƒ«å†…
          target.closest('.deep-dive-btn') ||    // ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³
          target.closest('.dd-btn')              // ç”Ÿæˆ/å†ç”Ÿæˆ/ã‚³ãƒ”ãƒ¼/é–‰ã˜ã‚‹ ç­‰
        )));
      }

      // â–¼ è¿½åŠ ï¼šãŠæ°—ã«å…¥ã‚Šãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰æ¤œçŸ¥ï¼†å†…å´ã‚¯ãƒªãƒƒã‚¯æ¤œå‡º
      function isFavOpen(){
        try{
          const bd = document.getElementById('fav-backdrop');
          if (!bd) return false;
          // display:flex ä¸­ã¯é–‹ã„ã¦ã„ã‚‹æ‰±ã„
          const st = window.getComputedStyle ? getComputedStyle(bd) : bd.style;
          return (bd.style.display === 'flex') || (st && st.display === 'flex');
        }catch(_){ return false; }
      }
      function clickIsInsideFav(target){
        return !!(target && (target.closest && (
          target.closest('#fav-backdrop .fav-modal') || // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…
          target.closest('#fav-backdrop')               // ãƒãƒƒã‚¯ãƒ‰ãƒ­ãƒƒãƒ—
        )));
      }

      const nextHref = "q003_a.html";
      function goNext(){ window.location.href = nextHref; }

      document.addEventListener("click", (e) => {
        // â–¼ è¿½åŠ ï¼šæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ãƒ‘ãƒãƒ«å†…ãªã‚‰é·ç§»ã—ãªã„
        if (e.target.closest("#cscs-consistency-panel")) return;

        // Deep Dive ã¾ãŸã¯ ãŠæ°—ã«å…¥ã‚Šãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œä¸­ã¯é·ç§»ã—ãªã„
        if (isDeepDiveOpen() || clickIsInsideDeepDive(e.target)) return;
        if (isFavOpen() || clickIsInsideFav(e.target)) return;

        // æ—¢å­˜ã®é™¤å¤–ï¼šéŸ³å£°ãƒœã‚¿ãƒ³ / aã‚¿ã‚°
        if (e.target.closest(".audio-fallback-btn")) return;
        if (e.target.closest("a")) return;

        // ãã®ä»–ã®ã‚¯ãƒªãƒƒã‚¯ã§æ¬¡ã¸
        goNext();
      });

      document.addEventListener("keydown", (e) => {
        // Deep Dive or Fav ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹æ™‚ã¯ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰é·ç§»ã‚‚æŠ‘æ­¢
        if (isDeepDiveOpen() || isFavOpen()) return;

        if (e.key === " " || e.key === "Enter" || e.key === "ArrowRight") {
          e.preventDefault();
          goNext();
        }
      });

      // å¿µã®ãŸã‚ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®å‰é¢åŒ–
      const ov = document.querySelector(".next-overlay");
      if (ov) {
        ov.style.zIndex = 9999;
        ov.setAttribute("aria-label","æ¬¡ã®å•é¡Œã¸");
        ov.setAttribute("role","link");
        ov.setAttribute("tabindex","0");
      }
    })();
  </script>


<style>
/* å…¨ãƒšãƒ¼ã‚¸å¼·åˆ¶ï¼šhtml/body ã®é«˜ã•æŒ‡å®šã‚’è§£é™¤ */
html, body { height: auto !important; min-height: 0 !important; }
</style>


<link rel="stylesheet" href="../../assets/main.css">


<style>
.top-date {
    color: #a8b0b8;
    opacity: .95;
    font-size: 22px;
    width: auto;
    margin: 0 10px 0 0;
}
.crumb-field {
    font-size: 22px;
    font-weight: 400;
}
.correct_star {
    display: none;
    font-size: 22px;
    margin: 0 0 0 6px;
}
</style>


<style>
/* å¾Œã‹ã‚‰ --h1-lh ã§è‡ªç”±ã«å¤‰æ›´å¯ï¼ˆæ—¢å®šã¯ normalï¼‰ */
h1 { line-height: var(--h1-lh, normal); }
</style>


<style>
/* å¾Œã‹ã‚‰ --h1-fs ã§è‡ªç”±ã«å¤‰æ›´å¯ï¼ˆæ—¢å®šã¯ inheritã€‚UAæ—¢å®šã‚„ main.css ãŒæ±ºã‚ã‚‹ï¼‰ */
h1 { font-size: var(--h1-fs, inherit); }
</style>


<script src="../../assets/correct_star.js" defer></script>


<style>
/* ä¸æ­£è§£è¡¨ç¤ºä¸€å¸¯ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³styleã‚’å¾Œå‹ã¡ã§ç„¡åŠ›åŒ–ã€‚å€¤ã¯CSSå¤‰æ•°ã‚’å‚ç…§ã—ã€main.cssã§å®šç¾©ã™ã‚‹ */
#judge span[style*="font-size"] { font-size: var(--judge-choice-fs, 0.95em) !important; }
#judge span[style*="color"] { color: var(--judge-dim-color, #c9c9c9) !important; }
/* ã“ã“ã§ã¯ --judge-choice-fs / --judge-dim-color ã‚’å†å®šç¾©ã—ãªã„ï¼ˆmain.cssã§æŒ‡å®šã™ã‚‹ï¼‰ */
</style>

<!-- JUDGE_OVERRIDE_CSS_APPLIED -->

<style>
/* B: æ­£è§£ã®é¸æŠè‚¢ã«ä¸‹ç·šï¼ˆAã‚¿ã‚°ãŒãªã„Bãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«ã‚‚å¯¾å¿œï¼‰ */
ol.opts li.is-correct {
  text-decoration: underline !important;
  text-decoration-thickness: 2px;
  text-underline-offset: 2px;
}
/* å°†æ¥Aã‚¿ã‚°åŒ–ã•ã‚ŒãŸå ´åˆã«ã‚‚åŠ¹ãã‚ˆã†ã«ä½µè¨˜ */
ol.opts li.is-correct > a.opt-link,
ol.opts li.is-correct a.opt-link {
  text-decoration: underline !important;
  text-decoration-thickness: 2px;
  text-underline-offset: 2px;
}
/* Fallbackï¼šå¤ªã•æœªå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ */
@supports not (text-decoration-thickness: 2px) {
  ol.opts li.is-correct { border-bottom: 2px solid currentColor; padding-bottom: 2px; }
}
</style>

<!-- B_CORRECT_UNDERLINE_APPLIED -->
</head>
<body>
<div id="root">
  <div class="wrap">
    <div class='topmeta'><div class='topmeta-left'><div class='top-title'>NSCA CSCS å•é¡Œé›† (52/90)</div><div class='top-number'>ç•ªå·: <span class='top-number-val'>2/30</span></div><div class='top-level'>Lvl 1</div></div><div class='topmeta-right'></div></div>
    <div class='qno'><span class="correct_star">â­ï¸</span><span class="consistency_status">â—</span><span class="top-date">2025å¹´11æœˆ16æ—¥</span><span class='crumb-field'>ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒ‡ã‚¶ã‚¤ãƒ³</span><span class='crumb-sep'> ï¼ </span><span class='crumb-theme'>æ¼¸é€²çš„éè² è·</span></div>
    <h1 style="">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§ã€Œæ¼¸é€²æ€§éè² è·ã®åŸå‰‡ã€ã‚’å®ˆã‚‹ç›®çš„ã¯ã©ã‚Œã‹</h1>
    <ol class='opts' type='A'><li>åˆºæ¿€ã‚’ä¸€å®šã«ä¿ã¤</li><li>ç–²åŠ´ã‚’æœ€å°åŒ–ã™ã‚‹ãŸã‚å¤‰åŒ–ã‚’é¿ã‘ã‚‹</li><li class="is-correct">å¾ã€…ã«ä½“ã¸æ–°ã—ã„åˆºæ¿€ã‚’ä¸ãˆã‚‹</li><li>åŒã˜ç¨®ç›®ã ã‘ã‚’ç¶šã‘ã‚‹</li></ol>
    <div id="judge" class="answer" aria-live="polite"></div>
    <div class='hr'></div><div class='answer'>æ­£è§£: C<span class='opt-small'>å¾ã€…ã«ä½“ã¸æ–°ã—ã„åˆºæ¿€ã‚’ä¸ãˆã‚‹</span></div><div class='explain'><span class="explain-text">æ¼¸é€²æ€§éè² è·ã¯å°‘ã—ãšã¤è² è·ã‚’ä¸Šã’ã‚‹ã“ã¨ã§é©å¿œã‚’ä¿ƒé€²ã™ã‚‹åŸå‰‡ã€‚åœæ»ã‚’é˜²ãç¶™ç¶šçš„æˆé•·ã‚’å¼•ãå‡ºã™åŸºæœ¬ã§ã‚ã‚‹ã€‚</span></div>
    <!-- <div class="footer">ï¼ˆã“ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã¯è‡ªå‹•ç”Ÿæˆã§ã™ï¼‰</div> -->
  </div>
<script type="application/json" id="cscs-meta">{"qid": "2025å¹´11æœˆ16æ—¥-002", "field": "ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒ‡ã‚¶ã‚¤ãƒ³", "theme": "æ¼¸é€²çš„éè² è·", "level": "Level 1", "date": "2025å¹´11æœˆ16æ—¥", "number": "2", "quiztype": "å˜ä¸€åˆ†é‡", "tags": {"cause": "è² è·æ¼¸å¢—è¨­è¨ˆ", "process": "é©å¿œåˆºæ¿€ç¶­æŒ", "outcome": "ç¶™ç¶šçš„æˆé•·ä¿ƒé€²"}}</script>

<script>
(function(){
  // Bãƒšãƒ¼ã‚¸ã® URL ã‹ã‚‰ qid = "YYYYMMDD-NNN" ã‚’å–å¾—
  function detectInfo(){
    const m = location.pathname.match(/_build_cscs_(\d{8})\/slides\/q(\d{3})_b/);
    if (!m) return null;
    const day = m[1];       // ä¾‹: "20250926"
    const n3  = m[2];       // ä¾‹: "001"
    const qid = `${day}-${n3}`;
    return { day, n3, qid };
  }

  const info = detectInfo();
  if (!info) return;

  // b_judge_record.js ãŒç®¡ç†ã—ã¦ã„ã‚‹ã€Œæœ¬ç‰©ã®ç´¯ç©ã‚­ãƒ¼ã€
  const KEY_COR      = `cscs_q_correct_total:${info.qid}`;
  const KEY_WRG      = `cscs_q_wrong_total:${info.qid}`;
  const KEY_S3       = `cscs_q_correct_streak3_total:${info.qid}`;

  // Bå´ã ã‘ã§ä½¿ã†ã€Œæœ€å¾Œã« SYNC æ¸ˆã¿ã ã£ãŸã¨ãã®ç´¯ç©å€¤ã€
  const KEY_LAST_COR = `cscs_sync_last_c:${info.qid}`;
  const KEY_LAST_WRG = `cscs_sync_last_w:${info.qid}`;
  const KEY_LAST_S3  = `cscs_sync_last_s3:${info.qid}`;

  function loadInt(key){
    const v = localStorage.getItem(key);
    if (v == null) return 0;
    const n = parseInt(v, 10);
    return Number.isFinite(n) ? n : 0;
  }

  function saveInt(key, value){
    localStorage.setItem(key, String(value));
  }

  async function syncFromTotals(){
    // 1) ç¾åœ¨ã®ç´¯ç©ï¼ˆb_judge_record.js ãŒæ›¸ã„ãŸå€¤ï¼‰
    const cNow  = loadInt(KEY_COR);
    const wNow  = loadInt(KEY_WRG);
    const s3Now = loadInt(KEY_S3);

    // 2) å‰å› SYNC æ™‚ç‚¹ã®å€¤ï¼ˆå­˜åœ¨ã—ãªã‘ã‚Œã° 0 æ‰±ã„ï¼‰
    const cLast  = loadInt(KEY_LAST_COR);
    const wLast  = loadInt(KEY_LAST_WRG);
    let s3Last = loadInt(KEY_LAST_S3);

    // local ãŒ s3Last ã‚ˆã‚Šå°ã•ã„å ´åˆ â†’ s3Last ã‚’ local ã«å¼·åˆ¶ä¿®æ­£
    if (s3Last > s3Now) {
    console.warn("[SYNC/B] ä¿®æ­£: s3Last ãŒ local ã‚ˆã‚Šå¤§ãã‹ã£ãŸãŸã‚è£œæ­£ã—ã¾ã—ãŸ");
    s3Last = s3Now;
    saveInt(KEY_LAST_S3, s3Last);
    }

    // 3) å·®åˆ†ï¼ˆãƒã‚¤ãƒŠã‚¹ã¯é€ã‚‰ãªã„ï¼‰
    const dc  = Math.max(0, cNow  - cLast);
    const dw  = Math.max(0, wNow  - wLast);
    const ds3 = Math.max(0, s3Now - s3Last);

    // é€ã‚‹ã¹ãå·®åˆ†ãŒç„¡ã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
    if (!dc && !dw && !ds3) return;

    // 4) /api/sync/merge ã¸ã€Œå·®åˆ†ã ã‘ã€ã‚’é€ä¿¡ï¼ˆAãƒ‘ãƒ¼ãƒˆã¨åŒã˜ Delta å½¢å¼ï¼‰
    const payload = {
      correctDelta:   dc  > 0 ? { [info.qid]: dc  } : {},
      incorrectDelta: dw  > 0 ? { [info.qid]: dw  } : {},
      streak3Delta:   ds3 > 0 ? { [info.qid]: ds3 } : {},
      updatedAt: Date.now()
    };

    console.log("[SYNC/B] streak3 merge payload", {
      qid: info.qid,
      cNow,
      wNow,
      s3Now,
      cLast,
      wLast,
      s3Last,
      dc,
      dw,
      ds3,
      payload
    });

    try{
      const res = await fetch("/api/sync/merge", {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(res.status);

      // 5) æˆåŠŸã—ãŸã‚‰ã€Œä»Šå›é€ä¿¡å¾Œã®ç´¯ç©å€¤ã€ã‚’ä¿å­˜ã—ã¦æ¬¡å›å·®åˆ†ã®åŸºæº–ã«ã™ã‚‹
      if (dc)  saveInt(KEY_LAST_COR, cNow);
      if (dw)  saveInt(KEY_LAST_WRG, wNow);
      if (ds3) saveInt(KEY_LAST_S3,  s3Now);
    }catch(e){
      console.warn("[SYNC/B] merge failed", e);
    }
  }

  // b_judge_record.js ã®é›†è¨ˆãŒçµ‚ã‚ã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«è¿‘ã¥ã‘ã‚‹ãŸã‚ã€
  // DOM å®Œæˆå¾Œã« 1 tick é…ã‚‰ã›ã¦å®Ÿè¡Œ
  function schedule(){
    if (document.readyState === "loading") {
      window.addEventListener("DOMContentLoaded", function(){
        setTimeout(syncFromTotals, 0);
      });
    } else {
      setTimeout(syncFromTotals, 0);
    }
  }

  function showStreakStatus(){
    const localTotal  = loadInt(KEY_S3);
    const syncedTotal = loadInt(KEY_LAST_S3);

    console.log("== Bãƒ‘ãƒ¼ãƒˆ: 3é€£ç¶šæ­£è§£ SYNC ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ==");
    console.log("qid:", info.qid);
    console.log("localStorage[KEY_S3] =", localStorage.getItem(KEY_S3), "â†’", localTotal);
    console.log("localStorage[KEY_LAST_S3] =", localStorage.getItem(KEY_LAST_S3), "â†’", syncedTotal);

    if (localTotal === 0 && syncedTotal === 0) {
      console.log("â„¹ ã¾ã ã“ã®å•é¡Œã§ã¯ 3å›é€£ç¶šæ­£è§£ãŒç™ºç”Ÿã—ã¦ã„ã¾ã›ã‚“ã€‚");
    } else if (localTotal === syncedTotal) {
      console.log(`âœ… 3é€£ç¶šæ­£è§£å›æ•°: SYNC ${syncedTotal} å› / local ${localTotal} å›ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰ã§ã™ã€‚`);
    } else if (syncedTotal < localTotal) {
      console.warn(
        "âš  åŒæœŸå¾…ã¡ã® 3é€£ç¶šæ­£è§£ãŒã‚ã‚Šã¾ã™ã€‚",
        "SYNC å´ =", syncedTotal, "/ local å´ =", localTotal,
        "ï¼ˆæ¬¡å›ã® Bãƒ‘ãƒ¼ãƒˆé·ç§»æ™‚ã«è¿½åŠ é€ä¿¡ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ï¼‰"
      );
    } else {
      console.error(
        "âœ• ç•°å¸¸: SYNC å´ã® 3é€£ç¶šæ­£è§£å›æ•°ã®æ–¹ãŒå¤§ãããªã£ã¦ã„ã¾ã™ (SYNC > local)ã€‚",
        "SYNC å´ =", syncedTotal, "/ local å´ =", localTotal,
        "ä¸€åº¦ãƒªã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰å†ãƒ†ã‚¹ãƒˆã—ãŸæ–¹ãŒè‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚"
      );
    }

    console.log("== Bãƒ‘ãƒ¼ãƒˆ: 3é€£ç¶šæ­£è§£ SYNC ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹çµ‚äº† ==");
  }

  schedule();
  showStreakStatus();
})();
</script>


  <!-- å·¦ä¸‹ã® [TOPã¸æˆ»ã‚‹] ãƒœã‚¿ãƒ³ -->
  <a class="back-to-top" href="../../index.html" title="å•é¡Œä¸€è¦§ã«æˆ»ã‚‹">ï¼»TOPã¸æˆ»ã‚‹ï¼½</a>


  <!-- Aå°‚ç”¨ï¼šå•é¡Œä¸€è¦§ï¼ˆ2ã‚«ãƒ©ãƒ ï¼‰ -->
  <link rel="stylesheet" href="../../assets/nav_list.css">
  <script src="../../assets/nav_list.js" data-a-nav="1"></script>

</div>
<script>
(function () {
  "use strict";

  var SYNC_STATE_ENDPOINT = "/api/sync/state";
  var SYNC_MERGE_ENDPOINT = "/api/sync/merge";

  function detectInfo() {
    var path = window.location.pathname || "";
    var m = path.match(/_build_cscs_(\d{8})\/slides\/q(\d{3})_b(?:\.html)?$/);
    if (!m) return null;
    var day = m[1];
    var num3 = m[2];
    var qid = day + "-" + num3;
    return { day: day, num3: num3, qid: qid };
  }

  var info = detectInfo();
  if (!info) {
    return;
  }

  function readIntFromLocalStorage(key) {
    try {
      var raw = window.localStorage.getItem(key);
      if (raw === null || raw === undefined) {
        return 0;
      }
      var n = parseInt(raw, 10);
      if (!Number.isFinite(n) || n < 0) {
        return 0;
      }
      return n;
    } catch (e) {
      console.error("[SYNC-B:view] failed to read int from localStorage:", key, e);
      return 0;
    }
  }

  // cscs_sync_view_b_body ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚»ãƒƒãƒˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
  // "server 0 / 0\nlocal 17 / 2\ndiff 0 / 0\nstatus: error ..."
  // ã¿ãŸã„ãªæ–‡å­—åˆ—ã‚’è¡Œã”ã¨ã« <div> ã«åˆ†å‰²ã—ã¦ç¸¦ã«ä¸¦ã¹ã‚‹
  function updateSyncBody(text) {
    var body = document.getElementById("cscs_sync_view_b_body");
    if (!body) {
      return;
    }

    // æ—¢å­˜ã®å­è¦ç´ ã‚’å…¨éƒ¨æ¶ˆã™
    while (body.firstChild) {
      body.removeChild(body.firstChild);
    }

    // text ã‚’è¡Œã”ã¨ã«åˆ†è§£ã—ã¦ <div> ã«å…¥ã‚Œã‚‹
    var lines = String(text).split(/\n/);
    for (var i = 0; i < lines.length; i++) {
      var line = lines[i];

      // ç©ºè¡Œã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå¿…è¦ãªã‚‰å‰Šé™¤ã—ã¦OKï¼‰
      if (!line.trim()) {
        continue;
      }

      var lineDiv = document.createElement("div");
      lineDiv.textContent = line;
      body.appendChild(lineDiv);
    }
  }

  function fetchState() {
    return fetch(SYNC_STATE_ENDPOINT, { method: "GET" }).then(function (res) {
      if (!res.ok) {
        throw new Error(String(res.status));
      }
      return res.json();
    });
  }

  function createPanel() {
    var box = document.createElement("div");
    box.id = "cscs_sync_view_b";

    var title = document.createElement("div");
    title.id = "cscs_sync_view_b_title";
    title.textContent = "SYNC(B): " + info.qid;

    var body = document.createElement("div");
    body.id = "cscs_sync_view_b_body";

    // åˆæœŸè¡¨ç¤ºã¯1è¡Œã ã‘ãªã®ã§ textContent ã§OK
    body.textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";

    // statusText ã‚’å€‹åˆ¥ã«è¡¨ç¤ºã™ã‚‹é ˜åŸŸ
    var statusDiv = document.createElement("div");
    statusDiv.id = "cscs_sync_view_b_status";

    var btn = document.createElement("button");
    btn.id = "cscs_sync_view_b_send_btn";
    btn.type = "button";
    btn.textContent = "SYNCé€ä¿¡";

    box.appendChild(title);
    box.appendChild(body);
    box.appendChild(statusDiv);
    box.appendChild(btn);
    return box;
  }


  function renderPanel(box, payload) {
    try {
      var serverCorrect = payload.serverCorrect || 0;
      var serverWrong = payload.serverWrong || 0;
      var localCorrect = payload.localCorrect || 0;
      var localWrong = payload.localWrong || 0;
      var diffCorrect = payload.diffCorrect || 0;
      var diffWrong = payload.diffWrong || 0;

      var serverStreak3 = payload.serverStreak3 || 0;
      var localStreak3 = payload.localStreak3 || 0;
      var diffStreak3 = payload.diffStreak3 || 0;

      var statusText = payload.statusText || "";

      var text = "";
      text += "server " + serverCorrect + " / " + serverWrong + "\n";
      text += "local  " + localCorrect + " / " + localWrong + "\n";
      text += "diff   " + diffCorrect + " / " + diffWrong + "\n";
      text += "s3     " + serverStreak3 + " / " + localStreak3 + " (+" + diffStreak3 + ")\n";
      text += "3é€£ç¶šæ­£è§£å›æ•°:\n";
      if (serverStreak3 === localStreak3) {
        text += "SYNC " + serverStreak3 + " å› / local " + localStreak3 + " å›";
      } else {
        text += "SYNC " + serverStreak3 + " å› / local " + localStreak3 + " å› (å·®åˆ† " + diffStreak3 + " å›)";
      }

      // server/local/diff/s3 ã¯ãƒœãƒ‡ã‚£å´ã«ç¸¦ä¸¦ã³è¡¨ç¤º
      updateSyncBody(text);

      // statusText ã¯å€‹åˆ¥ã® <div> ã«åˆ†é›¢ã—ã¦è¡¨ç¤º
      var statusDiv = document.getElementById("cscs_sync_view_b_status");
      if (statusDiv) {
        if (statusText) {
          statusDiv.textContent = "status: " + statusText;
        } else {
          statusDiv.textContent = "";
        }
      }
    } catch (e) {
      // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚åŒã˜ããƒ˜ãƒ«ãƒ‘ãƒ¼ã§è¡¨ç¤ºï¼‹status ã‚‚ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
      var errorText = "SYNC(B) " + info.qid + "  error: " + (e && e.message ? e.message : e);
      updateSyncBody(errorText);

      var statusDiv = document.getElementById("cscs_sync_view_b_status");
      if (statusDiv) {
        statusDiv.textContent = "status: error";
      }
    }
  }

  async function sendDiffToServer(box, params) {
    var qid = info.qid;
    var diffCorrect = params.diffCorrect;
    var diffWrong = params.diffWrong;
    var diffStreak3 = params.diffStreak3 || 0;

    var localCorrect = params.localCorrect;
    var localWrong = params.localWrong;
    var localStreak3 = params.localStreak3 || 0;

    var serverCorrect = params.serverCorrect;
    var serverWrong = params.serverWrong;
    var serverStreak3 = params.serverStreak3 || 0;

    // å·®åˆ†ãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„ï¼ˆè¡¨ç¤ºã ã‘æ›´æ–°ï¼‰
    if (diffCorrect <= 0 && diffWrong <= 0 && diffStreak3 <= 0) {
      renderPanel(box, {
        serverCorrect: serverCorrect,
        serverWrong: serverWrong,
        localCorrect: localCorrect,
        localWrong: localWrong,
        diffCorrect: diffCorrect,
        diffWrong: diffWrong,
        serverStreak3: serverStreak3,
        localStreak3: localStreak3,
        diffStreak3: diffStreak3,
        statusText: "no diff"
      });
      return;
    }

    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãªã‚‰é€ä¿¡ã—ãªã„
    if (!navigator.onLine) {
      renderPanel(box, {
        serverCorrect: serverCorrect,
        serverWrong: serverWrong,
        localCorrect: localCorrect,
        localWrong: localWrong,
        diffCorrect: diffCorrect,
        diffWrong: diffWrong,
        serverStreak3: serverStreak3,
        localStreak3: localStreak3,
        diffStreak3: diffStreak3,
        statusText: "offline"
      });
      return;
    }

    // Aãƒ‘ãƒ¼ãƒˆã¨åŒã˜ Delta å½¢å¼ã§ /api/sync/merge ã«é€ã‚‹
    var correctDeltaObj = {};
    var incorrectDeltaObj = {};
    var streak3DeltaObj = {};
    if (diffCorrect > 0) {
      correctDeltaObj[qid] = diffCorrect;
    }
    if (diffWrong > 0) {
      incorrectDeltaObj[qid] = diffWrong;
    }
    if (diffStreak3 > 0) {
      streak3DeltaObj[qid] = diffStreak3;
    }

    var payload = {
      correctDelta: correctDeltaObj,
      incorrectDelta: incorrectDeltaObj,
      streak3Delta: streak3DeltaObj,
      updatedAt: Date.now()
    };

    console.log("[SYNC-B] sending diff payload:", payload);

    try {
      var response = await fetch(SYNC_MERGE_ENDPOINT, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload),
        keepalive: true
      });

      if (!response.ok) {
        console.error("[SYNC-B] server returned non-ok status:", response.status);
        renderPanel(box, {
          serverCorrect: serverCorrect,
          serverWrong: serverWrong,
          localCorrect: localCorrect,
          localWrong: localWrong,
          diffCorrect: diffCorrect,
          diffWrong: diffWrong,
          serverStreak3: serverStreak3,
          localStreak3: localStreak3,
          diffStreak3: diffStreak3,
          statusText: "merge " + String(response.status)
        });
        return;
      }

      var data = null;
      try {
        data = await response.json();
      } catch (e) {
        data = null;
      }

      console.log("[SYNC-B] sync success:", data);

      // merge ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ { correct: {qid: total, ...}, incorrect: {...}, streak3: {...} } å½¢å¼ã‚’æƒ³å®š
      var newServerCorrect = serverCorrect;
      var newServerWrong = serverWrong;
      var newServerStreak3 = serverStreak3;

      if (data && data.correct && typeof data.correct === "object" && data.correct !== null) {
        if (Object.prototype.hasOwnProperty.call(data.correct, qid)) {
          var cVal = data.correct[qid];
          if (typeof cVal === "number" && Number.isFinite(cVal) && cVal >= 0) {
            newServerCorrect = cVal;
          }
        }
      }

      if (data && data.incorrect && typeof data.incorrect === "object" && data.incorrect !== null) {
        if (Object.prototype.hasOwnProperty.call(data.incorrect, qid)) {
          var wVal = data.incorrect[qid];
          if (typeof wVal === "number" && Number.isFinite(wVal) && wVal >= 0) {
            newServerWrong = wVal;
          }
        }
      }

      if (data && data.streak3 && typeof data.streak3 === "object" && data.streak3 !== null) {
        if (Object.prototype.hasOwnProperty.call(data.streak3, qid)) {
          var sVal = data.streak3[qid];
          if (typeof sVal === "number" && Number.isFinite(sVal) && sVal >= 0) {
            newServerStreak3 = sVal;
          }
        }
      }

      var newDiffCorrect = Math.max(0, localCorrect - newServerCorrect);
      var newDiffWrong = Math.max(0, localWrong - newServerWrong);
      var newDiffStreak3 = Math.max(0, localStreak3 - newServerStreak3);

      renderPanel(box, {
        serverCorrect: newServerCorrect,
        serverWrong: newServerWrong,
        localCorrect: localCorrect,
        localWrong: localWrong,
        diffCorrect: newDiffCorrect,
        diffWrong: newDiffWrong,
        serverStreak3: newServerStreak3,
        localStreak3: localStreak3,
        diffStreak3: newDiffStreak3,
        statusText: "ok"
      });
    } catch (e) {
      console.error("[SYNC-B] fetch failed:", e);
      renderPanel(box, {
        serverCorrect: serverCorrect,
        serverWrong: serverWrong,
        localCorrect: localCorrect,
        localWrong: localWrong,
        diffCorrect: diffCorrect,
        diffWrong: diffWrong,
        serverStreak3: serverStreak3,
        localStreak3: localStreak3,
        diffStreak3: diffStreak3,
        statusText: "error"
      });
    }
  }

  function refreshAndSend(box) {
    fetchState()
      .then(function (state) {
        var serverCorrect = 0;
        var serverWrong = 0;
        var serverStreak3 = 0;

        if (state && state.correct && state.correct[info.qid] != null) {
          serverCorrect = state.correct[info.qid];
        }
        if (state && state.incorrect && state.incorrect[info.qid] != null) {
          serverWrong = state.incorrect[info.qid];
        }
        if (state && state.streak3 && state.streak3[info.qid] != null) {
          serverStreak3 = state.streak3[info.qid];
        }

        var localCorrect = readIntFromLocalStorage("cscs_q_correct_total:" + info.qid);
        var localWrong = readIntFromLocalStorage("cscs_q_wrong_total:" + info.qid);
        var localStreak3 = readIntFromLocalStorage("cscs_q_correct_streak3_total:" + info.qid);

        // diff ã¯ã€Œã¾ã ã‚µãƒ¼ãƒãƒ¼ã«åæ˜ ã•ã‚Œã¦ã„ãªã„å¢—åˆ†ã€ã¨ã—ã¦æ‰±ã†ã®ã§ 0 æœªæº€ã«ã¯ã—ãªã„
        var diffCorrect = Math.max(0, localCorrect - serverCorrect);
        var diffWrong = Math.max(0, localWrong - serverWrong);
        var diffStreak3 = Math.max(0, localStreak3 - serverStreak3);

        renderPanel(box, {
          serverCorrect: serverCorrect,
          serverWrong: serverWrong,
          localCorrect: localCorrect,
          localWrong: localWrong,
          diffCorrect: diffCorrect,
          diffWrong: diffWrong,
          serverStreak3: serverStreak3,
          localStreak3: localStreak3,
          diffStreak3: diffStreak3,
          statusText: "state ok"
        });

        return sendDiffToServer(box, {
          serverCorrect: serverCorrect,
          serverWrong: serverWrong,
          serverStreak3: serverStreak3,
          localCorrect: localCorrect,
          localWrong: localWrong,
          localStreak3: localStreak3,
          diffCorrect: diffCorrect,
          diffWrong: diffWrong,
          diffStreak3: diffStreak3
        });
      })
      .catch(function (e) {
        console.error("[SYNC-B] state fetch error:", e);
        var localCorrect = readIntFromLocalStorage("cscs_q_correct_total:" + info.qid);
        var localWrong = readIntFromLocalStorage("cscs_q_wrong_total:" + info.qid);
        var localStreak3 = readIntFromLocalStorage("cscs_q_correct_streak3_total:" + info.qid);

        renderPanel(box, {
          serverCorrect: 0,
          serverWrong: 0,
          localCorrect: localCorrect,
          localWrong: localWrong,
          diffCorrect: 0,
          diffWrong: 0,
          serverStreak3: 0,
          localStreak3: localStreak3,
          diffStreak3: 0,
          statusText: "state error"
        });
      });
  }

  function init() {
    var box = createPanel();

    function append() {
      var wrap = document.querySelector("div.wrap");
      if (wrap) {
        if (!wrap.contains(box)) {
          wrap.appendChild(box);
        }
      } else {
        if (!document.body.contains(box)) {
          document.body.appendChild(box);
        }
      }
      var btn = document.getElementById("cscs_sync_view_b_send_btn");
      if (btn) {
        btn.addEventListener("click", function (ev) {
          ev.preventDefault();
          ev.stopPropagation();
          refreshAndSend(box);
        });
      }
      refreshAndSend(box);
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", append);
    } else {
      append();
    }
  }

  window.addEventListener("online", function () {
    // æ—¢å­˜ãƒ‘ãƒãƒ«ãŒã‚ã‚‹ã¨ãã ã‘ã€ãã®ãƒ‘ãƒãƒ«ã§å†èª­ã¿è¾¼ã¿ï¼‹å†é€ä¿¡ã‚’è©¦ã¿ã‚‹
    var box = document.getElementById("cscs_sync_view_b");
    if (!box) return;
    refreshAndSend(box);
  });

  init();
})();
</script>


<script>
(function(){
  function moveIntoWrap(id){
    try{
      var el = document.getElementById(id);
      if (!el) return;
      var wrap = document.querySelector("div.wrap");
      if (!wrap) return;
      if (el.parentNode === wrap) return;
      wrap.appendChild(el);
    }catch(_){}
  }
  function relocateAll(){
    moveIntoWrap("cscs_sync_monitor_a");
    moveIntoWrap("cscs_sync_view_b");
    moveIntoWrap("cc-check-wrapper");
  }
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", relocateAll);
  } else {
    relocateAll();
  }
})();
</script>

</body>
</html>