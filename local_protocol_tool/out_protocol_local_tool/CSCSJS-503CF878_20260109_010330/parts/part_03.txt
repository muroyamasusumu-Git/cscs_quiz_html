<<<PART_BEGIN>>>
ã€åˆ†å‰²ã‚³ãƒ¼ãƒ‰(3)ã®é–‹å§‹ã€‘
PartID: CSCSJS-503CF878-P03-of-07
SourceFile: cscs_sync_view_b.js
PartSHA256: a6bb3c250d6543fcc6f3334f2474e274b21e97a5eb0ba5aded7ed368aa915c7d
Range: chars 35565..72578 (len=37013)
FirstLine:   function updateSyncBodyGrid(model) {
LastLine: 
EndNewline: YES
PART_SCOPE_HINT: LineRange=L1112..L2239 | BraceDepth=1->1
PART_SCOPE_HINT_TOP_IDENTIFIERS: model:89, card:80, svb:77, appendChild:66, className:65, String:60, document:59, createElement:59, grid:54, div:52, head:42, local:30
PART_SCOPE_HINT_DEFINES: updateSyncBodyGrid, addPart, makeCard, makeTodayCard, ensureCard, placeAfter, applyCollapsedClass, clearEl, buildHeader, updateOnceBtnLabel, buildGridRowsFromModel, addRow, buildLocalOnceModel, asDayNum, max2, showLabel, updatePendingBtnLabel, fmtDayPair, fmtNumPair, fmtQidsPreview, pickLocalOnlyQids, readSyncKey, fetchState, createPanel, body, onceOdoaAnchorEl, card, line, head, part, k, v, quad, h, suf, grid, pair, pairSync, root, syncCard

```javascript
  function updateSyncBodyGrid(model) {
    var body = clearSyncBody();
    if (!body) return;

    if (!model || typeof model !== "object") {
      updateSyncBodyText("HUD model error");
      return;
    }

    // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
    //   Once/ODOA 2æšï¼ˆSYNC+localï¼‰ã‚’ã€Œæ¯å›åŒã˜ä½ç½®ã€ã«ç½®ããŸã‚ã®ã‚¢ãƒ³ã‚«ãƒ¼ï¼ˆç›´å‰ã®è¦ç´ ï¼‰ã‚’ä¿æŒã™ã‚‹ã€‚
    //   refreshOncePerDayAndOdoaWideCardsInBody() ã§ã“ã®ç›´å¾Œã« insert ã™ã‚‹ã€‚
    var onceOdoaAnchorEl = null;

    // --- Countsï¼ˆ1è¡Œè¡¨ç¤ºï¼šCounts + SYNC/local/diff ã‚’æ¨ªä¸€åˆ—ï¼‰ ---
    (function appendCountsSectionInline() {
      // â‘  ãƒ¯ã‚¤ãƒ‰ã‚«ãƒ¼ãƒ‰ï¼ˆCountsè¡Œã‚’åã‚ã‚‹ã‚³ãƒ³ãƒ†ãƒŠï¼‰
      var card = document.createElement("div");
      card.className = "cscs-svb-card is-wide svb-counts";

      // â‘¡ 1è¡Œã®æ¨ªä¸¦ã³ã‚³ãƒ³ãƒ†ãƒŠï¼ˆæŠ˜ã‚Šè¿”ã—ãªã—ï¼‰
      var line = document.createElement("div");
      line.className = "svb-counts-inline";

      // â‘¢ è¡Œã®å…ˆé ­ã« "Counts" ã‚’å…¥ã‚Œã‚‹ï¼ˆè¦‹å‡ºã—ã‚‚åŒã˜è¡Œã«ã¾ã¨ã‚ã‚‹ï¼‰
      var head = document.createElement("span");
      head.className = "svb-counts-head";
      head.textContent = "Totals (c/w)";
      line.appendChild(head);

      // â‘£ å„ãƒ‘ãƒ¼ãƒˆï¼ˆlabel + valueï¼‰ã‚’æ¨ªã«é€£çµã—ã¦ã„ã
      function addPart(label, valueText, isMuted) {
        var part = document.createElement("span");
        part.className = "svb-counts-part" + (isMuted ? " is-muted" : "");

        var k = document.createElement("span");
        k.className = "svb-counts-k";
        k.textContent = label;

        var v = document.createElement("span");
        v.className = "svb-counts-v";
        v.textContent = valueText;

        part.appendChild(k);
        part.appendChild(v);
        line.appendChild(part);
      }

      addPart(
        "SYNC",
        String(model.serverCorrect) + " / " + String(model.serverWrong),
        false
      );
      addPart(
        "local",
        String(model.localCorrect) + " / " + String(model.localWrong),
        false
      );
      addPart(
        "diff",
        String(model.diffCorrect) + " / " + String(model.diffWrong),
        true
      );

      // â‘¤ ã‚«ãƒ¼ãƒ‰ã«1è¡Œã‚’å…¥ã‚Œã¦ body ã«è¿½åŠ 
      card.appendChild(line);
      body.appendChild(card);
    })();

    // --- 3é€£ç¶šï¼ˆæ­£è§£/ä¸æ­£è§£ï¼‰ï¼š2åˆ—Ã—2æ®µï¼ˆå·¦=æ­£è§£ / å³=ä¸æ­£è§£ã€ä¸Š=å›æ•° / ä¸‹=é€²æ—ï¼‰ ---
    (function appendStreakQuad4WideCards() {
      var quad = document.createElement("div");
      quad.className = "svb-streak-quad";

      function makeCard(titleText, rowKey, valueText) {
        var card = document.createElement("div");
        card.className = "cscs-svb-card svb-streak-card";

        var h = document.createElement("div");
        h.className = "cscs-svb-card-title";
        h.textContent = titleText;

        var suf = document.createElement("span");
        suf.className = "svb-title-suffix";
        suf.textContent = "Syc/Lcl/Df";
        h.appendChild(suf);

        var grid = document.createElement("div");
        grid.className = "cscs-svb-card-grid";

        appendGridRow(grid, rowKey, valueText);

        card.appendChild(h);
        card.appendChild(grid);
        return card;
      }

      // å·¦ä¸Šï¼š3é€£ç¶šæ­£è§£ï¼ˆå›æ•°ï¼‰
      quad.appendChild(
        makeCard(
          "â­ï¸3é€£ç¶šæ­£è§£æ•°",
          "å›æ•°(s3)",
          String(model.serverStreak3) + " / " + String(model.localStreak3) + " (+" + String(model.diffStreak3) + ")"
        )
      );

      // å³ä¸Šï¼š3é€£ç¶šä¸æ­£è§£ï¼ˆå›æ•°ï¼‰
      quad.appendChild(
        makeCard(
          "ğŸ’£3é€£ç¶šä¸æ­£è§£",
          "å›æ•°(s3W)",
          String(model.serverStreak3Wrong) + " / " + String(model.localStreak3Wrong) + " (+" + String(model.diffStreak3Wrong) + ")"
        )
      );

      // å·¦ä¸‹ï¼š3é€£ç¶šæ­£è§£ï¼ˆé€²æ—ï¼‰
      quad.appendChild(
        makeCard(
          "3é€£ç¶šæ­£è§£é€²æ—",
          "é€²æ—(progress)",
          String(model.serverProgress) + "/3 / " + String(model.localProgress) + "/3 (+" + String(model.diffProgress) + ")"
        )
      );

      // å³ä¸‹ï¼š3é€£ç¶šä¸æ­£è§£ï¼ˆé€²æ—ï¼‰
      quad.appendChild(
        makeCard(
          "3é€£ç¶šä¸æ­£è§£é€²æ—",
          "é€²æ—(progress)",
          String(model.serverWrongProgress) + "/3 / " + String(model.localWrongProgress) + "/3 (+" + String(model.diffWrongProgress) + ")"
        )
      );

      body.appendChild(quad);
    })();

    // --- Today Uniqueï¼ˆå·¦å³2åˆ—ï¼šå·¦=Streak3TodayUnique / å³=Streak3WrongTodayUqï¼‰ ---
    (function appendTodayUniquePair() {
      var pair = document.createElement("div");
      pair.className = "svb-streak-quad";

      function makeTodayCard(titleText, syncCnt, localCnt) {
        var card = document.createElement("div");
        card.className = "cscs-svb-card svb-streak-card";

        var h = document.createElement("div");
        h.className = "cscs-svb-card-title";
        h.textContent = titleText;

        var grid = document.createElement("div");
        grid.className = "cscs-svb-card-grid";

        appendGridRow(
          grid,
          "unique",
          "sync " + String(syncCnt) + " / local " + String(localCnt)
        );

        card.appendChild(h);
        card.appendChild(grid);
        return card;
      }

      // å·¦ï¼šStreak3TodayUnique
      pair.appendChild(
        makeTodayCard(
          "Streak3TodayUnique",
          model.s3TodaySyncCnt,
          model.localS3TodayCnt
        )
      );

      // å³ï¼šStreak3WrongTodayUq
      pair.appendChild(
        makeTodayCard(
          "Streak3WrongTodayUq",
          model.s3WrongTodaySyncCnt,
          model.localS3WrongTodayCnt
        )
      );

      body.appendChild(pair);
    })();

    // --- Correct/Wrong Streak (local / b_judge_record.js) : 2åˆ—æ¨ªä¸¦ã³ ---
    (function appendStreakMaxPairCards() {
      // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
      //   é€£ç¶šæ­£è§£ãƒ–ãƒ­ãƒƒã‚¯ã¨ã€é€£ç¶šä¸æ­£è§£ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã€Œå·¦å³2åˆ—ã€ã§æ¨ªä¸¦ã³ã«ã™ã‚‹ã€‚
      //   - æ—¢å­˜ã® .svb-streak-quad ã‚’å†åˆ©ç”¨ï¼ˆ2åˆ—ã‚°ãƒªãƒƒãƒ‰ï¼‰
      //   - ä¸¡ã‚«ãƒ¼ãƒ‰ã¨ã‚‚ã€åŒã˜UIï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‹æŠ˜ã‚ŠãŸãŸã¿ï¼‹3è¡Œï¼‰ã§çµ±ä¸€ã™ã‚‹
      var pair = document.createElement("div");
      pair.className = "svb-streak-quad";

      // ==========================
      // å·¦ï¼šé€£ç¶šæ­£è§£ (local)
      // ==========================
      (function buildCorrectCard() {
        // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
        //   ã€Œé€£ç¶šæ­£è§£ã€ã‚«ãƒ¼ãƒ‰ã¯æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½ã‚’æŒãŸãšã€å¸¸ã«å†…å®¹ã‚’è¡¨ç¤ºã™ã‚‹ã€‚
        //   localStorage ã® collapsed çŠ¶æ…‹ã¯å‚ç…§/æ›´æ–°ã—ãªã„ã€‚
        var card = document.createElement("div");
        card.className = "cscs-svb-card svb-correct-streak-card";

        // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã®ã¿ï¼‰
        var head = document.createElement("div");
        head.className = "svb-correct-streak-head";

        var h = document.createElement("div");
        h.className = "cscs-svb-card-title";
        h.textContent = "é€£ç¶šæ­£è§£ (local)";

        head.appendChild(h);

        var grid = document.createElement("div");
        grid.className = "cscs-svb-card-grid";

        appendGridRow(grid, "streak_len", String(model.localStreakLen));
        appendGridRow(grid, "streak_max", String(model.localCorrectStreakMax));
        appendGridRow(grid, "max_day", String(model.localCorrectStreakMaxDayLabel));

        card.appendChild(head);
        card.appendChild(grid);
        pair.appendChild(card);

        console.log("[SYNC-B:view] appended Correct Streak card (pair)", {
          qid: (info && info.qid) ? info.qid : "-",
          streak_len: model.localStreakLen,
          streak_max: model.localCorrectStreakMax,
          max_day: model.localCorrectStreakMaxDayLabel
        });
      })();

      // ==========================
      // å³ï¼šé€£ç¶šä¸æ­£è§£ (local)
      // ==========================
      (function buildWrongCard() {
        // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
        //   ã€Œé€£ç¶šä¸æ­£è§£ã€ã‚«ãƒ¼ãƒ‰ã¯æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½ã‚’æŒãŸãšã€å¸¸ã«å†…å®¹ã‚’è¡¨ç¤ºã™ã‚‹ã€‚
        //   localStorage ã® collapsed çŠ¶æ…‹ã¯å‚ç…§/æ›´æ–°ã—ãªã„ã€‚
        var card = document.createElement("div");
        card.className = "cscs-svb-card svb-wrong-streak-card";

        // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã®ã¿ï¼‰
        var head = document.createElement("div");
        head.className = "svb-correct-streak-head";

        var h = document.createElement("div");
        h.className = "cscs-svb-card-title";
        h.textContent = "é€£ç¶šä¸æ­£è§£ (local)";

        head.appendChild(h);

        var grid = document.createElement("div");
        grid.className = "cscs-svb-card-grid";

        appendGridRow(grid, "streak_len", String(model.localWrongStreakLen));
        appendGridRow(grid, "streak_max", String(model.localWrongStreakMax));
        appendGridRow(grid, "max_day", String(model.localWrongStreakMaxDayLabel));

        card.appendChild(head);
        card.appendChild(grid);
        pair.appendChild(card);

        console.log("[SYNC-B:view] appended Wrong Streak card (pair)", {
          qid: (info && info.qid) ? info.qid : "-",
          streak_len: model.localWrongStreakLen,
          streak_max: model.localWrongStreakMax,
          max_day: model.localWrongStreakMaxDayLabel
        });
      })();

      body.appendChild(pair);

      // ==========================
      // è¿½åŠ ï¼šé€£ç¶šæ­£è§£/ä¸æ­£è§£ (SYNC) ã‚’ local ã®ç›´ä¸‹ã« 2åˆ—ã§è¡¨ç¤º
      // ==========================
      (function appendStreakLenSyncPairCards() {
        var pairSync = document.createElement("div");
        pairSync.className = "svb-streak-quad";

        // å·¦ï¼šé€£ç¶šæ­£è§£ (SYNC)
        (function buildCorrectSyncCard() {
          var card = document.createElement("div");
          card.className = "cscs-svb-card svb-correct-streak-card";

          var head = document.createElement("div");
          head.className = "svb-correct-streak-head";

          var h = document.createElement("div");
          h.className = "cscs-svb-card-title";
          h.textContent = "é€£ç¶šæ­£è§£ (SYNC)";

          head.appendChild(h);

          var grid = document.createElement("div");
          grid.className = "cscs-svb-card-grid";

          appendGridRow(grid, "streak_len", String(model.serverStreakLen));
          appendGridRow(grid, "streak_max", String(model.serverCorrectStreakMax));
          appendGridRow(grid, "max_day", String(model.serverCorrectStreakMaxDayLabel));

          card.appendChild(head);
          card.appendChild(grid);
          pairSync.appendChild(card);
        })();

        // å³ï¼šé€£ç¶šä¸æ­£è§£ (SYNC)
        (function buildWrongSyncCard() {
          var card = document.createElement("div");
          card.className = "cscs-svb-card svb-wrong-streak-card";

          var head = document.createElement("div");
          head.className = "svb-correct-streak-head";

          var h = document.createElement("div");
          h.className = "cscs-svb-card-title";
          h.textContent = "é€£ç¶šä¸æ­£è§£ (SYNC)";

          head.appendChild(h);

          var grid = document.createElement("div");
          grid.className = "cscs-svb-card-grid";

          appendGridRow(grid, "streak_len", String(model.serverWrongStreakLen));
          appendGridRow(grid, "streak_max", String(model.serverWrongStreakMax));
          appendGridRow(grid, "max_day", String(model.serverWrongStreakMaxDayLabel));

          card.appendChild(head);
          card.appendChild(grid);
          pairSync.appendChild(card);
        })();

        body.appendChild(pairSync);

        // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
        //   Once/ODOA 2æšã¯ã€ŒSYNCãƒšã‚¢ã®ç›´ä¸‹ã€ã«å›ºå®šã™ã‚‹ãŸã‚ã€ã“ã®è¦ç´ ã‚’ã‚¢ãƒ³ã‚«ãƒ¼ã¨ã—ã¦ä¿æŒã™ã‚‹ã€‚
        onceOdoaAnchorEl = pairSync;

        console.log("[SYNC-B:view] appended Streak Len pair (SYNC correct/wrong)", {
          qid: (info && info.qid) ? info.qid : "-",
          serverStreakLen: model.serverStreakLen,
          serverWrongStreakLen: model.serverWrongStreakLen
        });
      })();

      // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
      //   2åˆ—ãƒšã‚¢å…¨ä½“ã®è¿½åŠ ãŒå®Œäº†ã—ãŸã“ã¨ã‚’ãƒ­ã‚°ã§ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
      console.log("[SYNC-B:view] appended Streak Max pair (correct/wrong)", {
        qid: (info && info.qid) ? info.qid : "-"
      });
    })();

    // --- OncePerDayToday / O.D.O.A Modeï¼ˆãƒ¯ã‚¤ãƒ‰ã‚«ãƒ¼ãƒ‰ï¼šbodyé…ä¸‹ã®æ—¢å­˜ã‚«ãƒ¼ãƒ‰ã®ã¿æ›´æ–°ï¼ç”Ÿæˆã¯æœ€åˆã®1å›ã ã‘ï¼‰ ---
    (function refreshOncePerDayAndOdoaWideCardsInBody() {
      // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
      //   once/odoa ã¯ body(#cscs_sync_view_b_body) é…ä¸‹ã«ã€ŒSYNCã‚«ãƒ¼ãƒ‰1æš + localã‚«ãƒ¼ãƒ‰1æšã€ã‚’ç½®ãã€
      //   updateSyncBodyGrid() ã§ã¯ â€œè¿½åŠ â€ ã›ãš â€œæ—¢å­˜DOMã‚’æ›´æ–°â€ ã ã‘è¡Œã†ï¼ˆå”¯ä¸€ã®çœŸï¼bodyï¼‰ã€‚
      var root = body;

      // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
      //   æ—¢å­˜ã‚«ãƒ¼ãƒ‰ã‚’ body é…ä¸‹ã ã‘ã§æ¢ç´¢ã™ã‚‹ï¼ˆæ¢ç´¢ç¯„å›²å›ºå®šï¼‰ã€‚
      var syncCard = null;
      var localCard = null;
      try {
        syncCard = root.querySelector(".svb-once-odoa-card:not(.svb-once-odoa-card-local)");
        localCard = root.querySelector(".svb-once-odoa-card-local");
      } catch (_eFindOnceCards) {
        syncCard = null;
        localCard = null;
      }

      // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
      //   ç”Ÿæˆã¯ â€œæœ€åˆã®1å›ã ã‘â€ã€‚
      //   - init()->append() ã®ç¢ºå®šåœ°ç‚¹ã§ä½œã‚‹ã®ãŒç†æƒ³ã ãŒã€
      //     updateSyncBodyGrid() ã¯ body ãŒç¢ºå®Ÿã«å­˜åœ¨ã™ã‚‹ã®ã§ã€ã“ã“ã§ã€Œæœªç”Ÿæˆãªã‚‰ä½œã‚‹ã€ã«ä¸€æœ¬åŒ–ã™ã‚‹ã€‚
      function ensureCard(cardKind) {
        var c = document.createElement("div");
        if (cardKind === "local") {
          c.className = "cscs-svb-card is-wide svb-once-odoa-card svb-once-odoa-card-local";
        } else {
          c.className = "cscs-svb-card is-wide svb-once-odoa-card";
        }
        return c;
      }

      // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
      //   ã‚«ãƒ¼ãƒ‰ã‚’ã€Œã‚¢ãƒ³ã‚«ãƒ¼ç›´å¾Œã€ã«å¿…ãšé…ç½®ã™ã‚‹ï¼ˆåˆå›ç”Ÿæˆã§ã‚‚ã€å†æç”»ã§æ®‹ã£ã¦ã„ã¦ã‚‚ä½ç½®ã‚’æƒãˆã‚‹ï¼‰ã€‚
      // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
      //   ã€Œã‚¢ãƒ³ã‚«ãƒ¼ç›´å¾Œã€ã§ã¯ãªãã€Œç›´å‰ã«ç½®ã„ãŸè¦ç´ ã®ç›´å¾Œã€ã«é †ç•ªã«å·®ã—è¾¼ã‚€ã“ã¨ã§ã€
      //   2å›ç›®ã® insert ãŒ1å›ç›®ã‚’â€œè¿½ã„è¶Šã—ã¦ä¸Šã«æ¥ã‚‹â€å•é¡Œã‚’é˜²ãï¼ˆSYNCâ†’local ã®é †ã‚’ä¿è¨¼ï¼‰ã€‚
      function placeAfter(refEl, cardEl) {
        if (!cardEl) return refEl;

        if (refEl && refEl.parentNode === root) {
          if (refEl.nextSibling !== cardEl) {
            root.insertBefore(cardEl, refEl.nextSibling);
          }
          return cardEl;
        }

        root.appendChild(cardEl);
        return cardEl;
      }

      if (!syncCard) {
        syncCard = ensureCard("sync");
      }
      if (!localCard) {
        localCard = ensureCard("local");
      }

      // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
      //   onceOdoaAnchorEl ã®ç›´å¾Œã«ã€SYNCâ†’local ã®é †ã§å¿…ãšä¸¦ã¹ã‚‹
      var ref = (onceOdoaAnchorEl && onceOdoaAnchorEl.parentNode === root) ? onceOdoaAnchorEl : null;
      if (ref) {
        ref = placeAfter(ref, syncCard);
        ref = placeAfter(ref, localCard);
      } else {
        root.appendChild(syncCard);
        root.appendChild(localCard);
      }

      // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
      //   æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã¯ once/odoa ã‚’ã€ŒSYNCç”¨ã€ã€Œlocalç”¨ã€ã§åˆ†é›¢ã—ã€å€‹åˆ¥ã«æŠ˜ã‚ŠãŸãŸã¿ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
      var onceCollapsedSync = false;
      var onceCollapsedLocal = false;

      try {
        onceCollapsedSync = (localStorage.getItem("cscs_sync_view_b_once_odoa_collapsed_sync") === "1");
      } catch (_eOnceCollapsedSync) {
        onceCollapsedSync = false;
      }

      try {
        onceCollapsedLocal = (localStorage.getItem("cscs_sync_view_b_once_odoa_collapsed_local") === "1");
      } catch (_eOnceCollapsedLocal) {
        onceCollapsedLocal = false;
      }

      function applyCollapsedClass(cardEl, isCollapsed) {
        if (!cardEl) return;
        if (isCollapsed) {
          if (cardEl.className.indexOf("is-collapsed") === -1) {
            cardEl.className += " is-collapsed";
          }
        } else {
          cardEl.className = cardEl.className.replace(/\bis-collapsed\b/g, "").replace(/\s{2,}/g, " ").trim();
        }
      }

      applyCollapsedClass(syncCard, onceCollapsedSync);
      applyCollapsedClass(localCard, onceCollapsedLocal);

      function clearEl(el) {
        while (el && el.firstChild) el.removeChild(el.firstChild);
      }

      function buildHeader(cardEl, titleText, allowToggle, storageKey, getCollapsed, setCollapsed) {
        var head = document.createElement("div");
        head.className = "svb-once-odoa-head";

        var h = document.createElement("div");
        h.className = "cscs-svb-card-title";
        h.textContent = titleText;

        head.appendChild(h);

        if (allowToggle) {
          var btn = document.createElement("button");
          btn.className = "svb-once-odoa-toggle";
          btn.type = "button";

          function updateOnceBtnLabel() {
            var collapsed = !!getCollapsed();
            var chev = collapsed ? "â–¶" : "â–¼";
            var label = collapsed ? "show" : "hide";
            btn.innerHTML = "<span class=\"svb-once-odoa-chev\">" + chev + "</span>" + label;
            btn.setAttribute("aria-expanded", collapsed ? "false" : "true");
          }

          updateOnceBtnLabel();

          btn.addEventListener("click", function () {
            var next = !getCollapsed();
            setCollapsed(next);

            try {
              localStorage.setItem(storageKey, next ? "1" : "0");
            } catch (_eSaveOnceSplit) {}

            applyCollapsedClass(cardEl, next);
            updateOnceBtnLabel();
          });

          head.appendChild(btn);
        }

        return head;
      }

      function buildGridRowsFromModel(cardEl, modelForCard) {
        var grid = document.createElement("div");
        grid.className = "svb-wide-dual-grid";

        function addRow(leftText, rightText, strongLeft, strongRight) {
          var l = document.createElement("div");
          l.className = "svb-wide-dual-cell" + (strongLeft ? " svb-wide-dual-strong" : "");
          l.textContent = leftText;

          var r = document.createElement("div");
          r.className = "svb-wide-dual-cell is-right" + (strongRight ? " svb-wide-dual-strong" : "");
          r.textContent = rightText;

          grid.appendChild(l);
          grid.appendChild(r);
        }

        addRow(
          "oncePerDayToday   " + String(modelForCard.onceStateLabel),
          "è¨ˆæ¸¬: " + String(modelForCard.onceMeasureOkLabel) + " ï½œçµæœ: " + String(modelForCard.onceResultLabel),
          true,
          false
        );

        addRow(
          "Today             " + String(modelForCard.onceTodayDateLabel),
          "qid: " + String(modelForCard.onceQidLabel),
          false,
          false
        );

        addRow(
          "countå¯¾è±¡         " + String(modelForCard.onceCountableLabel),
          "è¨˜éŒ²: " + String(modelForCard.onceRecordLabel),
          false,
          false
        );

        (function addOdoaSingleRow() {
          var line = document.createElement("div");
          line.className = "svb-wide-single";
          line.textContent = "ODOA              " + String(modelForCard.onceOdoaLabel);
          grid.appendChild(line);
        })();

        return grid;
      }

      // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
      //   localã‚«ãƒ¼ãƒ‰ã¯ localStorage ã® oncePerDayToday ã‚’ â€œè¡¨ç¤ºå°‚ç”¨â€ ã«èª­ã‚€ï¼ˆåˆ¤å®šå…ƒã«ã¯ã—ãªã„ï¼‰ã€‚
      //   - å‚ç…§å…ƒã¯ localStorage ã®ç¢ºå®šã‚­ãƒ¼ã®ã¿ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç„¡ã—ï¼‰ã€‚
      function buildLocalOnceModel() {
        var out = {
          onceStateLabel: "æœªé–‹å§‹",
          onceMeasureOkLabel: "-",
          onceResultLabel: "-",
          onceTodayDateLabel: "-",
          onceQidLabel: (info && info.qid) ? info.qid : "-",
          onceCountableLabel: "-",
          onceRecordLabel: "-",
          onceOdoaLabel: "-"
        };

        try {
          try {
            var now = new Date();
            var y = now.getFullYear();
            var m = String(now.getMonth() + 1).padStart(2, "0");
            var d = String(now.getDate()).padStart(2, "0");
            out.onceTodayDateLabel = String(y) + "-" + String(m) + "-" + String(d);
          } catch (_eDate2) {
            out.onceTodayDateLabel = "-";
          }

          var localOnce = readOncePerDayTodayFromLocal();
          var localOnceVal = null;
          if (localOnce &&
              typeof localOnce.day === "number" &&
              Number.isFinite(localOnce.day) &&
              localOnce.results &&
              typeof localOnce.results === "object") {
            if (Object.prototype.hasOwnProperty.call(localOnce.results, out.onceQidLabel)) {
              localOnceVal = localOnce.results[out.onceQidLabel];
            }
          }

          if (localOnceVal === "correct" || localOnceVal === "wrong") {
            out.onceStateLabel = "è¨ˆæ¸¬æ¸ˆ";
            out.onceResultLabel = String(localOnceVal);
            out.onceMeasureOkLabel = "OK";
            out.onceRecordLabel = String(localOnceVal);
            out.onceCountableLabel = "Noï¼ˆè¨ˆæ¸¬æ¸ˆï¼‰";
          } else {
            out.onceStateLabel = "æœªé–‹å§‹";
            out.onceResultLabel = "-";
            out.onceMeasureOkLabel = "NG";
            out.onceRecordLabel = "-";
            out.onceCountableLabel = "Yesï¼ˆæœªè¨ˆæ¸¬ï¼‰";
          }

          var verifyModeOn =
            typeof window.CSCS_VERIFY_MODE === "string" && window.CSCS_VERIFY_MODE === "on";

          var odoaRaw = null;
          try {
            if (typeof window.CSCS_ODOA_MODE === "string") {
              odoaRaw = window.CSCS_ODOA_MODE;
            }
          } catch (_eOdoaPick2) {
            odoaRaw = null;
          }

          var odoaLower = "";
          try {
            odoaLower = (odoaRaw == null ? "" : String(odoaRaw)).trim().toLowerCase();
          } catch (_eOdoaLower2) {
            odoaLower = "";
          }

          var odoaIsOn = (odoaLower === "on");

          if (verifyModeOn) {
            out.onceCountableLabel = "Noï¼ˆã‚¬ãƒ¼ãƒ‰ï¼‰";
          }
          if (odoaIsOn) {
            out.onceCountableLabel = "Noï¼ˆã‚¬ãƒ¼ãƒ‰ï¼‰";
          }

          // â˜… è¡¨ç¤ºãƒ«ãƒ¼ãƒ«:
          //   - countå¯¾è±¡ ãŒ No ã®ã¨ãã¯ã€Œè¨˜éŒ²: -ã€ï¼ˆè¨˜éŒ²ç„¡ã—æ‰±ã„ï¼‰
          //   - ODOA ãŒ ONï¼ˆç´¯è¨ˆåŠ ç®—: Noï¼‰ã®ã¨ãã¯æœ«å°¾ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚‚ "-" ã«ã™ã‚‹
          if (String(out.onceCountableLabel).indexOf("No") === 0) {
            out.onceRecordLabel = "-";
          }

          var odoaResultSuffix = "nocount";
          if (localOnceVal === "correct") {
            odoaResultSuffix = "Correct";
          } else if (localOnceVal === "wrong") {
            odoaResultSuffix = "Wrong";
          }

          if (odoaIsOn) {
            odoaResultSuffix = "-";
          }

          var addNo = false;
          if (verifyModeOn) addNo = true;
          if (odoaIsOn) addNo = true;

          if (odoaIsOn) {
            out.onceOdoaLabel = "ONï¼ˆç´¯è¨ˆåŠ ç®—: " + (addNo ? "No" : "Yes") + "ï¼‰  " + odoaResultSuffix;
          } else {
            out.onceOdoaLabel = "OFFï¼ˆç´¯è¨ˆåŠ ç®—: Yesï¼‰  " + odoaResultSuffix;
          }

        } catch (_eLocalOnceModel) {}

        return out;
      }

      // ===== SYNCã‚«ãƒ¼ãƒ‰ï¼ˆmodelã®å€¤ã‚’ãã®ã¾ã¾ï¼‰ =====
      clearEl(syncCard);
      syncCard.appendChild(buildHeader(
        syncCard,
        "OncePerDayToday / O.D.O.A Mode (SYNC)",
        true,
        "cscs_sync_view_b_once_odoa_collapsed_sync",
        function () { return onceCollapsedSync; },
        function (v) { onceCollapsedSync = !!v; }
      ));
      syncCard.appendChild(buildGridRowsFromModel(syncCard, {
        onceStateLabel: model.onceStateLabel,
        onceMeasureOkLabel: model.onceMeasureOkLabel,
        onceResultLabel: model.onceResultLabel,
        onceTodayDateLabel: model.onceTodayDateLabel,
        onceQidLabel: model.onceQidLabel,
        onceCountableLabel: model.onceCountableLabel,
        onceRecordLabel: model.onceRecordLabel,
        onceOdoaLabel: model.onceOdoaLabel
      }));

      // ===== localã‚«ãƒ¼ãƒ‰ï¼ˆlocalStorageã®å€¤ã ã‘ã§çµ„ã‚€ï¼‰ =====
      var localOnceModel = buildLocalOnceModel();
      clearEl(localCard);
      localCard.appendChild(buildHeader(
        localCard,
        "OncePerDayToday / O.D.O.A Mode (local)",
        true,
        "cscs_sync_view_b_once_odoa_collapsed_local",
        function () { return onceCollapsedLocal; },
        function (v) { onceCollapsedLocal = !!v; }
      ));
      localCard.appendChild(buildGridRowsFromModel(localCard, localOnceModel));

      console.log("[SYNC-B:view] refreshed once/odoa cards in body (sync+local)", {
        qid: (info && info.qid) ? info.qid : "-"
      });
    })();

    // --- LastDayï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼=æœ€æ–°ãƒ¬ã‚³ãƒ¼ãƒ‰ / 3åˆ—=é …ç›®ãƒ»SYNCãƒ»localï¼‰ ---
    (function appendLastDayCard() {
      function asDayNum(s) {
        if (s == null) return null;
        var t = String(s);
        if (!/^\d{8}$/.test(t)) return null;
        var n = parseInt(t, 10);
        if (!Number.isFinite(n) || n <= 0) return null;
        return n;
      }

      function max2(a, b) {
        if (a == null && b == null) return null;
        if (a == null) return b;
        if (b == null) return a;
        return a > b ? a : b;
      }

      var seenS = asDayNum(model.lastSeenSyncLabel);
      var seenL = asDayNum(model.lastSeenLocalLabel);
      var corS  = asDayNum(model.lastCorrectSyncLabel);
      var corL  = asDayNum(model.lastCorrectLocalLabel);
      var wroS  = asDayNum(model.lastWrongSyncLabel);
      var wroL  = asDayNum(model.lastWrongLocalLabel);

      var seenMax = max2(seenS, seenL);
      var corMax  = max2(corS, corL);
      var wroMax  = max2(wroS, wroL);

      var headKey = "LastDay";
      var best = null;

      if (seenMax != null) {
        headKey = "lastSeen";
        best = seenMax;
      }
      if (corMax != null && (best == null || corMax > best)) {
        headKey = "lastCorrect";
        best = corMax;
      }
      if (wroMax != null && (best == null || wroMax > best)) {
        headKey = "lastWrong";
        best = wroMax;
      }

      function showLabel(n, fallback) {
        if (n == null) return fallback;
        return String(n);
      }

      var headSync = "-";
      var headLocal = "-";

      if (headKey === "lastSeen") {
        headSync = showLabel(seenS, "-");
        headLocal = showLabel(seenL, "-");
      } else if (headKey === "lastCorrect") {
        headSync = showLabel(corS, "-");
        headLocal = showLabel(corL, "-");
      } else if (headKey === "lastWrong") {
        headSync = showLabel(wroS, "-");
        headLocal = showLabel(wroL, "-");
      }

      var card = document.createElement("div");
      card.className = "cscs-svb-card is-wide";

      // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæœ€æ–°ãƒ¬ã‚³ãƒ¼ãƒ‰è¡Œï¼šæ¨ª3åˆ—ï¼‰
      var head = document.createElement("div");
      head.className = "svb-lastday-head";

      var hk = document.createElement("div");
      hk.className = "svb-lastday-k";
      hk.textContent = headKey;

      var hs = document.createElement("div");
      // ä½•ã‚’ã—ã¦ã„ã‚‹ã‹: LastDayã®çœŸã‚“ä¸­åˆ—ï¼ˆSYNCåˆ—ï¼‰ã ã¨æ˜ç¤ºã™ã‚‹classã‚’ä»˜ä¸ã™ã‚‹ï¼ˆCSSã§ä¸­å¤®å¯„ã›å›ºå®šï¼‰
      hs.className = "svb-lastday-v svb-lastday-mid";
      hs.textContent = "SYNC " + String(headSync);

      var hl = document.createElement("div");
      // ä½•ã‚’ã—ã¦ã„ã‚‹ã‹: å³åˆ—ï¼ˆlocalåˆ—ï¼‰ã¨ã—ã¦é€šå¸¸ã®å³å¯„ã›ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¶­æŒã™ã‚‹
      hl.className = "svb-lastday-v";
      hl.textContent = "local " + String(headLocal);

      head.appendChild(hk);
      head.appendChild(hs);
      head.appendChild(hl);
      card.appendChild(head);

      // æœ¬ä½“ï¼ˆè¦‹å‡ºã—ã¨åŒã˜é …ç›®ã¯è¡¨ç¤ºã—ãªã„ï¼‰
      var grid = document.createElement("div");
      grid.className = "svb-lastday-grid";

      function addRow(kText, syncText, localText) {
        if (kText === headKey) return;

        var k = document.createElement("div");
        k.className = "svb-lastday-k";
        k.textContent = kText;

        var s = document.createElement("div");
        // ä½•ã‚’ã—ã¦ã„ã‚‹ã‹: LastDayã®çœŸã‚“ä¸­åˆ—ï¼ˆSYNCåˆ—ï¼‰ã ã¨æ˜ç¤ºã™ã‚‹classã‚’ä»˜ä¸ã™ã‚‹ï¼ˆCSSã§ä¸­å¤®å¯„ã›å›ºå®šï¼‰
        s.className = "svb-lastday-v svb-lastday-mid";
        s.textContent = showLabel(asDayNum(syncText), "-");

        var l = document.createElement("div");
        // ä½•ã‚’ã—ã¦ã„ã‚‹ã‹: å³åˆ—ï¼ˆlocalåˆ—ï¼‰ã¯å¾“æ¥é€šã‚Šå³å¯„ã›ã®ã¾ã¾
        l.className = "svb-lastday-v";
        l.textContent = showLabel(asDayNum(localText), "-");

        grid.appendChild(k);
        grid.appendChild(s);
        grid.appendChild(l);
      }

      addRow("lastCorrect", model.lastCorrectSyncLabel, model.lastCorrectLocalLabel);
      addRow("lastSeen", model.lastSeenSyncLabel, model.lastSeenLocalLabel);
      addRow("lastWrong", model.lastWrongSyncLabel, model.lastWrongLocalLabel);

      if (grid.childNodes.length > 0) {
        card.appendChild(grid);
      }

      body.appendChild(card);

      // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
      //   LastDayã‚«ãƒ¼ãƒ‰ã‚‚ã€Œé€£ç¶šæ­£è§£/é€£ç¶šä¸æ­£è§£ãƒšã‚¢ã®ç›´ä¸‹ï¼ˆOncePerDayã®æ¬¡ï¼‰ã€ã«æ¥ãŸã“ã¨ã‚’ãƒ­ã‚°ã§ç¢ºèªã™ã‚‹
      console.log("[SYNC-B:view] appended LastDay card (moved under streak pair, after once/odoa)", {
        qid: (info && info.qid) ? info.qid : "-",
        headKey: headKey,
        headSync: headSync,
        headLocal: headLocal
      });
    })();

    // --- Pending (unsent) ---
    var pendingText = "none";
    if (model.pending && typeof model.pending === "object") {
      var bits = [];

      if (model.pending.pendingDiffCounts) bits.push("diffCounts");
      if (model.pending.pendingOncePerDayToday) bits.push("oncePerDayToday");
      if (model.pending.pendingLastSeenDay) bits.push("lastSeenDay");
      if (model.pending.pendingLastCorrectDay) bits.push("lastCorrectDay");
      if (model.pending.pendingLastWrongDay) bits.push("lastWrongDay");
      if (model.pending.pendingStreak3Today) bits.push("streak3Today");
      if (model.pending.pendingStreak3WrongToday) bits.push("streak3WrongToday");

      if (bits.length > 0) {
        pendingText = bits.join(", ");
      }
    }

    // --- Pending (unsent) ---
    var pendingCard = document.createElement("div");
    pendingCard.className = "cscs-svb-card is-wide svb-pending-card";

    // æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ï¼ˆæ°¸ç¶šï¼‰
    var pendingCollapsed = false;
    try {
      pendingCollapsed = (localStorage.getItem("cscs_sync_view_b_pending_collapsed") === "1");
    } catch (_ePendingCollapsed) {
      pendingCollapsed = false;
    }

    if (pendingCollapsed) {
      pendingCard.className += " is-collapsed";
    }

    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆã‚¿ã‚¤ãƒˆãƒ« + ãƒˆã‚°ãƒ«ï¼‰
    var pendingHead = document.createElement("div");
    pendingHead.className = "svb-pending-head";

    var pendingH = document.createElement("div");
    pendingH.className = "cscs-svb-card-title";
    pendingH.textContent = "Pending (unsent)";

    var pendingBtn = document.createElement("button");
    pendingBtn.className = "svb-pending-toggle";
    pendingBtn.type = "button";
    pendingBtn.setAttribute("aria-expanded", pendingCollapsed ? "false" : "true");

    function updatePendingBtnLabel() {
      var chev = pendingCollapsed ? "â–¶" : "â–¼";
      var label = pendingCollapsed ? "show" : "hide";
      pendingBtn.innerHTML = "<span class=\"svb-pending-chev\">" + chev + "</span>" + label;
      pendingBtn.setAttribute("aria-expanded", pendingCollapsed ? "false" : "true");
    }

    updatePendingBtnLabel();

    pendingBtn.addEventListener("click", function () {
      pendingCollapsed = !pendingCollapsed;

      if (pendingCollapsed) {
        if (pendingCard.className.indexOf("is-collapsed") === -1) {
          pendingCard.className += " is-collapsed";
        }
      } else {
        pendingCard.className = pendingCard.className.replace(/\bis-collapsed\b/g, "").replace(/\s{2,}/g, " ").trim();
      }

      try {
        localStorage.setItem("cscs_sync_view_b_pending_collapsed", pendingCollapsed ? "1" : "0");
      } catch (_eSavePending) {}

      updatePendingBtnLabel();
    });

    pendingHead.appendChild(pendingH);
    pendingHead.appendChild(pendingBtn);

    var gPending = document.createElement("div");
    gPending.className = "svb-pending-grid";

    pendingCard.appendChild(pendingHead);
    pendingCard.appendChild(gPending);
    body.appendChild(pendingCard);

    appendGridRow(gPending, "status", pendingText);

    function fmtDayPair(syncDay, localDay) {
      var s = (syncDay == null ? "-" : String(syncDay));
      var l = (localDay == null ? "-" : String(localDay));
      return "sync " + s + " / local " + l;
    }

    function fmtNumPair(syncNum, localNum) {
      var s = (syncNum == null ? 0 : Number(syncNum));
      var l = (localNum == null ? 0 : Number(localNum));
      if (!Number.isFinite(s)) s = 0;
      if (!Number.isFinite(l)) l = 0;
      return "sync " + String(s) + " / local " + String(l);
    }

    function fmtQidsPreview(arr) {
      if (!Array.isArray(arr) || arr.length === 0) return "-";
      var head = arr.slice(0, 3).join(", ");
      if (arr.length <= 3) return String(arr.length) + " [" + head + "]";
      return String(arr.length) + " [" + head + ", â€¦]";
    }

    // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
    //   local ã«å±…ã¦ sync ã«å±…ãªã„ qid ã‚’æŠ½å‡ºã—ã¦ã€Œæœªåæ˜ ã®å·®åˆ†(qids)ã€ã¨ã—ã¦å¯è¦–åŒ–ã™ã‚‹
    //   ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç„¡ã—ï¼šå¼•æ•°ã§æ¸¡ã•ã‚ŒãŸé…åˆ—ã ã‘ã‚’ä½¿ã†ï¼‰
    function pickLocalOnlyQids(syncArr, localArr) {
      if (!Array.isArray(localArr) || localArr.length === 0) return [];
      var set = Object.create(null);
      if (Array.isArray(syncArr) && syncArr.length > 0) {
        for (var i = 0; i < syncArr.length; i++) {
          var s = syncArr[i];
          if (typeof s === "string" && s) set[s] = 1;
        }
      }
      var out = [];
      for (var j = 0; j < localArr.length; j++) {
        var l = localArr[j];
        if (typeof l !== "string" || !l) continue;
        if (!set[l]) out.push(l);
      }
      return out;
    }

    if (model.pending && typeof model.pending === "object") {
      if (model.pending.pendingStreak3Today) {
        appendGridRow(
          gPending,
          "streak3Today.day",
          fmtDayPair(
            (window.__cscs_sync_state && window.__cscs_sync_state.streak3Today ? window.__cscs_sync_state.streak3Today.day : "-"),
            (function () { try { return localStorage.getItem("cscs_streak3_today_day") || "-"; } catch (_e) { return "-"; } })()
          )
        );
        appendGridRow(
          gPending,
          "streak3Today.unique",
          fmtNumPair(
            (window.__cscs_sync_state && window.__cscs_sync_state.streak3Today ? window.__cscs_sync_state.streak3Today.unique_count : 0),
            model.localS3TodayCnt
          )
        );
        appendGridRow(
          gPending,
          "streak3Today.qids",
          "sync " + fmtQidsPreview(model.s3TodaySyncQids) + " / local " + fmtQidsPreview(model.localS3TodayQids)
        );

        // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
        //   ã€Œlocal-onlyï¼ˆsyncæœªåæ˜ ï¼‰ã€ã® qids ã‚’è¡Œã¨ã—ã¦è¿½åŠ ã—ã¦ã€å·®åˆ†ãŒå³ã‚ã‹ã‚‹ã‚ˆã†ã«ã™ã‚‹
        var s3TodayMissing = pickLocalOnlyQids(model.s3TodaySyncQids, model.localS3TodayQids);
        appendGridRow(
          gPending,
          "streak3Today.missing",
          "local-only " + fmtQidsPreview(s3TodayMissing)
        );
      }

      if (model.pending.pendingStreak3WrongToday) {
        appendGridRow(
          gPending,
          "streak3WrongToday.day",
          fmtDayPair(
            (window.__cscs_sync_state && window.__cscs_sync_state.streak3WrongToday ? window.__cscs_sync_state.streak3WrongToday.day : "-"),
            (function () { try { return localStorage.getItem("cscs_streak3_wrong_today_day") || "-"; } catch (_e2) { return "-"; } })()
          )
        );
        appendGridRow(
          gPending,
          "streak3WrongToday.unique",
          fmtNumPair(
            (window.__cscs_sync_state && window.__cscs_sync_state.streak3WrongToday ? window.__cscs_sync_state.streak3WrongToday.unique_count : 0),
            model.localS3WrongTodayCnt
          )
        );
        appendGridRow(
          gPending,
          "streak3WrongToday.qids",
          "sync " + fmtQidsPreview(model.s3WrongTodaySyncQids) + " / local " + fmtQidsPreview(model.localS3WrongTodayQids)
        );

        // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
        //   ã€Œlocal-onlyï¼ˆsyncæœªåæ˜ ï¼‰ã€ã® qids ã‚’è¡Œã¨ã—ã¦è¿½åŠ ã—ã¦ã€å·®åˆ†ãŒå³ã‚ã‹ã‚‹ã‚ˆã†ã«ã™ã‚‹
        var s3WrongTodayMissing = pickLocalOnlyQids(model.s3WrongTodaySyncQids, model.localS3WrongTodayQids);
        appendGridRow(
          gPending,
          "streak3WrongToday.missing",
          "local-only " + fmtQidsPreview(s3WrongTodayMissing)
        );
      }
    }
  }

  function readSyncKey() {
    // ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
    //   Bå´ãŒä½¿ã† X-CSCS-Key ã‚’ã€Œã©ã“ã‹ã‚‰å–ã‚‹ã‹ã€ã‚’ä¸€æœ¬åŒ–ã™ã‚‹ã€‚
    //   - ã¾ãš window.CSCS_SYNC_KEYï¼ˆåˆ¥JSãŒæ³¨å…¥ã—ã¦ã„ã‚‹æƒ³å®šï¼‰
    //   - æ¬¡ã« localStorage "cscs_sync_key"ï¼ˆæ°¸ç¶šä¿æŒã—ã¦ã„ã‚‹æƒ³å®šï¼‰
    //   ã©ã¡ã‚‰ã«ã‚‚ç„¡ã‘ã‚Œã° null ã‚’è¿”ã™ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§åˆ¥ã‚½ãƒ¼ã‚¹ã‚’è¦‹ãªã„ï¼‰ã€‚
    try {
      if (typeof window.CSCS_SYNC_KEY === "string" && window.CSCS_SYNC_KEY.trim()) {
        return window.CSCS_SYNC_KEY.trim();
      }
    } catch (_eWinKey) {}

    try {
      var k = localStorage.getItem("cscs_sync_key");
      if (typeof k === "string" && k.trim()) {
        return k.trim();
      }
    } catch (_eLsKey) {}

    return null;
  }

  function fetchState() {
    // ============================================================
    // é‡è¦:
    //   /api/sync/state ã¯ã€Œbootstrap å®Œäº†å¾Œã€ã«ã®ã¿å©ã„ã¦ã‚ˆã„ã€‚
    //   localStorage ã®å€¤ã¯æœ€çµ‚ç¢ºå®šæ¡ä»¶ã¨ã—ã¦ä¿¡ç”¨ã—ãªã„ã€‚
    //
    //   æœ¬é–¢æ•°ã¯å¿…ãš
    //     window.__CSCS_SYNC_KEY_PROMISE__ resolve å¾Œ
    //   ã«å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ä¿è¨¼ã™ã‚‹ã€‚
    //
    // è¿½åŠ ã§ä¿è¨¼ã™ã‚‹ã“ã¨:
    //   - credentials: "include" ã‚’å¿…ãšä»˜ä¸ï¼ˆcookieå¿…é ˆã®ç’°å¢ƒã§å®‰å®šåŒ–ï¼‰
    //   - cache: "no-store" ã‚’ä»˜ä¸ï¼ˆçŠ¶æ…‹ã®å–ã‚Šç›´ã—ã‚’ç¢ºå®ŸåŒ–ï¼‰
    // ============================================================

    if (!window.__CSCS_SYNC_KEY_PROMISE__ || typeof window.__CSCS_SYNC_KEY_PROMISE__.then !== "function") {
      console.error("[SYNC-B:view] __CSCS_SYNC_KEY_PROMISE__ not found â†’ fetchState aborted", {
        endpoint: SYNC_STATE_ENDPOINT
      });
      throw new Error("SYNC_BOOTSTRAP_NOT_READY");
    }

    return window.__CSCS_SYNC_KEY_PROMISE__.then(function () {
      var key = readSyncKey();

      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç¦æ­¢:
      //   bootstrap å®Œäº†å¾Œã«ã‚‚ key ãŒç„¡ã„å ´åˆã¯ã€Œç•°å¸¸ã€ã¨ã—ã¦å³å¤±æ•—ã•ã›ã‚‹
      if (!key) {
        console.error("[SYNC-B:view] X-CSCS-Key missing AFTER bootstrap â†’ fetchState aborted", {
          endpoint: SYNC_STATE_ENDPOINT
        });
        throw new Error("X-CSCS-Key missing after bootstrap");
      }

      return fetch(SYNC_STATE_ENDPOINT, {
        method: "GET",
        cache: "no-store",
        credentials: "include",
        headers: {
          "X-CSCS-Key": key
        }
      });
    }).then(function (res) {
      if (!res.ok) {
        throw new Error(String(res.status));
      }
      return res.json();
    });
  }

  function createPanel() {
    var box = document.createElement("div");
    box.id = "cscs_sync_view_b";


    var title = document.createElement("div");
    title.id = "cscs_sync_view_b_title";
    title.textContent = "SYNC(B): " + info.qid;

    var body = document.createElement("div");
    body.id = "cscs_sync_view_b_body";
    body.textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";

    var statusDiv = document.createElement("div");
    statusDiv.id = "cscs_sync_view_b_status";

    box.appendChild(title);
    box.appendChild(body);
    box.appendChild(statusDiv);

    return box;
  }


```
<<<PART_END>>>
ã€RECEIPT_INPUTï¼ˆã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã ã‘ã‚’çœŸã¨ã™ã‚‹ï¼‰ã€‘
EXPECTED_TOTAL: 7
RECEIVED_TOTAL: 3

CUMULATIVE_RECEIVED_PARTIDS:
- CSCSJS-503CF878-P01-of-07
- CSCSJS-503CF878-P02-of-07
- CSCSJS-503CF878-P03-of-07

ã€ChatGPTã¸ã®å¼·åˆ¶ãƒ«ãƒ¼ãƒ«ã€‘
ãƒ»å—é ˜ç¢ºèªãŠã‚ˆã³å®Ÿè¡Œãƒ•ã‚§ãƒ¼ã‚ºã§ã¯ã€åŒä¸€ SessionID ã«å±ã™ã‚‹éå»PARTæœ¬æ–‡ã‚’å¿…ãšå…¨ã¦å‚ç…§ã™ã‚‹ã“ã¨ã€‚
ãƒ»å‚ç…§å¯¾è±¡ã¯ã€åŒä¸€ SessionID ã® EXPECTED_PARTIDS ã«å«ã¾ã‚Œã‚‹ PART ã«é™å®šã™ã‚‹ã“ã¨ã€‚
ãƒ»å—é ˜ç¢ºèªOKå‰ã¯ã€ä½œæ¥­é–‹å§‹ï¼ˆJOIN/EXECï¼‰ã‚’è¡Œã‚ãªã„ã“ã¨ã€‚

RECEIPT_REQUIRED_RESPONSE_TEMPLATE:
ACK: <PartID> <PartSHA256_8> / WAITING_NEXT

ã€åˆ†å‰²ã‚³ãƒ¼ãƒ‰(3)ã®çµ‚äº†ã€‘â†’ æ¬¡ã¯ åˆ†å‰²ã‚³ãƒ¼ãƒ‰(4) ã‚’é€ã‚Šã¾ã™ï¼ˆå…¨7åˆ†å‰²ï¼‰
ã€ChatGPTã¸ã®æŒ‡ç¤ºã€‘è§£é‡ˆãƒ»è¦ç´„ãƒ»æ¨æ¸¬ãƒ»ä¿®æ­£æ¡ˆæç¤ºã¯ç¦æ­¢ã€‚è¿”ç­”ã¯æ¬¡ã®ã¿ã€‚
ACK: <PartID> / WAITING_NEXT
