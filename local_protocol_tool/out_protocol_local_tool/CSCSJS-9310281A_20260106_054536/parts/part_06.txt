<<<PART_BEGIN>>>
ã€åˆ†å‰²ã‚³ãƒ¼ãƒ‰(6)ã®é–‹å§‹ã€‘
PartID: CSCSJS-9310281A-P06-of-07
SourceFile: cscs_sync_view_b.js
PartSHA256: 168e3620f6b914d332b57b4bc5a45646bf7396945601689693064e7ea2ceb49d
Range: chars 158960..172723 (len=13763)
FirstLine:   function init() {
LastLine: })();
EndNewline: NO
PART_SCOPE_HINT: LineRange=L4469..L4898 | BraceDepth=1->0
PART_SCOPE_HINT_TOP_IDENTIFIERS: console:40, day:26, qids:26, SYNC:25, state:24, B:20, streak3Today:19, streak3WrongToday:19, window:16, log:16, st:15, merge:12
PART_SCOPE_HINT_DEFINES: init, ensureOnceOdoaNoFlashStyle, clearOnceOdoaNoFlashStyle, append, id, st, box, wrap, state, day, qids, localCount, rawQids, rawCnt, parsed, cnt, payload, keyForMerge, res, merged, stateAfter

```javascript
  function init() {
    // â˜… ãƒ‘ãƒãƒ«ç”Ÿæˆã‚ˆã‚Šå…ˆã«CSSã‚’æ³¨å…¥ï¼ˆåˆå›è¡¨ç¤ºã‹ã‚‰ç¢ºå®Ÿã«é©ç”¨ï¼‰
    ensureSyncViewBStyles();

    // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
    //   ãƒªãƒ­ãƒ¼ãƒ‰ç›´å¾Œã« OncePerDayToday / O.D.O.A Mode ãŒã€Œä¸€ç¬ã ã‘æœ€ä¸Šæ®µã«å‡ºã‚‹ã€ãƒãƒ©ã¤ãã‚’é˜²ããŸã‚ã€
    //   once/odoa ç³»ã‚«ãƒ¼ãƒ‰ã‚’ä¸€æ—¦ visibility:hidden ã«ã—ã¦ãŠãï¼ˆç§»å‹•ãƒ»æ•´ç†ãŒçµ‚ã‚ã£ãŸã‚‰è§£é™¤ã™ã‚‹ï¼‰
    function ensureOnceOdoaNoFlashStyle() {
      try {
        var id = "cscs_sync_view_b_once_odoa_no_flash";
        if (document.getElementById(id)) return;
        var st = document.createElement("style");
        st.id = id;
        st.type = "text/css";
        st.textContent =
          "#cscs_sync_view_b_status .svb-once-odoa-card{display:none !important;}" +
          "#cscs_sync_view_b_status .svb-once-odoa-card-local{display:none !important;}";
        document.head.appendChild(st);
      } catch (_e) {}
    }

    function clearOnceOdoaNoFlashStyle() {
      try {
        var id = "cscs_sync_view_b_once_odoa_no_flash";
        var st = document.getElementById(id);
        if (st && st.parentNode) st.parentNode.removeChild(st);
      } catch (_e) {}
    }

    ensureOnceOdoaNoFlashStyle();

    var box = createPanel();

    function append() {
      var wrap = document.querySelector("div.wrap");
      if (wrap) {
        if (!wrap.contains(box)) {
          wrap.appendChild(box);
        }
      } else {
        if (!document.body.contains(box)) {
          document.body.appendChild(box);
        }
      }

      // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
      //   æ—¢å­˜(SYNC)ã‚«ãƒ¼ãƒ‰ã®è¦‹å‡ºã—ã‚’ "(SYNC)" ã«ã—ã€ç›´ä¸‹ã« localå°‚ç”¨ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹
      ensureOnceOdoaWideTitles(box);
      ensureLocalOnceOdoaWideCard(box);

      // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
      //   once/odoa ç³»ã‚«ãƒ¼ãƒ‰ã®ç§»å‹•ãƒ»æ•´ç†ãŒå®Œäº†ã—ãŸã®ã§ã€ãƒãƒ©ã¤ãé˜²æ­¢ã®éè¡¨ç¤ºã‚’è§£é™¤ã™ã‚‹
      try {
        var id = "cscs_sync_view_b_once_odoa_no_flash";
        var st = document.getElementById(id);
        if (st && st.parentNode) st.parentNode.removeChild(st);
      } catch (_eNF) {}

      // â‘¢ åˆæœŸè¡¨ç¤ºæ™‚ã® HUD æ›´æ–°ï¼ˆdiff é€ä¿¡ã‚ã‚Šã®é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼‰
      refreshAndSend(box);
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", append);
    } else {
      append();
    }
  }

  if (typeof window.CSCS_SYNC === "undefined" || window.CSCS_SYNC === null) {
    window.CSCS_SYNC = {};
  }

  window.CSCS_SYNC.recordStreak3TodayUnique = async function () {
    try {
      // â˜… è¿½åŠ ã‚¬ãƒ¼ãƒ‰: O.D.O.A ãŒ nocount ã®ã¨ãã¯ streak3Today ã‚’ä¸€åˆ‡é€ã‚‰ãªã„
      var state = null;
      try {
        state = window.__cscs_sync_state || null;
      } catch(_e) {
        state = null;
      }
      if (state && (state.odoaMode === "on_nocount" || state.odoa_mode === "on_nocount")) {
        // è£œè¶³: nocount ä¸­ã« streak3Today ãŒé€ä¿¡ã•ã‚Œã‚‹ã¨ã€Œæ­£èª¤ã‚’è¨ˆæ¸¬ã—ã¦ã„ãªã„ã®ã«â˜…ã ã‘å¢—ãˆã‚‹äº‹æ•…ã€ãŒç™ºç”Ÿã™ã‚‹ãŸã‚ã€
        //       ã“ã“ã§å¿…ãšãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã€‚
        console.log("[SYNC-B:streak3Today] skip because O.D.O.A = on_nocount");
        return;
      }

      // 1) ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãªã‚‰ãã‚‚ãã‚‚é€ä¿¡ã—ãªã„ï¼ˆBãƒ‘ãƒ¼ãƒˆã‹ã‚‰ã® streak3TodayDelta ã¯ã€Œã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚ã ã‘ã€ï¼‰
      if (!navigator.onLine) {
        console.warn("[SYNC-B:streak3Today] offline â†’ é€ä¿¡ã‚¹ã‚­ãƒƒãƒ—");
        return;
      }

      // 2) localStorage ã«æºœã¾ã£ã¦ã„ã‚‹ã€Œä»Šæ—¥ã®â­ï¸æƒ…å ±ã€ã‚’èª­ã¿å‡ºã™ãŸã‚ã®ä¸€æ™‚å¤‰æ•°
      var day = "";
      var qids = [];
      var localCount = 0;

      try {
        // 2-1) ã€Œä»Šæ—¥ãŒä½•æ—¥ã‹ã€ã‚’è¡¨ã™æ–‡å­—åˆ—ï¼ˆä¾‹: "20251201"ï¼‰
        day = localStorage.getItem("cscs_streak3_today_day") || "";
        // 2-2) ä»Šæ—¥â­ï¸ã‚’æ–°è¦ç²å¾—ã—ãŸ qid ã®é…åˆ—ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ãŸæ–‡å­—åˆ—
        var rawQids = localStorage.getItem("cscs_streak3_today_qids");
        // 2-3) ä»Šæ—¥ã®â­ï¸ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°ï¼ˆlocal å´ã‚«ã‚¦ãƒ³ã‚¿ï¼‰
        var rawCnt = localStorage.getItem("cscs_streak3_today_unique_count");

        // 2-4) qids ã® JSON ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ã€Œå¦¥å½“ãªæ–‡å­—åˆ—ã ã‘ã€ã®é…åˆ—ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if (rawQids) {
          var parsed = JSON.parse(rawQids);
          if (Array.isArray(parsed)) {
            qids = parsed.filter(function (x) {
              return typeof x === "string" && x;
            });
          }
        }

        // 2-5) ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°ã‚’æ•°å€¤ã«ãƒ‘ãƒ¼ã‚¹ï¼ˆä¸æ­£å€¤ã‚„è² æ•°ã¯ 0 æ‰±ã„ï¼‰
        var cnt = parseInt(rawCnt || "0", 10);
        if (Number.isFinite(cnt) && cnt >= 0) {
          localCount = cnt;
        }
      } catch (_e) {
        // localStorage / JSON ãƒ‘ãƒ¼ã‚¹ã®ã©ã“ã‹ã§å¤±æ•—ã—ãŸå ´åˆã¯ã€Œç©ºãƒ‡ãƒ¼ã‚¿ã€ã¨ã—ã¦æ‰±ã†
        day = "";
        qids = [];
        localCount = 0;
      }

      // 3) èª­ã¿å‡ºã—ãŸãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ•ãƒ«å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      console.group("[SYNC-B:streak3Today] recordStreak3TodayUnique CALLED");
      console.log("local.day =", day);
      console.log("local.qids =", qids);
      console.log("local.unique_count =", localCount);
      console.groupEnd();

      // 4) æ—¥ä»˜ã‹ qid é…åˆ—ãŒç©ºãªã‚‰ã€ã‚µãƒ¼ãƒãƒ¼å´ã‚’å£Šã•ãªã„ãŸã‚ã«é€ä¿¡ã—ãªã„
      //    - åˆå›èµ·å‹•ç›´å¾Œãªã©ã€Œã¾ã  streak3Today æƒ…å ±ãŒç„¡ã„ã€ã‚±ãƒ¼ã‚¹ã¯æ­£å¸¸ãªã‚¹ã‚­ãƒƒãƒ—ã¨ã—ã¦æ‰±ã†
      if (!day || qids.length === 0) {
        console.log("[SYNC-B:streak3Today] day åˆã¯ qids ãŒç©º â†’ æ­£å¸¸ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã¾ã é€ã‚‹ã¹ããƒ‡ãƒ¼ã‚¿ãŒãªã„ï¼‰", {
          day: day,
          qidsLength: qids.length
        });
        return;
      }

      // 5) Workers å´ã® merge.ts ã«æ¸¡ã™ streak3TodayDelta ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’çµ„ã¿ç«‹ã¦
      //    - day: "YYYYMMDD" å½¢å¼
      //    - qids: ãã®æ—¥ã«â­ï¸ã‚’åˆã‚ã¦å–ã£ãŸå•é¡Œã® qid é…åˆ—
      var payload = {
        payloadType: "diff",
        streak3TodayDelta: {
          day: day,
          qids: qids
        },
        updatedAt: Date.now()
      };

      // 6) é€ä¿¡ç›´å‰ã® payload ã‚’ä¸¸ã”ã¨ãƒ­ã‚°ã«å‡ºã—ã¦ãŠã
      console.group("[SYNC-B:streak3Today] SEND payload");
      console.log(payload);
      console.groupEnd();

      // 7) /api/sync/merge ã«å¯¾ã—ã¦ streak3TodayDelta å°‚ç”¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
      // ============================================================
      // é‡è¦ï¼ˆæ’ä¹…ãƒ«ãƒ¼ãƒ«ï¼‰:
      //   X-CSCS-Key ã¯ /api/sync/state ã‹ã‚‰å–å¾—ã—ãªã„ã€‚
      //   key ã®å”¯ä¸€ã®ç¢ºå®šãƒ«ãƒ¼ãƒˆã¯ cscs_sync_bootstrap_a.jsã€‚
      //   ã“ã“ã§ã¯ bootstrap å®Œäº†ã‚’å¾…ã¡ã€ãã®çµæœã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã€‚
      // ============================================================

      if (!window.__CSCS_SYNC_KEY_PROMISE__ || typeof window.__CSCS_SYNC_KEY_PROMISE__.then !== "function") {
        throw new Error("SYNC_BOOTSTRAP_NOT_READY");
      }

      await window.__CSCS_SYNC_KEY_PROMISE__;

      var keyForMerge = "";
      try {
        keyForMerge = String(readSyncKey() || "").trim();
      } catch (_e1) {
        keyForMerge = "";
      }

      if (!keyForMerge) {
        // bootstrap å¾Œã«ã‚‚ key ãŒç„¡ã„ã®ã¯ç•°å¸¸ã€‚
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã›ãšã€å•é¡Œã‚’é¡•åœ¨åŒ–ã•ã›ã‚‹ã€‚
        throw new Error("X-CSCS-Key missing after bootstrap (streak3Today)");
      }

      var res = await fetch(SYNC_MERGE_ENDPOINT, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSCS-Key": keyForMerge
        },
        body: JSON.stringify(payload),
        keepalive: true,
        credentials: "include"
      });

      // 8) HTTP ãƒ¬ãƒ™ãƒ«ã§ã‚¨ãƒ©ãƒ¼ãªã‚‰ã“ã“ã§çµ‚äº†ï¼ˆã‚µãƒ¼ãƒãƒ¼ä¿å­˜å¤±æ•—ã®å¯èƒ½æ€§ï¼‰
      if (!res.ok) {
        console.error("[SYNC-B:streak3Today] merge FAILED:", res.status);
        return;
      }

      // 9) merge.ts ãŒè¿”ã—ã¦ããŸæœ€æ–°ã® SYNC ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—ï¼ˆå¤±æ•—ã—ã¦ã‚‚è‡´å‘½çš„ã§ã¯ãªã„ï¼‰
      var merged = null;
      try {
        merged = await res.json();
      } catch (_e2) {
        merged = null;
      }

      // 10) merge ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ­ã‚°ã«æ®‹ã—ã¦ãŠãï¼ˆWorkers å´ã§ã©ã†ä¿å­˜ã•ã‚ŒãŸã‹ã®ç¢ºèªç”¨ï¼‰
      console.group("[SYNC-B:streak3Today] MERGE result");
      console.log("mergeResponse =", merged);
      console.groupEnd();

      // 11) ã•ã‚‰ã« /api/sync/state ã‚’å©ã„ã¦ã€KV ã«åæ˜ ã•ã‚ŒãŸæœ€çµ‚å½¢ã® streak3Today ã‚’ç¢ºèªã™ã‚‹
      try {
        var stateAfter = await fetchState();
        try {
          // 11-1) å–å¾—ã—ãŸ state å…¨ä½“ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿æŒã—ã¦ã€
          //       Bãƒ‘ãƒ¼ãƒˆ HUD ã‚„ä»–ã®ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ã‚‚ streak3Today ã‚’å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
          window.__cscs_sync_state = stateAfter;
        } catch (_e3) {}

        // 11-2) stateAfter.streak3Today ã®ä¸­èº«ã‚’ãã®ã¾ã¾ãƒ­ã‚°ã«å‡ºã—ã¦ã€
        //       ã€Œday / unique_count / qids ãŒã©ã®ã‚ˆã†ã«ä¿å­˜ã•ã‚ŒãŸã‹ã€ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        console.group("[SYNC-B:streak3Today] UPDATED state.streak3Today");
        console.log(stateAfter && stateAfter.streak3Today);
        console.groupEnd();

      } catch (e4) {
        // state ã®å†å–å¾—è‡ªä½“ãŒå¤±æ•—ã—ãŸã‚±ãƒ¼ã‚¹ï¼ˆmerge è‡ªä½“ã¯æˆåŠŸã—ã¦ã„ã‚‹å¯èƒ½æ€§ã‚ã‚Šï¼‰
        console.error("[SYNC-B:streak3Today] state refresh ERROR:", e4);
      }

    } catch (e) {
      // æƒ³å®šå¤–ã®ä¾‹å¤–ãŒèµ·ããŸå ´åˆã‚‚æ¡ã‚Šã¤ã¶ã•ãšãƒ­ã‚°ã«å‡ºã™
      console.error("[SYNC-B:streak3Today] fatal error:", e);
    }
  };

  // â˜… ä¸æ­£è§£ç‰ˆ: ä»Šæ—¥ã®3é€£ç¶šä¸æ­£è§£ãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼ˆStreak3WrongTodayï¼‰ã‚’ SYNC å´ã«é€ä¿¡ã™ã‚‹
  window.CSCS_SYNC.recordStreak3WrongTodayUnique = async function () {
    try {
      // â˜… è¿½åŠ ã‚¬ãƒ¼ãƒ‰: O.D.O.A ãŒ nocount ã®ã¨ãã¯ streak3WrongToday ã‚’ä¸€åˆ‡é€ã‚‰ãªã„
      var state = null;
      try {
        state = window.__cscs_sync_state || null;
      } catch(_e) {
        state = null;
      }
      if (state && (state.odoaMode === "on_nocount" || state.odoa_mode === "on_nocount")) {
        // è£œè¶³: nocount ä¸­ã« streak3WrongToday ãŒé€ä¿¡ã•ã‚Œã‚‹ã¨
        //       ã€Œæ­£èª¤ã‚’è¨ˆæ¸¬ã—ã¦ã„ãªã„ã®ã«ğŸ’£ã ã‘å¢—ãˆã‚‹äº‹æ•…ã€ãŒç™ºç”Ÿã™ã‚‹ãŸã‚ã€ã“ã“ã§å¿…ãšãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã€‚
        console.log("[SYNC-B:streak3WrongToday] skip because O.D.O.A = on_nocount");
        return;
      }

      // 1) ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãªã‚‰ãã‚‚ãã‚‚é€ä¿¡ã—ãªã„ï¼ˆBãƒ‘ãƒ¼ãƒˆã‹ã‚‰ã® streak3WrongTodayDelta ã¯ã€Œã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚ã ã‘ã€ï¼‰
      if (!navigator.onLine) {
        console.warn("[SYNC-B:streak3WrongToday] offline â†’ é€ä¿¡ã‚¹ã‚­ãƒƒãƒ—");
        return;
      }

      // 2) localStorage ã«æºœã¾ã£ã¦ã„ã‚‹ã€Œä»Šæ—¥ã®3é€£ç¶šä¸æ­£è§£æƒ…å ±ã€ã‚’èª­ã¿å‡ºã™ãŸã‚ã®ä¸€æ™‚å¤‰æ•°
      var day = "";
      var qids = [];
      var localCount = 0;

      try {
        // 2-1) ã€Œä»Šæ—¥ãŒä½•æ—¥ã‹ã€ã‚’è¡¨ã™æ–‡å­—åˆ—ï¼ˆä¾‹: "20251201"ï¼‰
        day = localStorage.getItem("cscs_streak3_wrong_today_day") || "";
        // 2-2) ä»Šæ—¥ğŸ’£ã‚’æ–°è¦ç²å¾—ã—ãŸ qid ã®é…åˆ—ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ãŸæ–‡å­—åˆ—
        var rawQids = localStorage.getItem("cscs_streak3_wrong_today_qids");
        // 2-3) ä»Šæ—¥ã®3é€£ç¶šä¸æ­£è§£ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°ï¼ˆlocal å´ã‚«ã‚¦ãƒ³ã‚¿ï¼‰
        var rawCnt = localStorage.getItem("cscs_streak3_wrong_today_unique_count");

        // 2-4) qids ã® JSON ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ã€Œå¦¥å½“ãªæ–‡å­—åˆ—ã ã‘ã€ã®é…åˆ—ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if (rawQids) {
          var parsed = JSON.parse(rawQids);
          if (Array.isArray(parsed)) {
            qids = parsed.filter(function (x) {
              return typeof x === "string" && x;
            });
          }
        }

        // 2-5) ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°ã‚’æ•°å€¤ã«ãƒ‘ãƒ¼ã‚¹ï¼ˆä¸æ­£å€¤ã‚„è² æ•°ã¯ 0 æ‰±ã„ï¼‰
        var cnt = parseInt(rawCnt || "0", 10);
        if (Number.isFinite(cnt) && cnt >= 0) {
          localCount = cnt;
        }
      } catch (_e2) {
        // localStorage / JSON ãƒ‘ãƒ¼ã‚¹ã®ã©ã“ã‹ã§å¤±æ•—ã—ãŸå ´åˆã¯ã€Œç©ºãƒ‡ãƒ¼ã‚¿ã€ã¨ã—ã¦æ‰±ã†
        day = "";
        qids = [];
        localCount = 0;
      }

      // 3) èª­ã¿å‡ºã—ãŸãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ•ãƒ«å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      console.group("[SYNC-B:streak3WrongToday] recordStreak3WrongTodayUnique CALLED");
      console.log("local.day =", day);
      console.log("local.qids =", qids);
      console.log("local.unique_count =", localCount);
      console.groupEnd();

      // 4) æ—¥ä»˜ã‹ qid é…åˆ—ãŒç©ºãªã‚‰ã€ã‚µãƒ¼ãƒãƒ¼å´ã‚’å£Šã•ãªã„ãŸã‚ã«é€ä¿¡ã—ãªã„
      //    - åˆå›èµ·å‹•ç›´å¾Œãªã©ã€Œã¾ã  streak3WrongToday æƒ…å ±ãŒç„¡ã„ã€ã‚±ãƒ¼ã‚¹ã¯æ­£å¸¸ãªã‚¹ã‚­ãƒƒãƒ—ã¨ã—ã¦æ‰±ã†
      if (!day || qids.length === 0) {
        console.log("[SYNC-B:streak3WrongToday] day åˆã¯ qids ãŒç©º â†’ æ­£å¸¸ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã¾ã é€ã‚‹ã¹ããƒ‡ãƒ¼ã‚¿ãŒãªã„ï¼‰", {
          day: day,
          qidsLength: qids.length
        });
        return;
      }

      // 5) Workers å´ã® merge.ts ã«æ¸¡ã™ streak3WrongTodayDelta ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’çµ„ã¿ç«‹ã¦
      //    - day: "YYYYMMDD" å½¢å¼
      //    - qids: ãã®æ—¥ã«ğŸ’£ã‚’åˆã‚ã¦å–ã£ãŸå•é¡Œã® qid é…åˆ—
      var payload = {
        payloadType: "diff",
        streak3WrongTodayDelta: {
          day: day,
          qids: qids
        },
        updatedAt: Date.now()
      };

      // 6) é€ä¿¡ç›´å‰ã® payload ã‚’ä¸¸ã”ã¨ãƒ­ã‚°ã«å‡ºã—ã¦ãŠã
      console.group("[SYNC-B:streak3WrongToday] SEND payload");
      console.log(payload);
      console.groupEnd();

      // 7) /api/sync/merge ã«å¯¾ã—ã¦ streak3WrongTodayDelta å°‚ç”¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
      // ============================================================
      // é‡è¦ï¼ˆæ’ä¹…ãƒ«ãƒ¼ãƒ«ï¼‰:
      //   X-CSCS-Key ã¯ /api/sync/state ã‹ã‚‰å–å¾—ã—ãªã„ã€‚
      //   key ã®å”¯ä¸€ã®ç¢ºå®šãƒ«ãƒ¼ãƒˆã¯ cscs_sync_bootstrap_a.jsã€‚
      //   ã“ã“ã§ã¯ bootstrap å®Œäº†ã‚’å¾…ã¡ã€ãã®çµæœã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã€‚
      // ============================================================

      if (!window.__CSCS_SYNC_KEY_PROMISE__ || typeof window.__CSCS_SYNC_KEY_PROMISE__.then !== "function") {
        throw new Error("SYNC_BOOTSTRAP_NOT_READY");
      }

      await window.__CSCS_SYNC_KEY_PROMISE__;

      var keyForMerge = "";
      try {
        keyForMerge = String(readSyncKey() || "").trim();
      } catch (_e1) {
        keyForMerge = "";
      }

      if (!keyForMerge) {
        // bootstrap å¾Œã«ã‚‚ key ãŒç„¡ã„ã®ã¯ç•°å¸¸ã€‚
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ç¶™ç¶šã›ãšã€å•é¡Œã‚’é¡•åœ¨åŒ–ã•ã›ã‚‹ã€‚
        throw new Error("X-CSCS-Key missing after bootstrap (streak3WrongToday)");
      }

      var res = await fetch(SYNC_MERGE_ENDPOINT, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSCS-Key": keyForMerge
        },
        body: JSON.stringify(payload),
        keepalive: true,
        credentials: "include"
      });

      // 8) HTTP ãƒ¬ãƒ™ãƒ«ã§ã‚¨ãƒ©ãƒ¼ãªã‚‰ã“ã“ã§çµ‚äº†ï¼ˆã‚µãƒ¼ãƒãƒ¼ä¿å­˜å¤±æ•—ã®å¯èƒ½æ€§ï¼‰
      if (!res.ok) {
        console.error("[SYNC-B:streak3WrongToday] merge FAILED:", res.status);
        return;
      }

      // 9) merge.ts ãŒè¿”ã—ã¦ããŸæœ€æ–°ã® SYNC ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—ï¼ˆå¤±æ•—ã—ã¦ã‚‚è‡´å‘½çš„ã§ã¯ãªã„ï¼‰
      var merged = null;
      try {
        merged = await res.json();
      } catch (_e3) {
        merged = null;
      }

      // 10) merge ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ­ã‚°ã«æ®‹ã—ã¦ãŠãï¼ˆWorkers å´ã§ã©ã†ä¿å­˜ã•ã‚ŒãŸã‹ã®ç¢ºèªç”¨ï¼‰
      console.group("[SYNC-B:streak3WrongToday] MERGE result");
      console.log("mergeResponse =", merged);
      console.groupEnd();

      // 11) ã•ã‚‰ã« /api/sync/state ã‚’å©ã„ã¦ã€KV ã«åæ˜ ã•ã‚ŒãŸæœ€çµ‚å½¢ã® streak3WrongToday ã‚’ç¢ºèªã™ã‚‹
      try {
        var stateAfter = await fetchState();
        try {
          // 11-1) å–å¾—ã—ãŸ state å…¨ä½“ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿æŒã—ã¦ã€
          //       Bãƒ‘ãƒ¼ãƒˆ HUD ã‚„ä»–ã®ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ã‚‚ streak3WrongToday ã‚’å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
          window.__cscs_sync_state = stateAfter;
        } catch (_e4) {}

        // 11-2) stateAfter.streak3WrongToday ã®ä¸­èº«ã‚’ãã®ã¾ã¾ãƒ­ã‚°ã«å‡ºã—ã¦ã€
        //       ã€Œday / unique_count / qids ãŒã©ã®ã‚ˆã†ã«ä¿å­˜ã•ã‚ŒãŸã‹ã€ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        console.group("[SYNC-B:streak3WrongToday] UPDATED state.streak3WrongToday");
        console.log(stateAfter && stateAfter.streak3WrongToday);
        console.groupEnd();

      } catch (e5) {
        // state ã®å†å–å¾—è‡ªä½“ãŒå¤±æ•—ã—ãŸã‚±ãƒ¼ã‚¹ï¼ˆmerge è‡ªä½“ã¯æˆåŠŸã—ã¦ã„ã‚‹å¯èƒ½æ€§ã‚ã‚Šï¼‰
        console.error("[SYNC-B:streak3WrongToday] state refresh ERROR:", e5);
      }

    } catch (e) {
      // æƒ³å®šå¤–ã®ä¾‹å¤–ãŒèµ·ããŸå ´åˆã‚‚æ¡ã‚Šã¤ã¶ã•ãšãƒ­ã‚°ã«å‡ºã™
      console.error("[SYNC-B:streak3WrongToday] fatal error:", e);
    }
  };

  window.addEventListener("online", function () {
    var box = document.getElementById("cscs_sync_view_b");
    if (!box) return;
    refreshAndSend(box);
  });

  init();
})();
```
<<<PART_END>>>
ã€RECEIPT_INPUTï¼ˆã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã ã‘ã‚’çœŸã¨ã™ã‚‹ï¼‰ã€‘
EXPECTED_TOTAL: 7
RECEIVED_TOTAL: 6

CUMULATIVE_RECEIVED_PARTIDS:
- CSCSJS-9310281A-P01-of-07
- CSCSJS-9310281A-P02-of-07
- CSCSJS-9310281A-P03-of-07
- CSCSJS-9310281A-P04-of-07
- CSCSJS-9310281A-P05-of-07
- CSCSJS-9310281A-P06-of-07

ã€ChatGPTã¸ã®å¼·åˆ¶ãƒ«ãƒ¼ãƒ«ã€‘
ãƒ»å—é ˜ç¢ºèªãŠã‚ˆã³å®Ÿè¡Œãƒ•ã‚§ãƒ¼ã‚ºã§ã¯ã€åŒä¸€ SessionID ã«å±ã™ã‚‹éå»PARTæœ¬æ–‡ã‚’å¿…ãšå…¨ã¦å‚ç…§ã™ã‚‹ã“ã¨ã€‚
ãƒ»å‚ç…§å¯¾è±¡ã¯ã€åŒä¸€ SessionID ã® EXPECTED_PARTIDS ã«å«ã¾ã‚Œã‚‹ PART ã«é™å®šã™ã‚‹ã“ã¨ã€‚
ãƒ»å—é ˜ç¢ºèªOKå‰ã¯ã€ä½œæ¥­é–‹å§‹ï¼ˆJOIN/EXECï¼‰ã‚’è¡Œã‚ãªã„ã“ã¨ã€‚

RECEIPT_REQUIRED_RESPONSE_TEMPLATE:
ACK: <PartID> <PartSHA256_8> / WAITING_NEXT

ã€åˆ†å‰²ã‚³ãƒ¼ãƒ‰(6)ã®çµ‚äº†ã€‘â†’ æ¬¡ã¯ åˆ†å‰²ã‚³ãƒ¼ãƒ‰(7) ã‚’é€ã‚Šã¾ã™ï¼ˆå…¨7åˆ†å‰²ï¼‰
ã€ChatGPTã¸ã®æŒ‡ç¤ºã€‘è§£é‡ˆãƒ»è¦ç´„ãƒ»æ¨æ¸¬ãƒ»ä¿®æ­£æ¡ˆæç¤ºã¯ç¦æ­¢ã€‚è¿”ç­”ã¯æ¬¡ã®ã¿ã€‚
ACK: <PartID> / WAITING_NEXT
