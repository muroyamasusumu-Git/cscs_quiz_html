(function () {
  "use strict";

  // ============================================================================
  // ğŸš¨ğŸš¨ğŸš¨ è¶…é‡è¦ï¼šã“ã®JSã¯ã€Œæ¥µã‚ã¦å±é™ºã€ ğŸš¨ğŸš¨ğŸš¨
  //
  // ç›®çš„:
  //   - ãƒ‡ãƒãƒƒã‚°ç”¨ã«ã€ŒSYNC(KV)ã®å®Œå…¨å‰Šé™¤ã€ã‚’ã‚µãƒ¼ãƒã¸ä¾é ¼ã—ã€ãã®ç›´å¾Œã« state ã‚’å–å¾—ã—ã¦
  //     â€œæœ¬å½“ã«ç©ºèµ·ç‚¹ã«æˆ»ã£ãŸã‹â€ ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¸Šã§æ¤œè¨¼ã™ã‚‹ã€‚
  //
  // å±é™ºæ€§ï¼ˆå¿…èª­ï¼‰:
  //   - ã“ã‚Œã¯ã€Œãƒªã‚»ãƒƒãƒˆã€ã§ã¯ãªã„ã€‚
  //     â†’ SYNC(KV)ã®ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ â€œã‚­ãƒ¼ã”ã¨ deleteâ€ ã•ã›ã‚‹ã€Œå®Œå…¨æ¶ˆå»ã€ã‚³ãƒãƒ³ãƒ‰ã€‚
  //   - å®Ÿè¡Œã—ãŸç¬é–“ã«ã€ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆCF Access ã® emailï¼‰ã«ç´ã¥ã SYNC state ã¯
  //     è¨­å®šç³»ãƒ»è¨ˆæ¸¬ç³»ãƒ»æ—§ä»•æ§˜ã®æ®‹éª¸ãƒ»æœªçŸ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å«ã‚ã¦ã€Œå…¨éƒ¨ã€æ¶ˆãˆã‚‹ã€‚
  //   - å–ã‚Šæ¶ˆã—ä¸å¯ã€‚å¾©å…ƒä¸å¯ã€‚
  //     â†’ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚„å±¥æ­´ãŒç„¡ã„é™ã‚Šã€å…ƒã«æˆ»ã™æ‰‹æ®µã¯ç„¡ã„ã€‚
  //   - èª¤ã£ã¦æœ¬ç•ªç’°å¢ƒãƒ»åˆ¥ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ»åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å®Ÿè¡Œã™ã‚‹ã¨ã€
  //     â€œæœ¬ç•ªãƒ‡ãƒ¼ã‚¿ç ´å£Šâ€ ã«ãªã‚‹ï¼ˆï¼äº‹æ•…ã¨ã—ã¦æœ€æ‚ªã‚¯ãƒ©ã‚¹ï¼‰ã€‚
  //
  // ä½¿ç”¨æ¡ä»¶ï¼ˆã“ã‚Œã‚’æº€ãŸã•ãªã„ãªã‚‰å®Ÿè¡Œç¦æ­¢ï¼‰:
  //   - ã€Œä»Šã¯ãƒ‡ãƒãƒƒã‚°æœŸã§ã€å®Œå…¨ãªåˆæœŸçŠ¶æ…‹ã‹ã‚‰æ¤œè¨¼ã—ãŸã„ã€å ´åˆã«é™ã‚‹ã€‚
  //   - å®Ÿè¡Œã™ã‚‹ãƒšãƒ¼ã‚¸ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒ â€œæœ¬å½“ã«å‰Šé™¤ã—ã¦ã‚ˆã„ç’°å¢ƒâ€ ã§ã‚ã‚‹ã“ã¨ã‚’ã€
  //     ç›®è¦–ã§ç¢ºèªã—ã¦ã‹ã‚‰è²¼ã‚Šä»˜ã‘ã‚‹ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°/ãƒ†ã‚¹ãƒˆç”¨ã‚’å¼·ãæ¨å¥¨ï¼‰ã€‚
  //   - Cloudflare Access ãªã©ã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹å ´åˆã§ã‚‚ã€åŒä¸€ã‚ªãƒªã‚¸ãƒ³ fetch ã«ã‚ˆã‚Š
  //     ãƒ–ãƒ©ã‚¦ã‚¶ãŒèªè¨¼æƒ…å ±ï¼ˆCookie/ãƒ˜ãƒƒãƒ€ï¼‰ã‚’ä»˜ä¸ã§ãã‚‹å‰æï¼ˆ=ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ï¼‰ã€‚
  //
  // å®Ÿè¡Œçµæœã®æœŸå¾…å€¤:
  //   - ç›´å¾Œã® /api/sync/state ãŒã€Œç©ºèµ·ç‚¹ï¼ˆæœªä½œæˆ/empty template ç­‰ï¼‰ã€ã§è¿”ã‚‹ã“ã¨ã€‚
  //
  // UIéçµ„ã¿è¾¼ã¿ç†ç”±:
  //   - â€œæŠ¼ã—é–“é•ã„â€ ã‚„ â€œèª¤çˆ†â€ ãŒèµ·ããŸæ™‚ç‚¹ã§ã‚¢ã‚¦ãƒˆãªã®ã§ã€
  //     UIï¼ˆãƒœã‚¿ãƒ³ç­‰ï¼‰ã«ã¯çµ¶å¯¾ã«å…¥ã‚Œãªã„ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç›´è²¼ã‚Šã®å˜ç™ºå®Ÿè¡Œã«é™å®šã™ã‚‹ã€‚
  // ============================================================================

  // å®Œå…¨å‰Šé™¤ APIï¼ˆfunctions/api/sync/completely_delete.ts ã«å¯¾å¿œï¼‰
  //   - POST ã™ã‚‹ã¨ KV ã® `sync:${user}` ã‚’ delete ã—ã€æ®‹éª¸ã‚’ 100% æ’é™¤ã™ã‚‹æƒ³å®š
  var DELETE_ENDPOINT = "/api/sync/completely_delete";

  // state å–å¾— APIï¼ˆfunctions/api/sync/state.ts ã«å¯¾å¿œï¼‰
  //   - delete ç›´å¾Œã« GET ã—ã¦ã€Œç©ºèµ·ç‚¹ï¼ˆstateæœªä½œæˆ/ç©ºãƒ†ãƒ³ãƒ—ãƒ¬ç­‰ï¼‰ã«ãªã£ãŸã‹ã€ã‚’ç¢ºèªã™ã‚‹
  var STATE_ENDPOINT = "/api/sync/state";

  // ç¾åœ¨æ™‚åˆ»ã‚’ ISO æ–‡å­—åˆ—ã§è¿”ã™ï¼ˆãƒ­ã‚°ã«æ¯å›åŒã˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ä»˜ã‘ã‚‹ãŸã‚ï¼‰
  function now() {
    return new Date().toISOString();
  }

  // ============================================================================
  // ãƒ­ã‚°å‡ºåŠ›ãƒ˜ãƒ«ãƒ‘
  //   - log/warn/error ã‚’çµ±ä¸€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§å‡ºã™
  //   - ã©ã®å®Ÿè¡Œãƒ­ã‚°ã‹ä¸€ç›®ã§åˆ†ã‹ã‚‹ã‚ˆã†ã« prefix ã« [CSCS][COMPLETELY_DELETE][timestamp] ã‚’ä»˜ä¸
  // ============================================================================

  function logLine() {
    // arguments ã‚’é…åˆ—ã«å¤‰æ›ï¼ˆconsole.log ã«å¯å¤‰å¼•æ•°ã§æ¸¡ã™ãŸã‚ï¼‰
    var args = Array.prototype.slice.call(arguments);

    // å…ˆé ­ã«å…±é€šãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å·®ã—è¾¼ã‚€
    args.unshift("[CSCS][COMPLETELY_DELETE][" + now() + "]");

    // console.log ã«ãã®ã¾ã¾æµã™
    console.log.apply(console, args);
  }

  function warnLine() {
    var args = Array.prototype.slice.call(arguments);
    args.unshift("[CSCS][COMPLETELY_DELETE][" + now() + "]");
    console.warn.apply(console, args);
  }

  function errLine() {
    var args = Array.prototype.slice.call(arguments);
    args.unshift("[CSCS][COMPLETELY_DELETE][" + now() + "]");
    console.error.apply(console, args);
  }

  // ============================================================================
  // JSON ã£ã½ã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å®‰å…¨ãƒ‘ãƒ¼ã‚¹
  //   - /api å´ãŒ JSON ã‚’è¿”ã™æƒ³å®šã ãŒã€ã‚¨ãƒ©ãƒ¼HTMLã‚„ãƒ†ã‚­ã‚¹ãƒˆãŒè¿”ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹
  //   - ä¾‹å¤–ã§è½ã¨ã•ãšã€ã€ŒJSONã¨ã—ã¦èª­ã‚ãŸã‹ã©ã†ã‹ã€ã‚’ ok ãƒ•ãƒ©ã‚°ã§è¿”ã™
  // ============================================================================

  function safeJsonParse(text) {
    try {
      // JSON ã¨ã—ã¦è§£é‡ˆã§ãã‚Œã° ok=true ã¨ã—ã¦è¿”ã™
      return { ok: true, json: JSON.parse(text) };
    } catch (e) {
      // JSON ã§ã¯ãªã„å ´åˆã§ã‚‚ã€raw æ–‡å­—åˆ—ã‚’ä¿æŒã—ã¦å‘¼ã³å‡ºã—å´ã§è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
      return { ok: false, error: e, text: text };
    }
  }

  // ============================================================================
  // ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ•´å½¢å‡ºåŠ›
  //   - status / ä¸€éƒ¨ãƒ˜ãƒƒãƒ€ / bodyï¼ˆJSONãªã‚‰ãƒ‘ãƒ¼ã‚¹çµæœã€éJSONãªã‚‰ç”Ÿãƒ†ã‚­ã‚¹ãƒˆï¼‰ã‚’ã¾ã¨ã‚ã¦ãƒ­ã‚°å‡ºã—
  //   - x-cscs-isemptytemplate:
  //       state.ts ãŒ empty template ã‚’è¿”ã—ãŸæ™‚ã«ä»˜ä¸ã—ã¦ã„ã‚‹æƒ³å®šã®åˆ¤å®šç”¨ãƒ˜ãƒƒãƒ€
  //   - x-cscs-reset:
  //       ã‚‚ã— reset ç³»ã§ä»˜ä¸ã—ã¦ã„ã‚‹ãƒ˜ãƒƒãƒ€ãŒã‚ã‚Œã°ç¢ºèªç”¨ï¼ˆç„¡ã„ãªã‚‰ null ã«ãªã‚‹ï¼‰
  // ============================================================================

  function printResponse(prefix, res, bodyText) {
    // HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆ200/401/500ãªã©ï¼‰ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤º
    logLine(prefix + " status =", res.status, res.statusText);

    // ãƒ‡ãƒãƒƒã‚°ã§ â€œè¿”ã£ã¦ããŸç¨®é¡â€ ã‚’åˆ¤åˆ¥ã—ã‚„ã™ã„ãƒ˜ãƒƒãƒ€ã ã‘æŠœãå‡ºã—ã¦è¡¨ç¤º
    logLine(prefix + " headers =", {
      "content-type": res.headers.get("content-type"),
      "x-cscs-isemptytemplate": res.headers.get("x-cscs-isemptytemplate"),
      "x-cscs-reset": res.headers.get("x-cscs-reset")
    });

    // ãƒœãƒ‡ã‚£ã‚’ JSON ã¨ã—ã¦èª­ã‚ã‚‹ã‹è©¦ã™ï¼ˆèª­ã‚ãªã„å ´åˆã§ã‚‚è½ã¨ã•ãªã„ï¼‰
    var parsed = safeJsonParse(bodyText);
    if (parsed.ok) {
      // JSON ãªã‚‰ãã®ã¾ã¾ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‡ºã™ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å±•é–‹ã§ãã‚‹ï¼‰
      logLine(prefix + " json =", parsed.json);
    } else {
      // JSON ã§ãªã‘ã‚Œã°ã€è¿”ã£ã¦ããŸç”Ÿãƒ†ã‚­ã‚¹ãƒˆã‚’ warn ã¨ã—ã¦å‡ºã™
      // ï¼ˆä¾‹ï¼šUnauthorized ã® HTMLã€Cloudflare ã®ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ç­‰ï¼‰
      warnLine(prefix + " body is not JSON. raw =", parsed.text);
    }
  }

  // ============================================================================
  // 1) å®Œå…¨å‰Šé™¤ API ã‚’å©ã
  //   - POST /api/sync/completely_delete
  //   - body ã¯ã‚µãƒ¼ãƒå´ã§ç„¡è¦–ã•ã‚Œã‚‹æƒ³å®šã ãŒã€å‘¼ã³å‡ºã—å…ƒè­˜åˆ¥ç”¨ã« from/t ã‚’ä»˜ä¸
  //   - res.ok ãŒ falseï¼ˆ4xx/5xxï¼‰ãªã‚‰ä¾‹å¤–ã‚’æŠ•ã’ã¦ run() ã‚’å¤±æ•—æ‰±ã„ã«ã™ã‚‹
  // ============================================================================

  async function doPostDelete() {
    logLine("POST start ->", DELETE_ENDPOINT);

    // å®Œå…¨å‰Šé™¤ã‚’å®Ÿè¡Œï¼ˆåŒä¸€ã‚ªãƒªã‚¸ãƒ³ fetchï¼‰
    // content-type ã‚’ JSON ã«ã—ã€body ã¯ â€œãŸã ã®å®Ÿè¡Œãƒ¡ã‚¿â€ ã¨ã—ã¦é€ã‚‹
    var res = await fetch(DELETE_ENDPOINT, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ from: "console", t: Date.now() })
    });

    // body ã‚’ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦èª­ã¿å–ã‚‹ï¼ˆJSONã§ã‚‚ãƒ†ã‚­ã‚¹ãƒˆã§å—ã‘ã¦ã‹ã‚‰å®‰å…¨ã«ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ï¼‰
    var bodyText = await res.text();

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ãƒ˜ãƒƒãƒ€ãƒ»ãƒœãƒ‡ã‚£ã‚’æ•´å½¢ã—ã¦ãƒ­ã‚°è¡¨ç¤º
    printResponse("DELETE", res, bodyText);

    // HTTPçš„ã«å¤±æ•—ãªã‚‰ run() ã‚’æ­¢ã‚ãŸã„ã®ã§ä¾‹å¤–åŒ–
    if (!res.ok) {
      throw new Error("DELETE failed: " + res.status + " " + res.statusText);
    }

    logLine("POST done ->", DELETE_ENDPOINT);
    return true;
  }

  // ============================================================================
  // 2) state å–å¾— API ã‚’å©ãï¼ˆå‰Šé™¤å¾Œã®ç¢ºèªï¼‰
  //   - GET /api/sync/state
  //   - å‰Šé™¤ç›´å¾Œãªã®ã§ã€ã“ã“ã§è¿”ã‚‹å†…å®¹ãŒ â€œç©ºèµ·ç‚¹â€ ã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒæœŸå¾…å€¤
  //   - ã“ã“ã‚‚ res.ok=false ãªã‚‰ä¾‹å¤–ã«ã—ã¦ run() ã‚’å¤±æ•—æ‰±ã„ã«ã™ã‚‹
  // ============================================================================

  async function doGetState() {
    logLine("GET start ->", STATE_ENDPOINT);

    // state ã‚’å–å¾—ï¼ˆåŒä¸€ã‚ªãƒªã‚¸ãƒ³ fetchï¼‰
    var res = await fetch(STATE_ENDPOINT, { method: "GET" });

    // body ã‚’ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦èª­ã¿å–ã£ã¦å®‰å…¨ãƒ‘ãƒ¼ã‚¹
    var bodyText = await res.text();

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ãƒ˜ãƒƒãƒ€ãƒ»ãƒœãƒ‡ã‚£ã‚’æ•´å½¢ãƒ­ã‚°è¡¨ç¤º
    printResponse("STATE", res, bodyText);

    // HTTPçš„ã«å¤±æ•—ãªã‚‰ run() ã‚’æ­¢ã‚ã‚‹
    if (!res.ok) {
      throw new Error("STATE failed: " + res.status + " " + res.statusText);
    }

    logLine("GET done ->", STATE_ENDPOINT);
    return true;
  }

  // ============================================================================
  // å®Ÿè¡Œã‚·ãƒ¼ã‚±ãƒ³ã‚¹ï¼ˆã“ã®IIFEã®â€œæœ¬ä½“â€ï¼‰
  //   - delete â†’ stateç¢ºèª ã®é †ã§ç›´åˆ—å®Ÿè¡Œ
  //   - ã©ã¡ã‚‰ã‹ãŒå¤±æ•—ã—ãŸã‚‰ catch ã«è½ã¨ã—ã¦ error ãƒ­ã‚°ã‚’å‡ºã™
  // ============================================================================

  async function run() {
    logLine("RUN begin");

    // â‘  KVã®å®Œå…¨å‰Šé™¤ã‚’å®Ÿè¡Œ
    await doPostDelete();

    // â‘¡ ç›´å¾Œã« state ã‚’èª­ã¿ã€ç©ºèµ·ç‚¹ã«æˆ»ã£ãŸã‹ã‚’ç¢ºèª
    await doGetState();

    logLine("RUN done (delete -> state check)");
  }

  // run() ã‚’é–‹å§‹ã—ã€å¤±æ•—æ™‚ã¯ stack ã‚’å«ã‚ã¦è¡¨ç¤ºï¼ˆstack ãŒç„¡ã‘ã‚Œã°å€¤ãã®ã¾ã¾ï¼‰
  run().catch(function (e) {
    errLine("RUN failed:", e && e.stack ? e.stack : e);
  });
})();