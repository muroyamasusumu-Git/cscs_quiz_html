{
  "session_id": "CSCSJS-06411020",
  "created_at": "2026-01-02T16:29:03",
  "instruction": "【WORK_HEADER（共通ID）】\n[SESSION_ID: CSCSJS-06411020]\n[REQUEST_ID: REQ-67497901]\n\n【USER_INSTRUCTION】\n手動送信ボタン(cscs_sync_view_b_send_btn)の表示と自動クリックの処理部分を　「ボタンの表示（DOM生成＋append）」もふくめ全て抜き出して他のjsに移動させる\n\n【FUNCTION_WHOLE】 createPanel\nFOUND: true\nHEADER: EXTRACT_FUNCTION: createPanel (chars 70392..78597)\nSHA256: d02d1eeee3271404ef34d3119278f54f583c1bc9548444f648ea862e2ae010b9\n```javascript\n  function createPanel() {\n    var box = document.createElement(\"div\");\n    box.id = \"cscs_sync_view_b\";\n\n    var title = document.createElement(\"div\");\n    title.id = \"cscs_sync_view_b_title\";\n    title.textContent = \"SYNC(B): \" + info.qid;\n\n    var body = document.createElement(\"div\");\n    body.id = \"cscs_sync_view_b_body\";\n    body.textContent = \"読み込み中…\";\n\n    var statusDiv = document.createElement(\"div\");\n    statusDiv.id = \"cscs_sync_view_b_status\";\n\n    // ★【超重要仕様：このボタンは「削除禁止」】\n    //   - DOM 上に存在していることが絶対条件（ID変更も禁止）。\n    //   - setTimeout(... btn.click()) のターゲットでもある。\n    //   - ここでは「手動送信用に表示」するが、DOM/ID/ボタン形状は維持すること。\n    var btn = document.createElement(\"button\");\n    btn.id = \"cscs_sync_view_b_send_btn\";\n    btn.type = \"button\";\n    btn.textContent = \"SYNC送信\";\n    btn.className = \"cscs-svb-send-btn\";\n\n    // ★ 手動送信ボタンが押されたら「直近が手動送信である」ことを記録する\n    //   - sendDiffToServer 側でこのフラグを見て「差分ゼロでも必ず送信」に切り替える\n    //   - ここでは“送信処理そのもの”は触らない（既存のクリック処理と共存させる）\n    //   - 追加: ボタン押下直後に /api/sync/state を取り直して HUD を即時再描画し、\n    //          パネル内の全値が「押した瞬間に更新された」ことを保証する（ログで確認可能）\n    btn.addEventListener(\"click\", function () {\n      try {\n        window.__cscs_sync_b_manual_send_ts = Date.now();\n      } catch (_eManual) {}\n\n      // ★ 何をしているか:\n      //   1) 最新 state を取得して window.__cscs_sync_state を更新\n      //   2) state + localStorage から「今この瞬間の」表示用payloadを再構築\n      //   3) renderPanel() を呼び、ステータスパネル内の全値をまとめて更新\n      (function refreshHudAllValuesAfterManualSendClick() {\n        var qid = info.qid;\n\n        console.log(\"[SYNC-B:view] manual send clicked → refresh HUD start\", {\n          qid: qid,\n          ts: (function () { try { return window.__cscs_sync_b_manual_send_ts || 0; } catch (_e) { return 0; } })()\n        });\n\n        fetchState().then(function (st) {\n          try {\n            window.__cscs_sync_state = st;\n          } catch (_eAssign) {}\n\n          console.log(\"[SYNC-B:view] fetchState success → window.__cscs_sync_state updated\", {\n            qid: qid,\n            hasState: !!st\n          });\n\n          // ★ 何をしているか:\n          //   server値（SYNC側）を state から拾う（無ければ 0 / \"-\"）\n          var serverCorrect = 0;\n          var serverWrong = 0;\n          var serverStreak3 = 0;\n          var serverStreakLen = 0;\n          var serverStreak3Wrong = 0;\n          var serverWrongStreakLen = 0;\n\n          try {\n            if (st && st.correct && typeof st.correct === \"object\" && st.correct[qid] != null) {\n              if (typeof st.correct[qid] === \"number\" && Number.isFinite(st.correct[qid]) && st.correct[qid] >= 0) {\n                serverCorrect = st.correct[qid];\n              }\n            }\n            if (st && st.incorrect && typeof st.incorrect === \"object\" && st.incorrect[qid] != null) {\n              if (typeof st.incorrect[qid] === \"number\" && Number.isFinite(st.incorrect[qid]) && st.incorrect[qid] >= 0) {\n                serverWrong = st.incorrect[qid];\n              }\n            }\n            if (st && st.streak3 && typeof st.streak3 === \"object\" && st.streak3[qid] != null) {\n              if (typeof st.streak3[qid] === \"number\" && Number.isFinite(st.streak3[qid]) && st.streak3[qid] >= 0) {\n                serverStreak3 = st.streak3[qid];\n              }\n            }\n            if (st && st.streakLen && typeof st.streakLen === \"object\" && st.streakLen[qid] != null) {\n              if (typeof st.streakLen[qid] === \"number\" && Number.isFinite(st.streakLen[qid]) && st.streakLen[qid] >= 0) {\n                serverStreakLen = st.streakLen[qid];\n              }\n            }\n            if (st && st.streak3Wrong && typeof st.streak3Wrong === \"object\" && st.streak3Wrong[qid] != null) {\n              if (typeof st.streak3Wrong[qid] === \"number\" && Number.isFinite(st.streak3Wrong[qid]) && st.streak3Wrong[qid] >= 0) {\n                serverStreak3Wrong = st.streak3Wrong[qid];\n              }\n            }\n            if (st && st.streakWrongLen && typeof st.streakWrongLen === \"object\" && st.streakWrongLen[qid] != null) {\n              if (typeof st.streakWrongLen[qid] === \"number\" && Number.isFinite(st.streakWrongLen[qid]) && st.streakWrongLen[qid] >= 0) {\n                serverWrongStreakLen = st.streakWrongLen[qid];\n              }\n            }\n          } catch (eSrvPick) {\n            console.error(\"[SYNC-B:view] refresh pick server values error:\", eSrvPick);\n          }\n\n          // ★ 何をしているか:\n          //   local値（ローカル側）を localStorage から拾う（確定キーのみ）\n          var localCorrect = readIntFromLocalStorage(\"cscs_q_correct_total:\" + qid);\n          var localWrong = readIntFromLocalStorage(\"cscs_q_wrong_total:\" + qid);\n          var localStreak3 = readIntFromLocalStorage(\"cscs_q_correct_streak3_total:\" + qid);\n          var localStreakLen = readIntFromLocalStorage(\"cscs_q_correct_streak_len:\" + qid);\n          var localStreak3Wrong = readIntFromLocalStorage(\"cscs_q_wrong_streak3_total:\" + qid);\n          var localWrongStreakLen = readIntFromLocalStorage(\"cscs_q_wrong_streak_len:\" + qid);\n\n          // ★ 何をしているか:\n          //   diff（local - server）を計算（マイナスは 0 に丸める）\n          var diffCorrect = Math.max(0, localCorrect - serverCorrect);\n          var diffWrong = Math.max(0, localWrong - serverWrong);\n          var diffStreak3 = Math.max(0, localStreak3 - serverStreak3);\n          var diffStreakLen = Math.max(0, localStreakLen - serverStreakLen);\n          var diffStreak3Wrong = Math.max(0, localStreak3Wrong - serverStreak3Wrong);\n          var diffWrongStreakLen = Math.max(0, localWrongStreakLen - serverWrongStreakLen);\n\n          // ★ 何をしているか:\n          //   Pending（未送信っぽい差分）を再計算して payload に載せる\n          var pending = null;\n          try {\n            pending = computePendingFlags(st, qid);\n          } catch (_ePending) {\n            pending = null;\n          }\n\n          console.log(\"[SYNC-B:view] manual send clicked → refresh HUD computed\", {\n            qid: qid,\n            serverCorrect: serverCorrect,\n            serverWrong: serverWrong,\n            localCorrect: localCorrect,\n            localWrong: localWrong,\n            diffCorrect: diffCorrect,\n            diffWrong: diffWrong,\n            serverStreak3: serverStreak3,\n            localStreak3: localStreak3,\n            diffStreak3: diffStreak3,\n            serverStreakLen: serverStreakLen,\n            localStreakLen: localStreakLen,\n            diffStreakLen: diffStreakLen,\n            serverStreak3Wrong: serverStreak3Wrong,\n            localStreak3Wrong: localStreak3Wrong,\n            diffStreak3Wrong: diffStreak3Wrong,\n            serverWrongStreakLen: serverWrongStreakLen,\n            localWrongStreakLen: localWrongStreakLen,\n            diffWrongStreakLen: diffWrongStreakLen,\n            pending: pending\n          });\n\n          // ★ 何をしているか:\n          //   renderPanel() に payload を渡して「パネル内の全値」をまとめて更新\n          renderPanel(box, {\n            serverCorrect: serverCorrect,\n            serverWrong: serverWrong,\n            localCorrect: localCorrect,\n            localWrong: localWrong,\n            diffCorrect: diffCorrect,\n            diffWrong: diffWrong,\n            serverStreak3: serverStreak3,\n            localStreak3: localStreak3,\n            diffStreak3: diffStreak3,\n            serverStreakLen: serverStreakLen,\n            localStreakLen: localStreakLen,\n            diffStreakLen: diffStreakLen,\n            serverStreak3Wrong: serverStreak3Wrong,\n            localStreak3Wrong: localStreak3Wrong,\n            diffStreak3Wrong: diffStreak3Wrong,\n            serverWrongStreakLen: serverWrongStreakLen,\n            localWrongStreakLen: localWrongStreakLen,\n            diffWrongStreakLen: diffWrongStreakLen,\n            statusText: \"manual click → HUD refreshed\",\n            pending: pending,\n            odoaStatusText: \"__keep__\"\n          });\n\n          console.log(\"[SYNC-B:view] manual send clicked → refresh HUD done\", {\n            qid: qid\n          });\n        }).catch(function (e) {\n          console.error(\"[SYNC-B:view] manual send clicked → fetchState failed:\", e);\n        });\n      })();\n    });\n\n    box.appendChild(title);\n    box.appendChild(body);\n    box.appendChild(statusDiv);\n    // ★ 非表示ボタンだが、DOM に必ず追加することで click() 自動発火のターゲットを保証する。\n    box.appendChild(btn);\n\n    return box;\n  }\n```\n【CONTEXT】 createPanel\nHITS: 2\nLINES: ±25\nMAX_MATCHES: 50\n\nHEADER: EXTRACT_CONTEXT: 'createPanel' hit_line=2184 range_lines=2159..2209\nSHA256: 6d59ea5f65541835d113d3f158be5c4ecfcc4eceefb308225421454012e40be9\n```javascript\n      // フォールバック禁止:\n      //   bootstrap 完了後にも key が無い場合は「異常」として即失敗させる\n      if (!key) {\n        console.error(\"[SYNC-B:view] X-CSCS-Key missing AFTER bootstrap → fetchState aborted\", {\n          endpoint: SYNC_STATE_ENDPOINT\n        });\n        throw new Error(\"X-CSCS-Key missing after bootstrap\");\n      }\n\n      return fetch(SYNC_STATE_ENDPOINT, {\n        method: \"GET\",\n        cache: \"no-store\",\n        credentials: \"include\",\n        headers: {\n          \"X-CSCS-Key\": key\n        }\n      });\n    }).then(function (res) {\n      if (!res.ok) {\n        throw new Error(String(res.status));\n      }\n      return res.json();\n    });\n  }\n\n  function createPanel() {\n    var box = document.createElement(\"div\");\n    box.id = \"cscs_sync_view_b\";\n\n    var title = document.createElement(\"div\");\n    title.id = \"cscs_sync_view_b_title\";\n    title.textContent = \"SYNC(B): \" + info.qid;\n\n    var body = document.createElement(\"div\");\n    body.id = \"cscs_sync_view_b_body\";\n    body.textContent = \"読み込み中…\";\n\n    var statusDiv = document.createElement(\"div\");\n    statusDiv.id = \"cscs_sync_view_b_status\";\n\n    // ★【超重要仕様：このボタンは「削除禁止」】\n    //   - DOM 上に存在していることが絶対条件（ID変更も禁止）。\n    //   - setTimeout(... btn.click()) のターゲットでもある。\n    //   - ここでは「手動送信用に表示」するが、DOM/ID/ボタン形状は維持すること。\n    var btn = document.createElement(\"button\");\n    btn.id = \"cscs_sync_view_b_send_btn\";\n    btn.type = \"button\";\n    btn.textContent = \"SYNC送信\";\n    btn.className = \"cscs-svb-send-btn\";\n\n```\n\nHEADER: EXTRACT_CONTEXT: 'createPanel' hit_line=4628 range_lines=4603..4653\nSHA256: d7e24c7117f6ac7e83c672a7eea1bc538c9a618edd833b57fb7d7a1d85e5fe2c\n```javascript\n    //   once/odoa 系カードを一旦 visibility:hidden にしておく（移動・整理が終わったら解除する）\n    function ensureOnceOdoaNoFlashStyle() {\n      try {\n        var id = \"cscs_sync_view_b_once_odoa_no_flash\";\n        if (document.getElementById(id)) return;\n        var st = document.createElement(\"style\");\n        st.id = id;\n        st.type = \"text/css\";\n        st.textContent =\n          \"#cscs_sync_view_b_status .svb-once-odoa-card{display:none !important;}\" +\n          \"#cscs_sync_view_b_status .svb-once-odoa-card-local{display:none !important;}\";\n        document.head.appendChild(st);\n      } catch (_e) {}\n    }\n\n    function clearOnceOdoaNoFlashStyle() {\n      try {\n        var id = \"cscs_sync_view_b_once_odoa_no_flash\";\n        var st = document.getElementById(id);\n        if (st && st.parentNode) st.parentNode.removeChild(st);\n      } catch (_e) {}\n    }\n\n    ensureOnceOdoaNoFlashStyle();\n\n    var box = createPanel();\n\n    function append() {\n      var wrap = document.querySelector(\"div.wrap\");\n      if (wrap) {\n        if (!wrap.contains(box)) {\n          wrap.appendChild(box);\n        }\n      } else {\n        if (!document.body.contains(box)) {\n          document.body.appendChild(box);\n        }\n      }\n\n      // ★ 何をしているか:\n      //   既存(SYNC)カードの見出しを \"(SYNC)\" にし、直下に local専用カードを追加する\n      ensureOnceOdoaWideTitles(box);\n      ensureLocalOnceOdoaWideCard(box);\n\n      // ★ 何をしているか:\n      //   once/odoa 系カードの移動・整理が完了したので、チラつき防止の非表示を解除する\n      try {\n        var id = \"cscs_sync_view_b_once_odoa_no_flash\";\n        var st = document.getElementById(id);\n        if (st && st.parentNode) st.parentNode.removeChild(st);\n      } catch (_eNF) {}\n\n```\n\n<<<EXTRACT_END>>>\n",
  "work": {
    "project_id": "",
    "task_id": "",
    "request_id": "REQ-67497901"
  },
  "input": {
    "filename": "cscs_sync_view_b.js",
    "size_chars": 181685,
    "sha256": "06411020ecfc9e75977e34d0b4924e45825eb5c03f03b9c70694bb5f3c90c28a",
    "saved_copy": "original/cscs_sync_view_b.js"
  },
  "split": {
    "total_parts": 5,
    "max_chars_per_part": 60000,
    "max_lines_per_part": 1200,
    "strategy": "split_on_newline_preferably_else_hard"
  },
  "parts": [
    {
      "index": 1,
      "total": 5,
      "part_id": "CSCSJS-06411020-P01-of-05",
      "part_sha256": "786ec4ac1ac68c0a808948f11176946106281a4f49f0026f57b36444970347cd",
      "start_offset": 0,
      "end_offset": 33950,
      "len_chars": 33950,
      "file": "parts/part_01.txt"
    },
    {
      "index": 2,
      "total": 5,
      "part_id": "CSCSJS-06411020-P02-of-05",
      "part_sha256": "427de3234f4263ab3d6174778368ef9b19bf4748a07e466d54c42124fc8ce912",
      "start_offset": 33950,
      "end_offset": 70393,
      "len_chars": 36443,
      "file": "parts/part_02.txt"
    },
    {
      "index": 3,
      "total": 5,
      "part_id": "CSCSJS-06411020-P03-of-05",
      "part_sha256": "64acda52f2942ebc63b21bc58eea9394b427705864a5053b283d35c1066c7118",
      "start_offset": 70393,
      "end_offset": 117190,
      "len_chars": 46797,
      "file": "parts/part_03.txt"
    },
    {
      "index": 4,
      "total": 5,
      "part_id": "CSCSJS-06411020-P04-of-05",
      "part_sha256": "9e03a29bf460a115d90b94de986453d278715c7021b2a595da7df1bd7c982ce8",
      "start_offset": 117190,
      "end_offset": 159276,
      "len_chars": 42086,
      "file": "parts/part_04.txt"
    },
    {
      "index": 5,
      "total": 5,
      "part_id": "CSCSJS-06411020-P05-of-05",
      "part_sha256": "0b90b86617f34827a25b3e751ba416d44579bef022d717addb5739ccaedf17b8",
      "start_offset": 159276,
      "end_offset": 181685,
      "len_chars": 22409,
      "file": "parts/part_05.txt"
    }
  ]
}