<<<PART_BEGIN>>>
ã€åˆ†å‰²ã‚³ãƒ¼ãƒ‰(1)ã®é–‹å§‹ã€‘
PartID: CSCSJS-AE8739D4-P01-of-04
PartSHA256: 207cb7c2cc2148c941f850e879c6be773c677c93ecd279792f4d889265d72ac9
Range: chars 0..43797 (len=43797)
FirstLine: // assets/cscs_sync_a.js
LastLine:         if (lastdaySummarySyncEl) {
EndNewline: YES

ã€ãƒ—ãƒ­ãƒˆã‚³ãƒ«å®£è¨€ï¼ˆPART_01=å®£è¨€ / LAST_PART=EXEC_TASKï¼‰ã€‘
SessionID: CSCSJS-AE8739D4
TargetFile: cscs_sync_a.js
Split: total_parts=4, max_chars_per_part=60000, max_lines_per_part=1200

ã€ã‚ãªãŸï¼ˆChatGPTï¼‰ã¸ã®æœ€é‡è¦ãƒ«ãƒ¼ãƒ«ï¼ˆå³å®ˆï¼‰ã€‘
0) åˆ†å‰²ã‚³ãƒ¼ãƒ‰å—é ˜ä¸­ã¯ã€å†…å®¹ã®è§£é‡ˆãƒ»è¦ç´„ãƒ»æ¨æ¸¬ãƒ»ä¿®æ­£æ¡ˆæç¤ºã‚’ä¸€åˆ‡ç¦æ­¢ã€‚
1) åˆ†å‰²ã‚³ãƒ¼ãƒ‰(1..N-1)å—é ˜æ™‚ã®è¿”ç­”ã¯å¿…ãšï¼š
   ACK: <PartID> / WAITING_NEXT
2) æœ€çµ‚åˆ†å‰²ã‚³ãƒ¼ãƒ‰(N)å—é ˜æ™‚ã¯ã€æœ«å°¾ã® RECEIPT_INPUT ã‚’ç”¨ã„ã¦å—é ˜ç¢ºèªã‚’å®Ÿæ–½ã™ã‚‹ã“ã¨ã€‚
3) å—é ˜ç¢ºèªã¯ã€æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã® CUMULATIVE_RECEIVED_PARTIDS ã¨ EXPECTED_PARTIDS ã®ã¿ã‚’ä½¿ç”¨ï¼ˆä¼šè©±å±¥æ­´å‚ç…§ã¯ç¦æ­¢ï¼‰ã€‚
4) å®Ÿè¡ŒæŒ‡ç¤ºï¼ˆEXEC_TASKï¼‰ã¯ã€æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã® EXEC_TASKã€ã®ã¿ã‚’çœŸã¨ã™ã‚‹ã€‚PART_01ã®æ–‡ã¯å‚è€ƒã§ã‚ã‚Šå®Ÿè¡Œæ ¹æ‹ ã«ã—ãªã„ã€‚
5) RECEIPT_CHECK: OK ã®åŒä¸€è¿”ä¿¡å†…ã§ã€JOIN_READY/JOIN_ACTION/EXEC_START ã‚’å¿…ãšå‡ºåŠ›ã—ã€ç›´ã¡ã« EXEC_TASK ã‚’å®Ÿè¡Œã™ã‚‹ã€‚
6) JOINï¼ˆé€£çµï¼‰ãƒ«ãƒ¼ãƒ«ï¼ˆå¼·åˆ¶ï¼‰:
   - åˆ†å‰²ã‚³ãƒ¼ãƒ‰ã‚’é€£çµã—ã¦â€œå®Œå…¨ãªJSâ€ã‚’ä½œã‚‹éš›ã€ãƒ‘ãƒ¼ãƒˆå¢ƒç•Œã«æ”¹è¡Œã‚„ç©ºç™½ã‚’å‹æ‰‹ã«è¿½åŠ ã—ã¦ã¯ãªã‚‰ãªã„ã€‚
   - å„ãƒ‘ãƒ¼ãƒˆæœ¬æ–‡ã¯ã€æç¤ºã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’ãã®ã¾ã¾ã€é€£çµã™ã‚‹ï¼ˆãƒ‘ãƒ¼ãƒˆé–“ã«æš—é»™ã®æ”¹è¡Œã¯å­˜åœ¨ã—ãªã„ï¼‰ã€‚
   - ã—ãŸãŒã£ã¦ã€åˆ†å‰²ã‚³ãƒ¼ãƒ‰åŒå£«ã®é–“ã«æ”¹è¡Œã®æ˜è¨˜ãŒç„¡ã„é™ã‚Šã¯ã€å¿…ãšé€£ç¶šè¡Œã¨ã—ã¦èª­ã¿å–ã‚‹ã€ã“ã¨ã€‚
   - å„ãƒ‘ãƒ¼ãƒˆã«ã¯ EndNewline: YES/NO ãŒä»˜ãã€‚å¢ƒç•ŒãŒé€£ç¶šè¡Œã‹ã©ã†ã‹ã¯ã“ã‚Œã‚’å”¯ä¸€ã®æ ¹æ‹ ã¨ã—ã¦åˆ¤å®šã™ã‚‹ã€‚

ã€æŒ‡ç¤ºå†…å®¹ï¼ˆæ¦‚è¦ï¼šå‚è€ƒç”¨ï¼å®Ÿè¡Œæ ¹æ‹ ã«ã—ãªã„ï¼‰ã€‘
æ­£è§£ã®å½¢ï¼š
1.syncKey ã‚’ç¢ºå®šï¼ˆtrimæ¨å¥¨ï¼‰
2.if (!syncKey) return;
3.ãã®å¾Œã«ãƒ­ã‚°ï¼‹fetch

ã€åˆ†å‰²ã‚³ãƒ¼ãƒ‰è²¼ã‚Šä»˜ã‘é–‹å§‹ã€‘
ä»¥é™ã¯åˆ†å‰²ã‚³ãƒ¼ãƒ‰æœ¬æ–‡ã€‚ä¸Šè¨˜ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦å—é ˜ãƒ»ç…§åˆãƒ»å®Ÿè¡Œã›ã‚ˆã€‚

```javascript
// assets/cscs_sync_a.js
/**
 * CSCS SYNC(A) â€” Aãƒ‘ãƒ¼ãƒˆç”¨ SYNC ãƒ¢ãƒ‹ã‚¿ï¼†é€ä¿¡ã‚­ãƒ¥ãƒ¼
 *
 * ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ä½¿ç”¨ã™ã‚‹ LocalStorage / SYNC(JSON) / payload ã®
 * ã‚­ãƒ¼å¯¾å¿œè¡¨ã‚’ã“ã“ã«ä¸€è¦§ã™ã‚‹ã€‚
 *
 * ã€é‡è¦ï¼šé–‹ç™ºãƒ«ãƒ¼ãƒ«ï¼ˆæ’ä¹…ï¼‰ã€‘
 *   ğŸ“Œ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«å†…ã§ LocalStorage / SYNC / payload ã®ã‚­ãƒ¼åã«
 *       ã€Œå¤‰æ›´ã€ã¾ãŸã¯ã€Œæ–°è¦è¿½åŠ ã€ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€
 *       å¿…ãš **ã“ã®ã‚­ãƒ¼å¯¾å¿œè¡¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã™ã‚‹ã“ã¨**ã€‚
 *
 *   - b_judge_record.jsãƒ»SYNC Workerï¼ˆmerge/state.tsï¼‰å´ã¨
 *     ã‚­ãƒ¼ä»•æ§˜ã®ä¸æ•´åˆãŒç”Ÿã˜ã‚‹ã“ã¨ã‚’é˜²ãç›®çš„ã€‚
 *   - ã“ã“ã«æ›¸ã‹ã‚Œã¦ã„ãªã„ã‚­ãƒ¼ã¯åŸå‰‡ã¨ã—ã¦ä½¿ç”¨ç¦æ­¢ã€‚
 *
  * â–¼ LocalStorage ã‚­ãƒ¼
 *   - "cscs_fav"
 *   - "cscs_fav_map"
 *   - "cscs_results"
 *   - "cscs_wrong_log"
 *   - "cscs_q_correct_total:" + qid      // b_judge_record.js ç”±æ¥ã®å•é¡Œåˆ¥ã€Œæ­£è§£ã€ç´¯è¨ˆ
 *   - "cscs_q_wrong_total:"   + qid      // b_judge_record.js ç”±æ¥ã®å•é¡Œåˆ¥ã€Œä¸æ­£è§£ã€ç´¯è¨ˆ
 *   - "cscs_exam_date"                    // è©¦é¨“æ—¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨
 *   - "cscs_sync_key"                     // SYNC state å–å¾—ã«ä½¿ã†ã‚­ãƒ¼ï¼ˆX-CSCS-Keyï¼‰
 *
 * â–¼ å•é¡Œåˆ¥ç´¯è¨ˆï¼ˆæ­£è§£ / ä¸æ­£è§£ï¼‰
 *   - localStorage:
 *       "cscs_q_correct_total:" + qid
 *       "cscs_q_wrong_total:"   + qid
 *   - SYNC state:
 *       state.correct[qid]
 *       state.incorrect[qid]
 *   - payload(merge):
 *       correctDelta[qid]
 *       incorrectDelta[qid]
 *
 * â–¼ å•é¡Œåˆ¥ 3 é€£ç¶šæ­£è§£ï¼ˆâ­ï¸ç”¨ï¼‰
 *   - localStorage:
 *       "cscs_q_correct_streak3_total:" + qid
 *       "cscs_q_correct_streak_len:"    + qid
 *   - SYNC state:
 *       state.streak3[qid]
 *       state.streakLen[qid]
 *   - payload(merge):
 *       streak3Delta[qid]
 *       streakLenDelta[qid]   // ã€Œå¢—åˆ†ã€ã§ã¯ãªãã€Œæœ€æ–°å€¤ã€ã‚’é€ã‚‹
 *
 * â–¼ å•é¡Œåˆ¥ 3 é€£ç¶šä¸æ­£è§£
 *   - localStorage:
 *       "cscs_q_wrong_streak3_total:" + qid
 *       "cscs_q_wrong_streak_len:"    + qid
 *   - SYNC state:
 *       state.streak3Wrong[qid]
 *       state.streakWrongLen[qid]
 *   - payload(merge):
 *       streak3WrongDelta[qid]
 *       streakWrongLenDelta[qid]   // ã€Œå¢—åˆ†ã€ã§ã¯ãªãã€Œæœ€æ–°å€¤ã€ã‚’é€ã‚‹
 *
 * â–¼ å•é¡Œåˆ¥ é€£ç¶šä¸æ­£è§£ï¼ˆLocal ã®ã¿ã§è¡¨ç¤ºã™ã‚‹æœ€é«˜å€¤/é”æˆæ—¥ï¼‰
 *   - localStorage:
 *       "cscs_q_wrong_streak_max:"     + qid
 *       "cscs_q_wrong_streak_max_day:" + qid
 *
 * â–¼ ä»Šæ—¥ã®â­ï¸ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°ï¼ˆStreak3Todayï¼‰
 *   - localStorage:
 *       "cscs_streak3_today_day"
 *       "cscs_streak3_today_unique_count"
 *       "cscs_streak3_today_qids"
 *   - SYNC state:
 *       state.streak3Today.day
 *       state.streak3Today.unique_count
 *       state.streak3Today.qids
 *   - payload(merge):
 *       streak3TodayDelta { day, qids }
 *
 * â–¼ ä»Šæ—¥ã®3é€£ç¶šä¸æ­£è§£ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°ï¼ˆStreak3WrongTodayï¼‰
 *   - localStorage:
 *       "cscs_streak3_wrong_today_day"
 *       "cscs_streak3_wrong_today_qids"
 *       "cscs_streak3_wrong_today_unique_count"
 *   - SYNC state:
 *       state.streak3WrongToday.day
 *       state.streak3WrongToday.qids
 *       state.streak3WrongToday.unique_count
 *   - payload(merge):
 *       streak3WrongTodayDelta { day, qids }
 *
 * â–¼ 1 æ—¥ 1 å›è¨ˆæ¸¬ãƒ¢ãƒ¼ãƒ‰ï¼ˆoncePerDayTodayï¼‰
 *   - localStorage:
 *       "cscs_once_per_day_today_day"
 *       "cscs_once_per_day_today_results"
 *   - SYNC state:
 *       state.oncePerDayToday.day
 *       state.oncePerDayToday.results[qid]
 *
 * â–¼ å•é¡Œåˆ¥ æœ€çµ‚æ—¥æƒ…å ±ï¼ˆlastSeen / lastCorrect / lastWrongï¼‰
 *   - localStorage:
 *       "cscs_q_last_seen_day:"    + qid
 *       "cscs_q_last_correct_day:" + qid
 *       "cscs_q_last_wrong_day:"   + qid
 *   - SYNC state:
 *       state.lastSeenDay[qid]
 *       state.lastCorrectDay[qid]
 *       state.lastWrongDay[qid]
 *   - payload(merge):
 *       lastSeenDayDelta[qid]
 *       lastCorrectDayDelta[qid]
 *       lastWrongDayDelta[qid]
 *
 * â–¼ ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ãƒ¼ã‚«ãƒ«ãƒ­ã‚°
 *   - localStorage:
 *       "cscs_sync_last_c:"  + qid
 *       "cscs_sync_last_w:"  + qid
 *       "cscs_sync_last_s3:" + qid
 *       "cscs_correct_streak3_log"
 *
 * â–¼ ä½¿ç”¨ã™ã‚‹ä¸»ãª API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
 *   - GET  /api/sync/state
 *   - POST /api/sync/merge
 *   - POST /api/sync/reset_qid
 *   - POST /api/sync/reset_streak3_qid
 *   - POST /api/sync/reset_streak3_today
 *   - POST /api/sync/reset_once_per_day_today
 *   - POST /api/sync/reset_all_qid
 */
(function(){
  // === â‘  QIDæ¤œå‡ºï¼ˆAãƒ‘ãƒ¼ãƒˆï¼‰ ===
  function detectQidFromLocationA() {
    const m = location.pathname.match(/_build_cscs_(\d{8})\/slides\/q(\d{3})_a(?:\.html)?$/);
    if (!m) return null;
    const day  = m[1];   // ä¾‹: "20250926"
    const num3 = m[2];   // ä¾‹: "001"
    // qid å½¢å¼ã‚’ã€ŒYYYYMMDD-NNNã€ã«çµ±ä¸€
    return day + "-" + num3;
  }
  const QID = detectQidFromLocationA();

  // === â‘¡ å·®åˆ†ã‚­ãƒ¥ãƒ¼ï¼ˆAãƒ‘ãƒ¼ãƒˆå°‚ç”¨ï¼‰ ===
  //   - correctDelta / incorrectDelta: æ­£è§£ãƒ»ä¸æ­£è§£ã®ç´¯è¨ˆå·®åˆ†
  //   - streak3Delta / streakLenDelta: 3é€£ç¶šã€Œæ­£è§£ã€å›æ•°ã¨ç¾åœ¨ã®é€£ç¶šæ­£è§£é•·
  //   - streak3WrongDelta / streakWrongLenDelta: 3é€£ç¶šã€Œä¸æ­£è§£ã€å›æ•°ã¨ç¾åœ¨ã®é€£ç¶šä¸æ­£è§£é•·
  //   - lastSeenDayDelta / lastCorrectDayDelta / lastWrongDayDelta:
  //       å•é¡Œåˆ¥ã®ã€Œæœ€çµ‚æ—¥æƒ…å ±ã€ã‚’ SYNC å´ã¸æ¸¡ã™ãŸã‚ã®æœ€æ–°å€¤
  const queue = {
    correctDelta: {},
    incorrectDelta: {},
    streak3Delta: {},
    streakLenDelta: {},
    streak3WrongDelta: {},
    streakWrongLenDelta: {},
    lastSeenDayDelta: {},
    lastCorrectDayDelta: {},
    lastWrongDayDelta: {}
  };
  let sendTimer = null;

  // SYNCãƒ¢ãƒ‹ã‚¿ç”¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  let lastSyncStatus = "idle";   // "idle" | "sending" | "ok" | "error" | "offline"
  let lastSyncTime   = null;     // "HH:MM:SS"
  let lastSyncError  = "";

  // â˜… ä¸æ­£è§£ã‚¹ãƒˆãƒªãƒ¼ã‚¯è¡¨ç¤ºã®åˆå›ãƒ­ã‚°ç”¨ãƒ•ãƒ©ã‚°
  //   - updateMonitor() å†…ã§ä¸€åº¦ã ã‘ã€Œä¸æ­£è§£ã‚¹ãƒˆãƒªãƒ¼ã‚¯ UI ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã€ã“ã¨ã‚’
  //     ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºã™ãŸã‚ã®çŠ¶æ…‹ã€‚
  let loggedWrongStreakUiOnce = false;

  // â˜… ãƒ‡ãƒãƒƒã‚°UIæ–¹é‡ãƒ­ã‚°ç”¨ãƒ•ãƒ©ã‚°
  //   - ã€Œä¸æ­£è§£ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã¯ã¾ã ãƒ¢ãƒ‹ã‚¿ã«å‡ºã—ã¦ã„ãªã„ã€ãƒãƒªã‚·ãƒ¼ã‚’
  //     ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ä¸€åº¦ã ã‘æ˜ç¤ºã™ã‚‹ãŸã‚ã®çŠ¶æ…‹ã€‚
  //   - updateMonitor() å†…ã§ä¸€åº¦ã ã‘ true ã«ã—ã¦ä»¥é™ã¯ãƒ­ã‚°ã‚’å‡ºã•ãªã„ã€‚
  let loggedWrongStreakUiPolicy = false;

  // â˜… è¿½åŠ : streak max ã‚«ãƒ¼ãƒ‰ï¼ˆAï¼‰åˆå›ãƒ­ã‚°ç”¨ãƒ•ãƒ©ã‚°
  //   - updateMonitor() å†…ã§ä¸€åº¦ã ã‘ã€Œstreak max ã‚«ãƒ¼ãƒ‰ã®å€¤ãŒå–ã‚Œã¦UIã«åæ˜ ã•ã‚ŒãŸã€ã“ã¨ã‚’
  //     ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºã™ãŸã‚ã®çŠ¶æ…‹ã€‚
  let loggedStreakMaxUiOnce = false;

  // â˜… è¿½åŠ : ä¸æ­£è§£ streak max ã‚«ãƒ¼ãƒ‰ï¼ˆAï¼‰åˆå›ãƒ­ã‚°ç”¨ãƒ•ãƒ©ã‚°
  //   - updateMonitor() å†…ã§ä¸€åº¦ã ã‘ã€Œä¸æ­£è§£ streak max ã‚«ãƒ¼ãƒ‰ã®å€¤ãŒå–ã‚Œã¦UIã«åæ˜ ã•ã‚ŒãŸã€ã“ã¨ã‚’
  //     ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºã™ãŸã‚ã®çŠ¶æ…‹ã€‚
  let loggedWrongStreakMaxUiOnce = false;

  // ç©ºæ¬„ã‚’ã€Œ-ã€ã§è¡¨ç¤ºã™ã‚‹å…±é€šãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯åŸ‹ã‚ç¦æ­¢ï¼‰
  //   - null / undefined / "" / ç©ºç™½ã®ã¿ â†’ "-"
  //   - 0 ã¯ã€Œæœ¬å½“ã« 0 ã®å ´åˆã ã‘ã€"0" ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆå‘¼ã³å‡ºã—å…ƒã§ null ã¨åŒºåˆ¥ã™ã‚‹ï¼‰
  function toDisplayText(value, emptyLabel){
    // â˜… å‡¦ç†1: æ¬ æï¼ˆnull/undefined/ç©ºæ–‡å­—ï¼‰ã‚’ "-" ã«çµ±ä¸€ã™ã‚‹
    const fallback = emptyLabel != null ? String(emptyLabel) : "-";
    if (value === null || value === undefined) {
      return fallback;
    }
    const s = String(value);
    if (s.trim() === "") {
      return fallback;
    }
    return s;
  }

  // === â‘¢ ãƒ¢ãƒ‹ã‚¿UIã®æŠ˜ã‚ŠãŸãŸã¿ï¼ˆæ°¸ç¶šåŒ–ï¼‰ ===
  // æ–¹é‡:
  //   - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é–‰ã˜ï¼ˆcollapsedï¼‰
  //   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé–‹ã„ãŸçŠ¶æ…‹/é–‰ã˜ãŸçŠ¶æ…‹ã‚’ localStorage ã«ä¿å­˜ã—ã€ãƒªãƒ­ãƒ¼ãƒ‰/é·ç§»å¾Œã‚‚ç¶­æŒ
  const LS_MON_OPEN        = "cscs_sync_a_monitor_open";
  const LS_DAYS_OPEN       = "cscs_sync_a_days_open";
  const LS_QDEL_OPEN       = "cscs_sync_a_queue_detail_open";

  function readLsBool(key, defaultBool){
    try{
      const v = localStorage.getItem(key);
      if (v === null || v === undefined) return !!defaultBool;
      if (v === "1") return true;
      if (v === "0") return false;
      if (v === "true") return true;
      if (v === "false") return false;
      return !!defaultBool;
    }catch(_){
      return !!defaultBool;
    }
  }

  function writeLsBool(key, boolVal){
    try{
      localStorage.setItem(key, boolVal ? "1" : "0");
    }catch(_){}
  }

  function readLocalTotalsForQid(qid){
    try{
      const kC = "cscs_q_correct_total:" + qid;
      const kW = "cscs_q_wrong_total:"   + qid;

      // â˜… å‡¦ç†: localStorage ã®æ•°å€¤ã‚’ã€Œå³å¯†ã€ã«èª­ã‚€ï¼ˆæ¬ æ/ç©º/éæ•° â†’ nullã€"0" â†’ 0ï¼‰
      function readLsNonNegIntOrNull(key){
        const raw = localStorage.getItem(key);

        // æ¬ æã¯ nullï¼ˆ0åŸ‹ã‚ç¦æ­¢ï¼‰
        if (raw === null || raw === undefined) return null;

        const s = String(raw).trim();
        if (s === "") return null;

        // æ•°å­—ä»¥å¤–ã¯ nullï¼ˆ0åŸ‹ã‚ç¦æ­¢ï¼‰
        if (!/^\d+$/.test(s)) return null;

        const n = parseInt(s, 10);
        if (!Number.isFinite(n) || n < 0) return null;

        return n;
      }

      const c = readLsNonNegIntOrNull(kC);
      const w = readLsNonNegIntOrNull(kW);

      return { c, w };
    }catch(_){
      // â˜… æ–¹é‡: ä¾‹å¤–ã§ã‚‚ 0 ã«ã›ãš nullï¼ˆæ¬ ææ‰±ã„ï¼‰ã«ã™ã‚‹
      return { c: null, w: null };
    }
  }

  function readLocalStreak3ForQid(qid){
    try{
      const kS = "cscs_q_correct_streak3_total:" + qid;

      // â˜… å‡¦ç†: æ¬ æ/ç©º/éæ•°ã¯ nullï¼ˆ0åŸ‹ã‚ç¦æ­¢ï¼‰
      const raw = localStorage.getItem(kS);
      if (raw === null || raw === undefined) return null;

      const s = String(raw).trim();
      if (s === "") return null;
      if (!/^\d+$/.test(s)) return null;

      const n = parseInt(s, 10);
      if (!Number.isFinite(n) || n < 0) return null;

      return n;
    }catch(_){
      return null;
    }
  }

  function readLocalStreakLenForQid(qid){
    try{
      const kL = "cscs_q_correct_streak_len:" + qid;

      // â˜… å‡¦ç†: æ¬ æ/ç©º/éæ•°ã¯ nullï¼ˆ0åŸ‹ã‚ç¦æ­¢ï¼‰
      const raw = localStorage.getItem(kL);
      if (raw === null || raw === undefined) return null;

      const s = String(raw).trim();
      if (s === "") return null;
      if (!/^\d+$/.test(s)) return null;

      const n = parseInt(s, 10);
      if (!Number.isFinite(n) || n < 0) return null;

      return n;
    }catch(_){
      return null;
    }
  }

  // â˜… è¿½åŠ : localStorage ã‹ã‚‰ã€Œæœ€é«˜é€£ç¶šæ­£è§£æ•°ï¼ˆéå»æœ€é«˜ï¼‰ã€ã‚’èª­ã¿å–ã‚‹
  //   - b_judge_record.js ãŒ "cscs_q_correct_streak_max:{qid}" ã«ä¿å­˜ã—ã¦ã„ã‚‹å€¤ã‚’ãã®ã¾ã¾åˆ©ç”¨
  function readLocalStreakMaxForQid(qid){
    try{
      const kM = "cscs_q_correct_streak_max:" + qid;

      // â˜… å‡¦ç†: æ¬ æ/ç©º/éæ•°ã¯ nullï¼ˆ0åŸ‹ã‚ç¦æ­¢ï¼‰
      const raw = localStorage.getItem(kM);
      if (raw === null || raw === undefined) return null;

      const s = String(raw).trim();
      if (s === "") return null;
      if (!/^\d+$/.test(s)) return null;

      const n = parseInt(s, 10);
      if (!Number.isFinite(n) || n < 0) return null;

      return n;
    }catch(_){
      return null;
    }
  }

  // â˜… è¿½åŠ : localStorage ã‹ã‚‰ã€Œæœ€é«˜é€£ç¶šæ­£è§£æ•°ã‚’æ›´æ–°ã—ãŸé”æˆæ—¥ï¼ˆJST YYYYMMDDï¼‰ã€ã‚’èª­ã¿å–ã‚‹
  //   - b_judge_record.js ãŒ "cscs_q_correct_streak_max_day:{qid}" ã«ä¿å­˜ã—ã¦ã„ã‚‹å€¤ã‚’ãã®ã¾ã¾åˆ©ç”¨
  function readLocalStreakMaxDayForQid(qid){
    try{
      const kD = "cscs_q_correct_streak_max_day:" + qid;
      const v = localStorage.getItem(kD);

      // â˜… å‡¦ç†1: æ¬ æ/ç©ºã¯ nullï¼ˆç©ºæ–‡å­—ã§åŸ‹ã‚ãªã„ï¼‰
      if (v === null || v === undefined) {
        console.log("[SYNC-A][NO-FALLBACK][LS] streakMaxDay missing -> null", { qid: qid, key: kD });
        return null;
      }
      const s = String(v).trim();
      if (s === "") {
        console.log("[SYNC-A][NO-FALLBACK][LS] streakMaxDay empty -> null", { qid: qid, key: kD, raw: v });
        return null;
      }

      // â˜… å‡¦ç†2: æˆåŠŸãƒ­ã‚°ï¼ˆå–å¾—ã§ããŸäº‹å®Ÿã‚’ç¢ºå®Ÿã«å¯è¦–åŒ–ï¼‰
      console.log("[SYNC-A][OK][LS] streakMaxDay ok", { qid: qid, key: kD, value: s });
      return s;
    }catch(e){
      console.error("[SYNC-A][NO-FALLBACK][LS] streakMaxDay read exception -> null", {
        qid: qid,
        error: String(e && e.message || e)
      });
      return null;
    }
  }

  // â˜… ä¸æ­£è§£å´: localStorage ã‹ã‚‰ã€Œ3é€£ç¶šä¸æ­£è§£å›æ•°ã€ã‚’èª­ã¿å–ã‚‹
  //   - b_judge_record.js ãŒ "cscs_q_wrong_streak3_total:{qid}" ã«åŠ ç®—ã—ãŸå€¤ã‚’ãã®ã¾ã¾åˆ©ç”¨
  function readLocalWrongStreak3ForQid(qid){
    try{
      const kS = "cscs_q_wrong_streak3_total:" + qid;

      // â˜… å‡¦ç†: æ¬ æ/ç©º/éæ•°ã¯ nullï¼ˆ0åŸ‹ã‚ç¦æ­¢ï¼‰
      const raw = localStorage.getItem(kS);
      if (raw === null || raw === undefined) return null;

      const s = String(raw).trim();
      if (s === "") return null;
      if (!/^\d+$/.test(s)) return null;

      const n = parseInt(s, 10);
      if (!Number.isFinite(n) || n < 0) return null;

      return n;
    }catch(_){
      return null;
    }
  }

  // â˜… ä¸æ­£è§£å´: localStorage ã‹ã‚‰ã€Œç¾åœ¨ã®é€£ç¶šä¸æ­£è§£é•·ã€ã‚’èª­ã¿å–ã‚‹
  //   - b_judge_record.js ãŒ "cscs_q_wrong_streak_len:{qid}" ã«ä¿å­˜ã—ã¦ã„ã‚‹æœ€æ–°å€¤
  function readLocalWrongStreakLenForQid(qid){
    try{
      const kL = "cscs_q_wrong_streak_len:" + qid;

      // â˜… å‡¦ç†: æ¬ æ/ç©º/éæ•°ã¯ nullï¼ˆ0åŸ‹ã‚ç¦æ­¢ï¼‰
      const raw = localStorage.getItem(kL);
      if (raw === null || raw === undefined) return null;

      const s = String(raw).trim();
      if (s === "") return null;
      if (!/^\d+$/.test(s)) return null;

      const n = parseInt(s, 10);
      if (!Number.isFinite(n) || n < 0) return null;

      return n;
    }catch(_){
      return null;
    }
  }

  // â˜… è¿½åŠ : localStorage ã‹ã‚‰ã€Œæœ€é«˜é€£ç¶šä¸æ­£è§£æ•°ï¼ˆéå»æœ€é«˜ï¼‰ã€ã‚’èª­ã¿å–ã‚‹
  //   - b_judge_record.js ãŒ "cscs_q_wrong_streak_max:{qid}" ã«ä¿å­˜ã—ã¦ã„ã‚‹å€¤ã‚’ãã®ã¾ã¾åˆ©ç”¨
  function readLocalWrongStreakMaxForQid(qid){
    try{
      const kM = "cscs_q_wrong_streak_max:" + qid;

      // â˜… å‡¦ç†: æ¬ æ/ç©º/éæ•°ã¯ nullï¼ˆ0åŸ‹ã‚ç¦æ­¢ï¼‰
      const raw = localStorage.getItem(kM);
      if (raw === null || raw === undefined) return null;

      const s = String(raw).trim();
      if (s === "") return null;
      if (!/^\d+$/.test(s)) return null;

      const n = parseInt(s, 10);
      if (!Number.isFinite(n) || n < 0) return null;

      return n;
    }catch(_){
      return null;
    }
  }

  // â˜… è¿½åŠ : localStorage ã‹ã‚‰ã€Œæœ€é«˜é€£ç¶šä¸æ­£è§£æ•°ã‚’æ›´æ–°ã—ãŸé”æˆæ—¥ï¼ˆJST YYYYMMDDï¼‰ã€ã‚’èª­ã¿å–ã‚‹
  //   - b_judge_record.js ãŒ "cscs_q_wrong_streak_max_day:{qid}" ã«ä¿å­˜ã—ã¦ã„ã‚‹å€¤ã‚’ãã®ã¾ã¾åˆ©ç”¨
  function readLocalWrongStreakMaxDayForQid(qid){
    try{
      const kD = "cscs_q_wrong_streak_max_day:" + qid;
      const v = localStorage.getItem(kD);

      // â˜… å‡¦ç†1: æ¬ æ/ç©ºã¯ nullï¼ˆç©ºæ–‡å­—ã§åŸ‹ã‚ãªã„ï¼‰
      if (v === null || v === undefined) {
        console.log("[SYNC-A][NO-FALLBACK][LS] wrongStreakMaxDay missing -> null", { qid: qid, key: kD });
        return null;
      }
      const s = String(v).trim();
      if (s === "") {
        console.log("[SYNC-A][NO-FALLBACK][LS] wrongStreakMaxDay empty -> null", { qid: qid, key: kD, raw: v });
        return null;
      }

      // â˜… å‡¦ç†2: æˆåŠŸãƒ­ã‚°
      console.log("[SYNC-A][OK][LS] wrongStreakMaxDay ok", { qid: qid, key: kD, value: s });
      return s;
    }catch(e){
      console.error("[SYNC-A][NO-FALLBACK][LS] wrongStreakMaxDay read exception -> null", {
        qid: qid,
        error: String(e && e.message || e)
      });
      return null;
    }
  }

  // â˜… å•é¡Œåˆ¥ æœ€çµ‚æ—¥æƒ…å ±: localStorage ã‹ã‚‰ã€Œæœ€çµ‚é–²è¦§æ—¥ã€ã‚’èª­ã¿å–ã‚‹
  function readLocalLastSeenDayForQid(qid){
    try{
      const k = "cscs_q_last_seen_day:" + qid;
      const v = localStorage.getItem(k);

      // â˜… å‡¦ç†1: æ¬ æ/ç©ºã¯ nullï¼ˆç©ºæ–‡å­—ã§åŸ‹ã‚ãªã„ï¼‰
      if (v === null || v === undefined) {
        console.log("[SYNC-A][NO-FALLBACK][LS] lastSeenDay missing -> null", { qid: qid, key: k });
        return null;
      }
      const s = String(v).trim();
      if (s === "") {
        console.log("[SYNC-A][NO-FALLBACK][LS] lastSeenDay empty -> null", { qid: qid, key: k, raw: v });
        return null;
      }

      // â˜… å‡¦ç†2: æˆåŠŸãƒ­ã‚°
      console.log("[SYNC-A][OK][LS] lastSeenDay ok", { qid: qid, key: k, value: s });
      return s;
    }catch(e){
      console.error("[SYNC-A][NO-FALLBACK][LS] lastSeenDay read exception -> null", {
        qid: qid,
        error: String(e && e.message || e)
      });
      return null;
    }
  }

  // â˜… å•é¡Œåˆ¥ æœ€çµ‚æ—¥æƒ…å ±: localStorage ã‹ã‚‰ã€Œæœ€çµ‚æ­£è§£æ—¥ã€ã‚’èª­ã¿å–ã‚‹
  function readLocalLastCorrectDayForQid(qid){
    try{
      const k = "cscs_q_last_correct_day:" + qid;
      const v = localStorage.getItem(k);

      // â˜… å‡¦ç†1: æ¬ æ/ç©ºã¯ nullï¼ˆç©ºæ–‡å­—ã§åŸ‹ã‚ãªã„ï¼‰
      if (v === null || v === undefined) {
        console.log("[SYNC-A][NO-FALLBACK][LS] lastCorrectDay missing -> null", { qid: qid, key: k });
        return null;
      }
      const s = String(v).trim();
      if (s === "") {
        console.log("[SYNC-A][NO-FALLBACK][LS] lastCorrectDay empty -> null", { qid: qid, key: k, raw: v });
        return null;
      }

      // â˜… å‡¦ç†2: æˆåŠŸãƒ­ã‚°
      console.log("[SYNC-A][OK][LS] lastCorrectDay ok", { qid: qid, key: k, value: s });
      return s;
    }catch(e){
      console.error("[SYNC-A][NO-FALLBACK][LS] lastCorrectDay read exception -> null", {
        qid: qid,
        error: String(e && e.message || e)
      });
      return null;
    }
  }

  // â˜… å•é¡Œåˆ¥ æœ€çµ‚æ—¥æƒ…å ±: localStorage ã‹ã‚‰ã€Œæœ€çµ‚ä¸æ­£è§£æ—¥ã€ã‚’èª­ã¿å–ã‚‹
  function readLocalLastWrongDayForQid(qid){
    try{
      const k = "cscs_q_last_wrong_day:" + qid;
      const v = localStorage.getItem(k);

      // â˜… å‡¦ç†1: æ¬ æ/ç©ºã¯ nullï¼ˆç©ºæ–‡å­—ã§åŸ‹ã‚ãªã„ï¼‰
      if (v === null || v === undefined) {
        console.log("[SYNC-A][NO-FALLBACK][LS] lastWrongDay missing -> null", { qid: qid, key: k });
        return null;
      }
      const s = String(v).trim();
      if (s === "") {
        console.log("[SYNC-A][NO-FALLBACK][LS] lastWrongDay empty -> null", { qid: qid, key: k, raw: v });
        return null;
      }

      // â˜… å‡¦ç†2: æˆåŠŸãƒ­ã‚°
      console.log("[SYNC-A][OK][LS] lastWrongDay ok", { qid: qid, key: k, value: s });
      return s;
    }catch(e){
      console.error("[SYNC-A][NO-FALLBACK][LS] lastWrongDay read exception -> null", {
        qid: qid,
        error: String(e && e.message || e)
      });
      return null;
    }
  }

  function setServerTotalsForQid(c, i, s3, sLen){
    const el = document.getElementById("cscs_sync_totals");
    if (el) {
      el.dataset.serverC = String(c);
      el.dataset.serverI = String(i);
      if (typeof s3 === "number") {
        el.dataset.serverS3 = String(s3);
      }
      if (typeof sLen === "number") {
        el.dataset.serverSL = String(sLen);
      }
    }
  }

  function updateMonitor(){
    try{
      if (!QID) return;
      const box = document.getElementById("cscs_sync_monitor_a");
      const totalsEl = document.getElementById("cscs_sync_totals");

      // â˜… å‡¦ç†: ã€Œ|| 0ã€ã§æ¬ æã‚’0åŸ‹ã‚ã—ãªã„ï¼ˆæ¬ æã¯ null ã®ã¾ã¾ã«ã—ã¦å¯è¦–åŒ–ï¼‰
      const hasDC = Object.prototype.hasOwnProperty.call(queue.correctDelta, QID);
      const hasDI = Object.prototype.hasOwnProperty.call(queue.incorrectDelta, QID);

      const dC = hasDC ? queue.correctDelta[QID] : null;
      const dI = hasDI ? queue.incorrectDelta[QID] : null;

      // â˜… å‡¦ç†: æ¬ æ/æ•°å€¤ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºå®Ÿã«åˆ¤åˆ¥ã§ãã‚‹ãƒ­ã‚°
      console.log("[SYNC-A][NO-FALLBACK][QUEUE] delta snapshot", {
        qid: QID,
        correctDelta: dC,
        incorrectDelta: dI,
        missing: { correctDelta: !hasDC, incorrectDelta: !hasDI }
      });

      const local = readLocalTotalsForQid(QID);
      const lc = local.c; // â˜… æ¬ æã¯ nullï¼ˆ0åŸ‹ã‚ç¦æ­¢ï¼‰
      const li = local.w; // â˜… æ¬ æã¯ nullï¼ˆ0åŸ‹ã‚ç¦æ­¢ï¼‰

      const ls = readLocalStreak3ForQid(QID);   // â˜… æ¬ æã¯ nullï¼ˆ0åŸ‹ã‚ç¦æ­¢ï¼‰
      const ll = readLocalStreakLenForQid(QID); // â˜… æ¬ æã¯ nullï¼ˆ0åŸ‹ã‚ç¦æ­¢ï¼‰

      // â˜… è¿½åŠ ãƒ­ã‚°: localStorage ã‹ã‚‰ã€Œæ¬ æã‹/æ•°å€¤ã‹ã€ã‚’ç¢ºå®Ÿã«ç¢ºèªã§ãã‚‹
      console.log("[SYNC-A][UI] local snapshot (no-fallback)", {
        qid: QID,
        localTotals: { correct: lc, wrong: li },
        localStreak: { streak3: ls, streakLen: ll },
        missing: {
          totals: (lc === null || li === null),
          streak: (ls === null || ll === null)
        }
      });

      // â˜… è¿½åŠ : æ­£è§£ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã®ã€Œéå»æœ€é«˜ã€ã¨ã€Œé”æˆæ—¥ã€ã‚’ localStorage ã‹ã‚‰å–å¾—
      //   - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç„¡ã—ï¼šb_judge_record.js ã® localStorage ã‚’å”¯ä¸€ã®å‚ç…§å…ƒã¨ã—ã¦è¡¨ç¤ºã™ã‚‹
      const lMax    = readLocalStreakMaxForQid(QID);
      const lMaxDay = readLocalStreakMaxDayForQid(QID);

      // â˜… è¿½åŠ : ä¸æ­£è§£ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã®ã€Œéå»æœ€é«˜ã€ã¨ã€Œé”æˆæ—¥ã€ã‚’ localStorage ã‹ã‚‰å–å¾—
      //   - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç„¡ã—ï¼šb_judge_record.js ã® localStorage ã‚’å”¯ä¸€ã®å‚ç…§å…ƒã¨ã—ã¦è¡¨ç¤ºã™ã‚‹
      const lWrongMax    = readLocalWrongStreakMaxForQid(QID);
      const lWrongMaxDay = readLocalWrongStreakMaxDayForQid(QID);

      // â˜… ä¸æ­£è§£ã‚¹ãƒˆãƒªãƒ¼ã‚¯ï¼ˆlocalStorageï¼‰ã®èª­ã¿å–ã‚Š
      //   - b_judge_record.js ãŒæ›¸ãè¾¼ã‚“ã§ã„ã‚‹
      //     "cscs_q_wrong_streak3_total:{qid}"
      //     "cscs_q_wrong_streak_len:{qid}"
      //     ã‚’ãã®ã¾ã¾ UI ã«å‡ºã™ã€‚
      const lsWrong = readLocalWrongStreak3ForQid(QID);
      const llWrong = readLocalWrongStreakLenForQid(QID);

      // ============================================================
      // â˜… è¡¨ç¤ºæ–¹é‡:
      //   - SYNCåˆè¨ˆï¼ˆserverC/serverIï¼‰ãŒã€Œæœªå–å¾—/æ¬ æã€ã®å ´åˆã¯ 0 ã«ã›ãš "-" è¡¨ç¤º
      //   - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§åˆ¥ã‚½ãƒ¼ã‚¹ã‹ã‚‰æ¨æ¸¬ã—ãªã„ï¼ˆdatasetãŒç©ºãªã‚‰æ¬ ææ‰±ã„ï¼‰
      //   - streak3/streakLen ã¯å¾“æ¥é€šã‚Šï¼ˆæ¬ ææ™‚ã¯ 0 è¡¨ç¤ºã®ã¾ã¾ï¼‰â€»å¿…è¦ãªã‚‰å¾Œã§åŒæ§˜ã«æ‹¡å¼µå¯èƒ½
      // ============================================================
      let sc = null, si = null, ss = null, sl = null;
      if (totalsEl) {
        // â˜… å‡¦ç†1: dataset ã®æ•°å€¤ã‚’ â€œå³å¯†â€ ã«èª­ã‚€ï¼ˆç©º/æ¬ æ/éæ•°ã¯ nullï¼‰
        function readDatasetNonNegIntOrNull(ds, keyName){
          try{
            if (!ds) return null;
            const raw = ds[keyName];
            if (raw === null || raw === undefined) return null;
            const s = String(raw).trim();
            if (s === "") return null;
            if (!/^\d+$/.test(s)) return null;
            const n = parseInt(s, 10);
            if (!Number.isFinite(n) || n < 0) return null;
            return n;
          }catch(_){
            return null;
          }
        }

        // â˜… å‡¦ç†2: SYNCåˆè¨ˆï¼ˆc/wï¼‰ã¯æ¬ æãªã‚‰ null ã®ã¾ã¾ï¼ˆ0ã«ã—ãªã„ï¼‰
        sc = readDatasetNonNegIntOrNull(totalsEl.dataset, "serverC");
        si = readDatasetNonNegIntOrNull(totalsEl.dataset, "serverI");

        // â˜… å‡¦ç†3: streak ç³»ã‚‚æ¬ æãªã‚‰ nullï¼ˆ0åŸ‹ã‚ç¦æ­¢ï¼‰
        ss = readDatasetNonNegIntOrNull(totalsEl.dataset, "serverS3");
        sl = readDatasetNonNegIntOrNull(totalsEl.dataset, "serverSL");

        // â˜… å‡¦ç†4: è¡¨ç¤ºã‚’åæ˜ ï¼ˆæ¬ æã¯ "-"ï¼‰
        const serverTextEl = totalsEl.querySelector(".sync-server-text");
        if (serverTextEl) {
          const cText = (sc === null) ? "-" : String(sc);
          const iText = (si === null) ? "-" : String(si);
          serverTextEl.textContent = "SYNC " + cText + " / " + iText;

          // â˜… å‡¦ç†5: ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã€Œæ¬ æãªã®ã‹/æ•°å€¤ãªã®ã‹ã€ã‚’ç¢ºå®Ÿã«ç¢ºèªã§ãã‚‹ãƒ­ã‚°
          console.log("[SYNC-A][UI] totals server display updated", {
            qid: QID,
            serverC: sc,
            serverI: si,
            missing: (sc === null || si === null)
          });
        }
      }

      // â˜… å‡¦ç†: progress ã¯æ¨æ¸¬ã§åŸ‹ã‚ãªã„
      //   - sl/ll ãŒ number ã®æ™‚ã ã‘è¨ˆç®—ã—ã€ãã‚Œä»¥å¤–ã¯ nullï¼ˆUI ã¯ "-" ã§è¡¨ç¤ºã™ã‚‹ï¼‰
      const serverProgress = (typeof sl === "number" && Number.isFinite(sl)) ? (sl % 3) : null;
      const localProgress  = (typeof ll === "number" && Number.isFinite(ll)) ? (ll % 3) : null;

      // â˜… è¿½åŠ ãƒ­ã‚°: progress ã®ç®—å‡ºãŒã€Œè¨ˆç®—ã§ããŸã‹/æ¬ æã‹ã€ã‚’ç¢ºèª
      console.log("[SYNC-A][UI] progress computed (no-fallback)", {
        qid: QID,
        serverProgress: serverProgress,
        localProgress: localProgress,
        missing: {
          server: (serverProgress === null),
          local: (localProgress === null)
        }
      });

      // â˜… ä¸æ­£è§£ã‚¹ãƒˆãƒªãƒ¼ã‚¯ï¼ˆSYNC å´ï¼‰ã®æœ€æ–°å€¤ã‚’ __cscs_sync_state ã‹ã‚‰å–å¾—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç¦æ­¢ï¼‰
      let ssWrong = null;
      let slWrong = null;
      try{
        const state = (window.__cscs_sync_state && typeof window.__cscs_sync_state === "object")
          ? window.__cscs_sync_state
          : null;

        // â˜… å‡¦ç†1: stateæœªå–å¾—ãªã‚‰ null ã®ã¾ã¾ï¼ˆ0åŸ‹ã‚ç¦æ­¢ï¼‰
        if (!state) {
          console.log("[SYNC-A][NO-FALLBACK] __cscs_sync_state missing -> wrong streak server = null", {
            qid: QID
          });
        } else {
          // â˜… å‡¦ç†2: streak3Wrong[qid] ã‚’å³å¯†ã«æ¤œè¨¼ã—ã¦æ¡ç”¨ï¼ˆæ¬ æ/å‹ä¸æ­£ã¯ nullï¼‰
          if (state.streak3Wrong && typeof state.streak3Wrong === "object" && Object.prototype.hasOwnProperty.call(state.streak3Wrong, QID)) {
            const v = state.streak3Wrong[QID];
            if (typeof v === "number" && Number.isFinite(v) && v >= 0) {
              ssWrong = v;
              console.log("[SYNC-A][NO-FALLBACK] wrong streak3 server ok", { qid: QID, value: ssWrong });
            } else {
              console.error("[SYNC-A][NO-FALLBACK] wrong streak3 server invalid -> null", { qid: QID, value: v, type: typeof v });
            }
          } else {
            console.log("[SYNC-A][NO-FALLBACK] wrong streak3 server missing entry -> null", { qid: QID });
          }

          // â˜… å‡¦ç†3: streakWrongLen[qid] ã‚’å³å¯†ã«æ¤œè¨¼ã—ã¦æ¡ç”¨ï¼ˆæ¬ æ/å‹ä¸æ­£ã¯ nullï¼‰
          if (state.streakWrongLen && typeof state.streakWrongLen === "object" && Object.prototype.hasOwnProperty.call(state.streakWrongLen, QID)) {
            const v2 = state.streakWrongLen[QID];
            if (typeof v2 === "number" && Number.isFinite(v2) && v2 >= 0) {
              slWrong = v2;
              console.log("[SYNC-A][NO-FALLBACK] wrong streakLen server ok", { qid: QID, value: slWrong });
            } else {
              console.error("[SYNC-A][NO-FALLBACK] wrong streakLen server invalid -> null", { qid: QID, value: v2, type: typeof v2 });
            }
          } else {
            console.log("[SYNC-A][NO-FALLBACK] wrong streakLen server missing entry -> null", { qid: QID });
          }
        }
      }catch(e){
        ssWrong = null;
        slWrong = null;
        console.error("[SYNC-A][NO-FALLBACK] wrong streak server read exception -> nulls", {
          qid: QID,
          error: String(e && e.message || e)
        });
      }

      // â˜… å‡¦ç†4: progress ã¯ â€œè¨ˆç®—ã§ãã‚‹æ™‚ã ã‘â€ è¨ˆç®—ï¼ˆnullãªã‚‰ "-" è¡¨ç¤ºã¸ï¼‰
      const serverWrongProgress = (typeof slWrong === "number" && Number.isFinite(slWrong)) ? (slWrong % 3) : null;
      const localWrongProgress  = (typeof llWrong === "number" && Number.isFinite(llWrong)) ? (llWrong % 3) : null;

      console.log("[SYNC-A][NO-FALLBACK] wrong progress computed", {
        qid: QID,
        serverWrongProgress: serverWrongProgress,
        localWrongProgress: localWrongProgress,
        missing: {
          server: (serverWrongProgress === null),
          local: (localWrongProgress === null)
        }
      });

      // â˜… åˆå›ã ã‘ã€ä¸æ­£è§£ã‚¹ãƒˆãƒªãƒ¼ã‚¯ UI ã®å€¤ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ­ã‚°å‡ºã—
      if (!loggedWrongStreakUiOnce) {
        console.log("[SYNC-A] wrong-streak monitor enabled", {
          qid: QID,
          localWrongStreak3Total: lsWrong,
          localWrongStreakLen: llWrong,
          serverWrongStreak3Total: ssWrong,
          serverWrongStreakLen: slWrong
        });
        loggedWrongStreakUiOnce = true;
      }

      // â˜… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œå…¨æ’é™¤ï¼šSYNC state ãŒç„¡ã‘ã‚Œã° nullï¼ˆæ¬ ææ‰±ã„ï¼‰ã§ä¿æŒã™ã‚‹
      //   - { unique_count: 0 } ã®ã‚ˆã†ãª â€œå‹æ‰‹ãª0åŸ‹ã‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆâ€ ã‚’ç¦æ­¢ã™ã‚‹
      let streak3Today = null;
      try{
        const state = (window.__cscs_sync_state && typeof window.__cscs_sync_state === "object")
          ? window.__cscs_sync_state
          : null;

        if (state && state.streak3Today && typeof state.streak3Today === "object") {
          streak3Today = state.streak3Today;
          console.log("[SYNC-A][NO-FALLBACK][STATE] streak3Today ok (object)", {
            hasDay: Object.prototype.hasOwnProperty.call(streak3Today, "day"),
            hasUniqueCount: Object.prototype.hasOwnProperty.call(streak3Today, "unique_count"),
            hasQids: Object.prototype.hasOwnProperty.call(streak3Today, "qids")
          });
        } else {
          streak3Today = null;
          console.log("[SYNC-A][NO-FALLBACK][STATE] streak3Today missing -> null", {
            hasState: !!state
          });
        }
      }catch(e){
        streak3Today = null;
        console.error("[SYNC-A][NO-FALLBACK][STATE] streak3Today read exception -> null", {
          error: String(e && e.message || e)
        });
      }

      // â˜… UIè¡¨ç¤ºç”¨ï¼šSYNCå´ã¯ â€œå–ã‚ŒãŸæ™‚ã ã‘â€ å€¤ã‚’æ¡ç”¨ï¼ˆå–ã‚Œãªã‘ã‚Œã°ç©ºâ†’-ï¼‰
      const streak3TodayDayForUi =
        (streak3Today && Object.prototype.hasOwnProperty.call(streak3Today, "day"))
          ? streak3Today.day
          : "";

      const streak3TodayCountForUi =
        (streak3Today && typeof streak3Today.unique_count === "number" && Number.isFinite(streak3Today.unique_count))
          ? streak3Today.unique_count
          : "";

      let localStreakDay = "";
      let localStreakCount = null;
      try{
        // â˜… å‡¦ç†1: day ã¯ â€œç„¡ã„ãªã‚‰ç„¡ã„â€ ã‚’æ­£ã¨ã—ã¦ç©ºæ–‡å­—ï¼ˆUIå´ã§ "-" / -ã«è½ã¨ã™ï¼‰
        localStreakDay = localStorage.getItem("cscs_streak3_today_day") || "";

        // â˜… å‡¦ç†2: unique_count ã¯æ¬ æãªã‚‰ nullï¼ˆ0åŸ‹ã‚ç¦æ­¢ï¼‰
        const k = "cscs_streak3_today_unique_count";
        const rawLocalCnt = localStorage.getItem(k);

        if (rawLocalCnt === null || rawLocalCnt === undefined) {
          localStreakCount = null;
          console.log("[SYNC-A][NO-FALLBACK][LS] streak3Today unique_count missing -> null", {
            key: k
          });
        } else {
          const s = String(rawLocalCnt).trim();
          if (s === "") {
            localStreakCount = null;
            console.log("[SYNC-A][NO-FALLBACK][LS] streak3Today unique_count empty -> null", {
              key: k,
              raw: rawLocalCnt
            });
          } else if (!/^\d+$/.test(s)) {
            localStreakCount = null;
            console.error("[SYNC-A][NO-FALLBACK][LS] streak3Today unique_count invalid -> null", {
              key: k,
              raw: rawLocalCnt
            });
          } else {
            const n = parseInt(s, 10);
            localStreakCount = (Number.isFinite(n) && n >= 0) ? n : null;
            console.log("[SYNC-A][NO-FALLBACK][LS] streak3Today unique_count ok", {
              key: k,
              value: localStreakCount
            });
          }
        }
      }catch(e){
        localStreakCount = null;
        console.error("[SYNC-A][NO-FALLBACK][LS] streak3Today unique_count exception -> null", {
          error: String(e && e.message || e)
        });
      }

      // â˜… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œå…¨æ’é™¤ï¼šSYNC state ãŒç„¡ã‘ã‚Œã° nullï¼ˆæ¬ ææ‰±ã„ï¼‰ã§ä¿æŒã™ã‚‹
      let streak3WrongToday = null;
      try{
        const state = (window.__cscs_sync_state && typeof window.__cscs_sync_state === "object")
          ? window.__cscs_sync_state
          : null;

        if (state && state.streak3WrongToday && typeof state.streak3WrongToday === "object") {
          streak3WrongToday = state.streak3WrongToday;
          console.log("[SYNC-A][NO-FALLBACK][STATE] streak3WrongToday ok (object)", {
            hasDay: Object.prototype.hasOwnProperty.call(streak3WrongToday, "day"),
            hasUniqueCount: Object.prototype.hasOwnProperty.call(streak3WrongToday, "unique_count"),
            hasQids: Object.prototype.hasOwnProperty.call(streak3WrongToday, "qids")
          });
        } else {
          streak3WrongToday = null;
          console.log("[SYNC-A][NO-FALLBACK][STATE] streak3WrongToday missing -> null", {
            hasState: !!state
          });
        }
      }catch(e){
        streak3WrongToday = null;
        console.error("[SYNC-A][NO-FALLBACK][STATE] streak3WrongToday read exception -> null", {
          error: String(e && e.message || e)
        });
      }

      // â˜… UIè¡¨ç¤ºç”¨ï¼šSYNCå´ã¯ â€œå–ã‚ŒãŸæ™‚ã ã‘â€ å€¤ã‚’æ¡ç”¨ï¼ˆå–ã‚Œãªã‘ã‚Œã°ç©ºâ†’-ï¼‰
      const streak3WrongTodayDayForUi =
        (streak3WrongToday && Object.prototype.hasOwnProperty.call(streak3WrongToday, "day"))
          ? streak3WrongToday.day
          : "";

      const streak3WrongTodayCountForUi =
        (streak3WrongToday && typeof streak3WrongToday.unique_count === "number" && Number.isFinite(streak3WrongToday.unique_count))
          ? streak3WrongToday.unique_count
          : "";

      let localWrongStreakDay = "";
      let localWrongStreakCount = null;
      try{
        // â˜… å‡¦ç†1: day ã¯ â€œç„¡ã„ãªã‚‰ç„¡ã„â€ ã‚’æ­£ã¨ã—ã¦ç©ºæ–‡å­—
        localWrongStreakDay = localStorage.getItem("cscs_streak3_wrong_today_day") || "";

        // â˜… å‡¦ç†2: unique_count ã¯æ¬ æãªã‚‰ nullï¼ˆ0åŸ‹ã‚ç¦æ­¢ï¼‰
        const k = "cscs_streak3_wrong_today_unique_count";
        const rawLocalWrongCnt = localStorage.getItem(k);

        if (rawLocalWrongCnt === null || rawLocalWrongCnt === undefined) {
          localWrongStreakCount = null;
          console.log("[SYNC-A][NO-FALLBACK][LS] streak3WrongToday unique_count missing -> null", {
            key: k
          });
        } else {
          const s = String(rawLocalWrongCnt).trim();
          if (s === "") {
            localWrongStreakCount = null;
            console.log("[SYNC-A][NO-FALLBACK][LS] streak3WrongToday unique_count empty -> null", {
              key: k,
              raw: rawLocalWrongCnt
            });
          } else if (!/^\d+$/.test(s)) {
            localWrongStreakCount = null;
            console.error("[SYNC-A][NO-FALLBACK][LS] streak3WrongToday unique_count invalid -> null", {
              key: k,
              raw: rawLocalWrongCnt
            });
          } else {
            const n = parseInt(s, 10);
            localWrongStreakCount = (Number.isFinite(n) && n >= 0) ? n : null;
            console.log("[SYNC-A][NO-FALLBACK][LS] streak3WrongToday unique_count ok", {
              key: k,
              value: localWrongStreakCount
            });
          }
        }
      }catch(e){
        localWrongStreakCount = null;
        console.error("[SYNC-A][NO-FALLBACK][LS] streak3WrongToday unique_count exception -> null", {
          error: String(e && e.message || e)
        });
      }

      // â˜… å•é¡Œåˆ¥ æœ€çµ‚æ—¥æƒ…å ±ï¼ˆLastSeen / LastCorrect / LastWrongï¼‰ã®å–å¾—
      //   - local: localStorage ã«ä¿å­˜ã•ã‚ŒãŸæœ€çµ‚æ—¥
      //   - sync : window.__cscs_sync_state.lastSeenDay ãªã©ã«ä¿å­˜ã•ã‚ŒãŸæœ€çµ‚æ—¥
      let lastSeenLocal = "";
      let lastCorrectLocal = "";
      let lastWrongLocal = "";
      try{
        lastSeenLocal = readLocalLastSeenDayForQid(QID);
        lastCorrectLocal = readLocalLastCorrectDayForQid(QID);
        lastWrongLocal = readLocalLastWrongDayForQid(QID);
      }catch(_){}

      let lastSeenSync = "";
      let lastCorrectSync = "";
      let lastWrongSync = "";
      try{
        const stateForLast = (window.__cscs_sync_state && typeof window.__cscs_sync_state === "object")
          ? window.__cscs_sync_state
          : null;

        if (stateForLast && stateForLast.lastSeenDay && typeof stateForLast.lastSeenDay === "object") {
          const v = stateForLast.lastSeenDay[QID];
          // â˜… æœ€çµ‚é–²è¦§æ—¥ã® SYNC å€¤ã¯ string / number ã®ã©ã¡ã‚‰ã§ã‚‚æ¥ã‚‹æƒ³å®š
          //   - "20251211" / 20251211 ã®ä¸¡æ–¹ã‚’è¨±å®¹ã—ã€è¡¨ç¤ºç”¨ã«ã¯æ–‡å­—åˆ—ã«çµ±ä¸€ã™ã‚‹
          if (typeof v === "string" && v) {
            lastSeenSync = v;
          } else if (typeof v === "number" && Number.isFinite(v) && v > 0) {
            lastSeenSync = String(v);
          }
        }

        if (stateForLast && stateForLast.lastCorrectDay && typeof stateForLast.lastCorrectDay === "object") {
          const v2 = stateForLast.lastCorrectDay[QID];
          // â˜… æœ€çµ‚æ­£è§£æ—¥ã® SYNC å€¤ã‚‚ string / number ä¸¡å¯¾å¿œã§æ–‡å­—åˆ—åŒ–ã—ã¦æ‰±ã†
          if (typeof v2 === "string" && v2) {
            lastCorrectSync = v2;
          } else if (typeof v2 === "number" && Number.isFinite(v2) && v2 > 0) {
            lastCorrectSync = String(v2);
          }
        }

        if (stateForLast && stateForLast.lastWrongDay && typeof stateForLast.lastWrongDay === "object") {
          const v3 = stateForLast.lastWrongDay[QID];
          // â˜… æœ€çµ‚ä¸æ­£è§£æ—¥ã® SYNC å€¤ã‚‚åŒæ§˜ã« string / number ä¸¡å¯¾å¿œ
          if (typeof v3 === "string" && v3) {
            lastWrongSync = v3;
          } else if (typeof v3 === "number" && Number.isFinite(v3) && v3 > 0) {
            lastWrongSync = String(v3);
          }
        }
      }catch(_){}

      if (box) {
        const qEl  = box.querySelector(".sync-qid");

        const s3tDayEl   = box.querySelector(".sync-streak3today-day");
        const s3tSyncEl  = box.querySelector(".sync-streak3today-sync");
        const s3tLocalEl = box.querySelector(".sync-streak3today-local");

        // â˜… è¿½åŠ : æ—¥ä»˜ã®ã€ŒSYNC day / local day / ä»Šæ—¥ä¸€è‡´ã€ã‚’è¦‹ãˆã‚‹åŒ–ã™ã‚‹è¦ç´ ï¼ˆAï¼‰
        const s3tDaySyncEl      = box.querySelector(".sync-streak3today-day-sync");
        const s3tDayLocalEl     = box.querySelector(".sync-streak3today-day-local");
        const s3tDayIsTodayEl   = box.querySelector(".sync-streak3today-day-istoday");

        const s3wtDaySyncEl     = box.querySelector(".sync-streak3wrongtoday-day-sync");
        const s3wtDayLocalEl    = box.querySelector(".sync-streak3wrongtoday-day-local");
        const s3wtDayIsTodayEl  = box.querySelector(".sync-streak3wrongtoday-day-istoday");

        const onceDaySyncEl     = box.querySelector(".sync-onceperday-day-sync");
        const onceDayLocalEl    = box.querySelector(".sync-onceperday-day-local");
        const onceDayIsTodayEl  = box.querySelector(".sync-onceperday-day-istoday");

        // â˜… è¿½åŠ : streak max ã‚«ãƒ¼ãƒ‰ï¼ˆAï¼‰è¡¨ç¤ºç”¨è¦ç´ 
        const streakMaxLenEl    = box.querySelector(".sync-streakmax-len-local");
        const streakMaxValEl    = box.querySelector(".sync-streakmax-max-local");
        const streakMaxDayEl    = box.querySelector(".sync-streakmax-maxday-local");

        // â˜… è¿½åŠ : ä¸æ­£è§£ streak max ã‚«ãƒ¼ãƒ‰ï¼ˆAï¼‰è¡¨ç¤ºç”¨è¦ç´ 
        const wrongStreakMaxLenEl = box.querySelector(".sync-wrong-streakmax-len-local");
        const wrongStreakMaxValEl = box.querySelector(".sync-wrong-streakmax-max-local");
        const wrongStreakMaxDayEl = box.querySelector(".sync-wrong-streakmax-maxday-local");

        // â˜… è¿½åŠ : ã‚­ãƒ¥ãƒ¼ï¼ˆ+Î”ï¼‰è©³ç´°ï¼ˆBï¼‰
        const qdCwEl     = box.querySelector(".sync-queue-cw");
        const qdS3El     = box.querySelector(".sync-queue-s3");
        const qdSLel     = box.querySelector(".sync-queue-sl");
        const qdS3wEl    = box.querySelector(".sync-queue-s3w");
        const qdSLwEl    = box.querySelector(".sync-queue-slw");
        const qdSeenEl   = box.querySelector(".sync-queue-lastseen");
        const qdCorEl    = box.querySelector(".sync-queue-lastcorrect");
        const qdWrgEl    = box.querySelector(".sync-queue-lastwrong");

        // â˜… å•é¡Œåˆ¥ æœ€çµ‚æ—¥æƒ…å ±è¡¨ç¤ºç”¨è¦ç´ ï¼ˆè©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
        const lastSeenSyncEl     = box.querySelector(".sync-last-seen-sync");
        const lastCorrectSyncEl  = box.querySelector(".sync-last-correct-sync");
        const lastWrongSyncEl    = box.querySelector(".sync-last-wrong-sync");
        const lastSeenLocalEl    = box.querySelector(".sync-last-seen-local");
        const lastCorrectLocalEl = box.querySelector(".sync-last-correct-local");
        const lastWrongLocalEl   = box.querySelector(".sync-last-wrong-local");

        // â˜… è¿½åŠ : lastday ã‚µãƒãƒªãƒ¼ï¼ˆsummary 1è¡Œï¼‰
        const lastdaySummaryTypeEl  = box.querySelector(".sync-lastday-summary-type");
        const lastdaySummarySyncEl  = box.querySelector(".sync-lastday-summary-sync");
        const lastdaySummaryLocalEl = box.querySelector(".sync-lastday-summary-local");

        if (s3tDayEl) {
          // â˜… å¤‰æ›´: Streak3TodayUnique ã® day é …ç›®ã¯ UI ã‹ã‚‰å‰Šé™¤ï¼ˆéè¡¨ç¤ºï¼‰
          s3tDayEl.textContent = "";
          s3tDayEl.style.display = "none";
        }
        if (s3tSyncEl) {
          // â˜… å‡¦ç†: SYNCå´ unique_count ã‚‚ã€Œå–ã‚ŒãŸæ™‚ã ã‘ã€æ¡ç”¨ï¼ˆç„¡ã‘ã‚Œã°æ¬ æâ†’-ï¼‰
          s3tSyncEl.textContent = toDisplayText(streak3TodayCountForUi, "-");
        }
        if (s3tLocalEl) {
          s3tLocalEl.textContent = toDisplayText(
            Number.isFinite(localStreakCount) ? localStreakCount : "",
            "-"
          );
        }

        // â˜… ä»Šæ—¥ã®3é€£ç¶šä¸æ­£è§£ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°ã‚’ãƒ¢ãƒ‹ã‚¿UIã«åæ˜ ã™ã‚‹
        //   - unique: sync å´ unique_count ã¨ localStorage å´ã®å€¤ã‚’ä¸¦åˆ—è¡¨è¨˜
        const s3wtDayEl   = box.querySelector(".sync-streak3wrongtoday-day");
        const s3wtSyncEl  = box.querySelector(".sync-streak3wrongtoday-sync");
        const s3wtLocalEl = box.querySelector(".sync-streak3wrongtoday-local");
        if (s3wtDayEl) {
          // â˜… å¤‰æ›´: Streak3WrongTodayUq ã® day é …ç›®ã¯ UI ã‹ã‚‰å‰Šé™¤ï¼ˆéè¡¨ç¤ºï¼‰
          s3wtDayEl.textContent = "";
          s3wtDayEl.style.display = "none";
        }
        if (s3wtSyncEl) {
          // â˜… å‡¦ç†: SYNCå´ unique_count ã‚‚ã€Œå–ã‚ŒãŸæ™‚ã ã‘ã€æ¡ç”¨ï¼ˆç„¡ã‘ã‚Œã°æ¬ æâ†’-ï¼‰
          s3wtSyncEl.textContent = toDisplayText(streak3WrongTodayCountForUi, "-");
        }
        if (s3wtLocalEl) {
          s3wtLocalEl.textContent = toDisplayText(
            Number.isFinite(localWrongStreakCount) ? localWrongStreakCount : "",
            "-"
          );
        }

        // â˜… è¿½åŠ : localStorage å´ã®ã€Œdayã€ã‚‚èª­ã¿å–ã£ã¦è¡¨ç¤ºã«å‡ºã™ï¼ˆAï¼‰
        let localStreakDayRaw = "";
        let localWrongStreakDayRaw = "";
        try{
          localStreakDayRaw = localStorage.getItem("cscs_streak3_today_day") || "";
          localWrongStreakDayRaw = localStorage.getItem("cscs_streak3_wrong_today_day") || "";
        }catch(_){}

        // â˜… è¿½åŠ : oncePerDayToday ã® dayï¼ˆSYNC/localï¼‰ã‚‚è¦‹ãˆã‚‹åŒ–ï¼ˆAï¼‰
        let syncOnceDayRaw = "";
        let localOnceDayRaw = "";
        try{
          const stateForOnceDay = (window.__cscs_sync_state && typeof window.__cscs_sync_state === "object")
            ? window.__cscs_sync_state
            : null;
          const onceObj = stateForOnceDay && stateForOnceDay.oncePerDayToday && typeof stateForOnceDay.oncePerDayToday === "object"
            ? stateForOnceDay.oncePerDayToday
            : null;
          if (onceObj && typeof onceObj.day === "number" && Number.isFinite(onceObj.day) && onceObj.day > 0) {
            syncOnceDayRaw = String(onceObj.day);
          } else if (onceObj && typeof onceObj.day === "string" && onceObj.day.trim() !== "") {
            syncOnceDayRaw = onceObj.day.trim();
          } else {
            syncOnceDayRaw = "";
          }
        }catch(_){}

        try{
          localOnceDayRaw = localStorage.getItem("cscs_once_per_day_today_day") || "";
        }catch(_){}

        // â˜… è¿½åŠ : â€œãã®dayãŒä»Šæ—¥ãªã®ã‹â€ ã‚’æ˜ç¤ºï¼ˆAï¼‰
        //   - ã“ã“ã§ã¯ã€ŒYYYYMMDDï¼ˆæ•°å€¤åŒ–ã§ãã‚‹å ´åˆï¼‰ã€ã§ä»Šæ—¥æ¯”è¼ƒã™ã‚‹
        function isTodayYmdString(ymdStr){
          try{
            const s = String(ymdStr || "").trim();
            if (!/^\d{8}$/.test(s)) return "unknown";
            const now = new Date();
            const yy = now.getFullYear();
            const mm = now.getMonth() + 1;
            const dd = now.getDate();
            const today = String(yy * 10000 + mm * 100 + dd);
            return s === today ? "YES" : "NO";
          }catch(_){
            return "unknown";
          }
        }

        // â˜… å¤‰æ›´: Streak3TodayUnique / Streak3WrongTodayUq ã® day æ¯”è¼ƒæ¬„ã¯ UI ã‹ã‚‰å‰Šé™¤ï¼ˆéè¡¨ç¤ºï¼‰
        if (s3tDaySyncEl)    { s3tDaySyncEl.textContent = "";  s3tDaySyncEl.style.display = "none"; }
        if (s3tDayLocalEl)   { s3tDayLocalEl.textContent = ""; s3tDayLocalEl.style.display = "none"; }
        if (s3tDayIsTodayEl) { s3tDayIsTodayEl.textContent = ""; s3tDayIsTodayEl.style.display = "none"; }

        if (s3wtDaySyncEl)    { s3wtDaySyncEl.textContent = "";  s3wtDaySyncEl.style.display = "none"; }
        if (s3wtDayLocalEl)   { s3wtDayLocalEl.textContent = ""; s3wtDayLocalEl.style.display = "none"; }
        if (s3wtDayIsTodayEl) { s3wtDayIsTodayEl.textContent = ""; s3wtDayIsTodayEl.style.display = "none"; }

        if (onceDaySyncEl)    onceDaySyncEl.textContent  = toDisplayText(syncOnceDayRaw, "-");
        if (onceDayLocalEl)   onceDayLocalEl.textContent = toDisplayText(localOnceDayRaw, "-");
        if (onceDayIsTodayEl) onceDayIsTodayEl.textContent = isTodayYmdString(syncOnceDayRaw);

        // â˜… æœ€çµ‚æ—¥æƒ…å ±ï¼ˆLastSeen / LastCorrect / LastWrongï¼‰ã‚’ UI ã«åæ˜ ï¼ˆè©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
        if (lastSeenSyncEl) {
          lastSeenSyncEl.textContent = toDisplayText(lastSeenSync, "-");
        }
        if (lastCorrectSyncEl) {
          lastCorrectSyncEl.textContent = toDisplayText(lastCorrectSync, "-");
        }
        if (lastWrongSyncEl) {
          lastWrongSyncEl.textContent = toDisplayText(lastWrongSync, "-");
        }
        if (lastSeenLocalEl) {
          lastSeenLocalEl.textContent = toDisplayText(lastSeenLocal, "-");
        }
        if (lastCorrectLocalEl) {
          lastCorrectLocalEl.textContent = toDisplayText(lastCorrectLocal, "-");
        }
        if (lastWrongLocalEl) {
          lastWrongLocalEl.textContent = toDisplayText(lastWrongLocal, "-");
        }

        // â˜… è¿½åŠ : lastday ã®ã€Œæœ€æ–°æ­£èª¤è¨˜éŒ²ã€ã‚’ 1è¡Œã‚µãƒãƒªãƒ¼ã«åæ˜ 
        //   - lastCorrect ã¨ lastWrong ã®ã†ã¡ã€æ—¥ä»˜ãŒæ–°ã—ã„æ–¹ã‚’ã€Œæœ€æ–°ã€ã¨ã—ã¦æ¡ç”¨
        //   - è¡¨ç¤ºã¯ã€Œãƒ©ãƒ™ãƒ« + SYNCå€¤ + localå€¤ã€ã®1è¡Œã«ã™ã‚‹
        //   - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§åˆ¥ã‚½ãƒ¼ã‚¹ã‹ã‚‰æ¨æ¸¬ã—ãªã„ï¼ˆå–ã‚Œã¦ã„ã‚‹å€¤ã ã‘ã§åˆ¤å®šï¼‰
        function ymdToNum8(v){
          const s = String(v || "").trim();
          if (!/^\d{8}$/.test(s)) return null;
          const n = parseInt(s, 10);
          if (!Number.isFinite(n) || n <= 0) return null;
          return n;
        }

        function pickLatestType(){
          const cS = ymdToNum8(lastCorrectSync);
          const wS = ymdToNum8(lastWrongSync);
          const cL = ymdToNum8(lastCorrectLocal);
          const wL = ymdToNum8(lastWrongLocal);

          let bestType = "lastCorrect";
          let bestNum = null;

          function consider(type, n){
            if (n === null) return;

            // â˜… å‡¦ç†1: ã¾ã å€™è£œãŒç„¡ã„ or ã‚ˆã‚Šæ–°ã—ã„æ—¥ä»˜ãªã‚‰æ›´æ–°
            if (bestNum === null || n > bestNum) {
              bestNum = n;
              bestType = type;
              return;
            }

            // â˜… å‡¦ç†2: åŒæ—¥ã‚¿ã‚¤ãªã‚‰ correct å„ªå…ˆï¼ˆlastWrong ãŒå‹ã£ã¦ã„ãŸã‚‰ lastCorrect ã«æˆ»ã™ï¼‰
            if (bestNum !== null && n === bestNum) {
              if (type === "lastCorrect" && bestType === "lastWrong") {
                bestType = "lastCorrect";
              }
            }
          }

          consider("lastCorrect", cS);
          consider("lastWrong",  wS);
          consider("lastCorrect", cL);
          consider("lastWrong",  wL);

          return bestType;
        }

        const latestType = pickLatestType();
        const latestSyncVal  = (latestType === "lastWrong") ? lastWrongSync  : lastCorrectSync;
        const latestLocalVal = (latestType === "lastWrong") ? lastWrongLocal : lastCorrectLocal;

        if (lastdaySummaryTypeEl) {
          // â˜… summary ã®ç¨®åˆ¥è¡¨ç¤ºã¯ 1è¡Œã§èª­ã¿ã‚„ã™ã„ â€œLastWrong / LastCorrectâ€ ã«çµ±ä¸€
          lastdaySummaryTypeEl.textContent = (latestType === "lastWrong") ? "LastWrong" : "LastCorrect";
        }
        if (lastdaySummarySyncEl) {

```
<<<PART_END>>>
ã€RECEIPT_INPUTï¼ˆã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã ã‘ã‚’çœŸã¨ã™ã‚‹ï¼‰ã€‘
EXPECTED_TOTAL: 4
RECEIVED_TOTAL: 1

CUMULATIVE_RECEIVED_PARTIDS:
- CSCSJS-AE8739D4-P01-of-04

ã€ChatGPTã¸ã®å¼·åˆ¶ãƒ«ãƒ¼ãƒ«ã€‘
ãƒ»å—é ˜ç¢ºèªã¯ã€ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã® CUMULATIVE_RECEIVED_PARTIDS ã¨ EXPECTED_PARTIDS ã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã€‚
ãƒ»ä¼šè©±å±¥æ­´ã‹ã‚‰ PartID ã‚’å†åé›†ã—ãªã„ã“ã¨ï¼ˆç¦æ­¢ï¼‰ã€‚
ãƒ»å—é ˜ç¢ºèªOKå‰ã«ã€ã‚³ãƒ¼ãƒ‰å†…å®¹ã®è§£é‡ˆãƒ»è¦ç´„ãƒ»æ¨æ¸¬ãƒ»ä¿®æ­£æ¡ˆæç¤ºã‚’ã—ãªã„ã“ã¨ï¼ˆç¦æ­¢ï¼‰ã€‚

RECEIPT_REQUIRED_RESPONSE_TEMPLATE:
ACK: <PartID> <PartSHA256_8> / WAITING_NEXT

ã€åˆ†å‰²ã‚³ãƒ¼ãƒ‰(1)ã®çµ‚äº†ã€‘â†’ æ¬¡ã¯ åˆ†å‰²ã‚³ãƒ¼ãƒ‰(2) ã‚’é€ã‚Šã¾ã™
ã€ChatGPTã¸ã®æŒ‡ç¤ºã€‘è§£é‡ˆãƒ»è¦ç´„ãƒ»æ¨æ¸¬ãƒ»ä¿®æ­£æ¡ˆæç¤ºã¯ç¦æ­¢ã€‚è¿”ç­”ã¯æ¬¡ã®ã¿ã€‚
ACK: <PartID> / WAITING_NEXT
