<<<PART_BEGIN>>>
ã€åˆ†å‰²ã‚³ãƒ¼ãƒ‰(1)ã®é–‹å§‹ã€‘
PartID: CSCSJS-06411020-P01-of-05
PartSHA256: 786ec4ac1ac68c0a808948f11176946106281a4f49f0026f57b36444970347cd
Range: chars 0..33950 (len=33950)
FirstLine: // assets/cscs_sync_view_b.js
LastLine: 
EndNewline: YES
PART_SCOPE_HINT: LineRange=L1..L1078 | BraceDepth=0->1
PART_SCOPE_HINT_TOP_IDENTIFIERS: svb:104, qid:60, cscs_sync_view_b_body:54, syncState:53, state:42, grid:41, SYNC:39, card:38, localStorage:36, day:36, text:30, lastday:30
PART_SCOPE_HINT_DEFINES: upsertStyleTag, ensureSyncViewBStyles, detectInfo, readIntFromLocalStorage, readDayFromLocalStorage, readTotalQuestionsFromLocalStorage, readOncePerDayTodayFromLocal, computePendingFlags, buildOncePerDayTodayDelta, clearSyncBody, updateSyncBodyText, appendGridRow, appendGridSection, SYNC_STATE_ENDPOINT, SYNC_MERGE_ENDPOINT, CSCS_SYNC_VIEW_B_CSS, head, el, path, m, day, num3, qid, info, raw, n, key, dayStr, results, dayNum, flags, localOnce, localOnceVal, serverOnceVal, locSeen, locCor, locWro, srvSeen, srvCor, srvWro

ã€ãƒ—ãƒ­ãƒˆã‚³ãƒ«å®£è¨€ï¼ˆPART_01=å®£è¨€ / LAST_PART=EXEC_TASKï¼‰ã€‘
SessionID: CSCSJS-06411020
TargetFile: cscs_sync_view_b.js
Split: total_parts=5, max_chars_per_part=60000, max_lines_per_part=1200

ã€ã‚ãªãŸï¼ˆChatGPTï¼‰ã¸ã®æœ€é‡è¦ãƒ«ãƒ¼ãƒ«ï¼ˆå³å®ˆï¼‰ã€‘
0) åˆ†å‰²ã‚³ãƒ¼ãƒ‰å—é ˜ä¸­ã¯ã€å†…å®¹ã®è§£é‡ˆãƒ»è¦ç´„ãƒ»æ¨æ¸¬ãƒ»ä¿®æ­£æ¡ˆæç¤ºã‚’ä¸€åˆ‡ç¦æ­¢ã€‚
1) åˆ†å‰²ã‚³ãƒ¼ãƒ‰(1..N-1)å—é ˜æ™‚ã®è¿”ç­”ã¯å¿…ãšï¼š
   ACK: <PartID> / WAITING_NEXT
2) æœ€çµ‚åˆ†å‰²ã‚³ãƒ¼ãƒ‰(N)å—é ˜æ™‚ã¯ã€æœ«å°¾ã® RECEIPT_INPUT ã‚’ç”¨ã„ã¦å—é ˜ç¢ºèªã‚’å®Ÿæ–½ã™ã‚‹ã“ã¨ã€‚
3) å—é ˜ç¢ºèªã¯ã€æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã® CUMULATIVE_RECEIVED_PARTIDS ã¨ EXPECTED_PARTIDS ã®ã¿ã‚’ä½¿ç”¨ï¼ˆä¼šè©±å±¥æ­´å‚ç…§ã¯ç¦æ­¢ï¼‰ã€‚
4) å®Ÿè¡ŒæŒ‡ç¤ºï¼ˆEXEC_TASKï¼‰ã¯ã€æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã® EXEC_TASKã€ã®ã¿ã‚’çœŸã¨ã™ã‚‹ã€‚PART_01ã®æ–‡ã¯å‚è€ƒã§ã‚ã‚Šå®Ÿè¡Œæ ¹æ‹ ã«ã—ãªã„ã€‚
5) RECEIPT_CHECK: OK ã®åŒä¸€è¿”ä¿¡å†…ã§ã€JOIN_READY/JOIN_ACTION/EXEC_START ã‚’å¿…ãšå‡ºåŠ›ã—ã€ç›´ã¡ã« EXEC_TASK ã‚’å®Ÿè¡Œã™ã‚‹ã€‚
6) JOINï¼ˆé€£çµï¼‰ãƒ«ãƒ¼ãƒ«ï¼ˆå¼·åˆ¶ï¼‰:
   - åˆ†å‰²ã‚³ãƒ¼ãƒ‰ã‚’é€£çµã—ã¦â€œå®Œå…¨ãªJSâ€ã‚’ä½œã‚‹éš›ã€ãƒ‘ãƒ¼ãƒˆå¢ƒç•Œã«æ”¹è¡Œã‚„ç©ºç™½ã‚’å‹æ‰‹ã«è¿½åŠ ã—ã¦ã¯ãªã‚‰ãªã„ã€‚
   - å„ãƒ‘ãƒ¼ãƒˆæœ¬æ–‡ã¯ã€æç¤ºã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’ãã®ã¾ã¾ã€é€£çµã™ã‚‹ï¼ˆãƒ‘ãƒ¼ãƒˆé–“ã«æš—é»™ã®æ”¹è¡Œã¯å­˜åœ¨ã—ãªã„ï¼‰ã€‚
   - ã—ãŸãŒã£ã¦ã€åˆ†å‰²ã‚³ãƒ¼ãƒ‰åŒå£«ã®é–“ã«æ”¹è¡Œã®æ˜è¨˜ãŒç„¡ã„é™ã‚Šã¯ã€å¿…ãšé€£ç¶šè¡Œã¨ã—ã¦èª­ã¿å–ã‚‹ã€ã“ã¨ã€‚
   - å„ãƒ‘ãƒ¼ãƒˆã«ã¯ EndNewline: YES/NO ãŒä»˜ãã€‚å¢ƒç•ŒãŒé€£ç¶šè¡Œã‹ã©ã†ã‹ã¯ã“ã‚Œã‚’å”¯ä¸€ã®æ ¹æ‹ ã¨ã—ã¦åˆ¤å®šã™ã‚‹ã€‚

ã€æŒ‡ç¤ºå†…å®¹ï¼ˆæ¦‚è¦ï¼šå‚è€ƒç”¨ï¼å®Ÿè¡Œæ ¹æ‹ ã«ã—ãªã„ï¼‰ã€‘
ã€WORK_HEADERï¼ˆå…±é€šIDï¼‰ã€‘
[SESSION_ID: CSCSJS-06411020]
[REQUEST_ID: REQ-B3B72A3C]

ã€USER_INSTRUCTIONã€‘
ã€Œcscs_sync_view_b.jsã€ã®ã€€æ‰‹å‹•é€ä¿¡ãƒœã‚¿ãƒ³(cscs_sync_view_b_send_btn)ã®è¡¨ç¤ºã¨è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ã®å‡¦ç†éƒ¨åˆ†ã‚’ã€€ã€Œãƒœã‚¿ãƒ³ã®è¡¨ç¤ºï¼ˆDOMç”Ÿæˆï¼‹appendï¼‰ã€ã‚‚ãµãã‚å…¨ã¦æŠœãå‡ºã—ã¦ã€€ã€Œb_sync_merge.jsã€ã«ã€€ç§»å‹•ã•ã›ã‚‹

ã€FUNCTION_WHOLEã€‘ createPanel
FOUND: true
HEADER: EXTRACT_FUNCTION: createPanel (chars 70392..78597)
SHA256: d02d1eeee3271404ef34d3119278f54f583c1bc9548444f648ea862e2ae010b9
```javascript
  function createPanel() {
    var box = document.createElement("div");
    box.id = "cscs_sync_view_b";

    var title = document.createElement("div");
    title.id = "cscs_sync_view_b_title";
    title.textContent = "SYNC(B): " + info.qid;

    var body = document.createElement("div");
    body.id = "cscs_sync_view_b_body";
    body.textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";

    var statusDiv = document.createElement("div");
    statusDiv.id = "cscs_sync_view_b_status";

    // â˜…ã€è¶…é‡è¦ä»•æ§˜ï¼šã“ã®ãƒœã‚¿ãƒ³ã¯ã€Œå‰Šé™¤ç¦æ­¢ã€ã€‘
    //   - DOM ä¸Šã«å­˜åœ¨ã—ã¦ã„ã‚‹ã“ã¨ãŒçµ¶å¯¾æ¡ä»¶ï¼ˆIDå¤‰æ›´ã‚‚ç¦æ­¢ï¼‰ã€‚
    //   - setTimeout(... btn.click()) ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã§ã‚‚ã‚ã‚‹ã€‚
    //   - ã“ã“ã§ã¯ã€Œæ‰‹å‹•é€ä¿¡ç”¨ã«è¡¨ç¤ºã€ã™ã‚‹ãŒã€DOM/ID/ãƒœã‚¿ãƒ³å½¢çŠ¶ã¯ç¶­æŒã™ã‚‹ã“ã¨ã€‚
    var btn = document.createElement("button");
    btn.id = "cscs_sync_view_b_send_btn";
    btn.type = "button";
    btn.textContent = "SYNCé€ä¿¡";
    btn.className = "cscs-svb-send-btn";

    // â˜… æ‰‹å‹•é€ä¿¡ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚‰ã€Œç›´è¿‘ãŒæ‰‹å‹•é€ä¿¡ã§ã‚ã‚‹ã€ã“ã¨ã‚’è¨˜éŒ²ã™ã‚‹
    //   - sendDiffToServer å´ã§ã“ã®ãƒ•ãƒ©ã‚°ã‚’è¦‹ã¦ã€Œå·®åˆ†ã‚¼ãƒ­ã§ã‚‚å¿…ãšé€ä¿¡ã€ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
    //   - ã“ã“ã§ã¯â€œé€ä¿¡å‡¦ç†ãã®ã‚‚ã®â€ã¯è§¦ã‚‰ãªã„ï¼ˆæ—¢å­˜ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ã¨å…±å­˜ã•ã›ã‚‹ï¼‰
    //   - è¿½åŠ : ãƒœã‚¿ãƒ³æŠ¼ä¸‹ç›´å¾Œã« /api/sync/state ã‚’å–ã‚Šç›´ã—ã¦ HUD ã‚’å³æ™‚å†æç”»ã—ã€
    //          ãƒ‘ãƒãƒ«å†…ã®å…¨å€¤ãŒã€ŒæŠ¼ã—ãŸç¬é–“ã«æ›´æ–°ã•ã‚ŒãŸã€ã“ã¨ã‚’ä¿è¨¼ã™ã‚‹ï¼ˆãƒ­ã‚°ã§ç¢ºèªå¯èƒ½ï¼‰
    btn.addEventListener("click", function () {
      try {
        window.__cscs_sync_b_manual_send_ts = Date.now();
      } catch (_eManual) {}

      // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
      //   1) æœ€æ–° state ã‚’å–å¾—ã—ã¦ window.__cscs_sync_state ã‚’æ›´æ–°
      //   2) state + localStorage ã‹ã‚‰ã€Œä»Šã“ã®ç¬é–“ã®ã€è¡¨ç¤ºç”¨payloadã‚’å†æ§‹ç¯‰
      //   3) renderPanel() ã‚’å‘¼ã³ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‘ãƒãƒ«å†…ã®å…¨å€¤ã‚’ã¾ã¨ã‚ã¦æ›´æ–°
      (function refreshHudAllValuesAfterManualSendClick() {
        var qid = info.qid;

        console.log("[SYNC-B:view] manual send clicked â†’ refresh HUD start", {
          qid: qid,
          ts: (function () { try { return window.__cscs_sync_b_manual_send_ts || 0; } catch (_e) { return 0; } })()
        });

        fetchState().then(function (st) {
          try {
            window.__cscs_sync_state = st;
          } catch (_eAssign) {}

          console.log("[SYNC-B:view] fetchState success â†’ window.__cscs_sync_state updated", {
            qid: qid,
            hasState: !!st
          });

          // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
          //   serverå€¤ï¼ˆSYNCå´ï¼‰ã‚’ state ã‹ã‚‰æ‹¾ã†ï¼ˆç„¡ã‘ã‚Œã° 0 / "-"ï¼‰
          var serverCorrect = 0;
          var serverWrong = 0;
          var serverStreak3 = 0;
          var serverStreakLen = 0;
          var serverStreak3Wrong = 0;
          var serverWrongStreakLen = 0;

          try {
            if (st && st.correct && typeof st.correct === "object" && st.correct[qid] != null) {
              if (typeof st.correct[qid] === "number" && Number.isFinite(st.correct[qid]) && st.correct[qid] >= 0) {
                serverCorrect = st.correct[qid];
              }
            }
            if (st && st.incorrect && typeof st.incorrect === "object" && st.incorrect[qid] != null) {
              if (typeof st.incorrect[qid] === "number" && Number.isFinite(st.incorrect[qid]) && st.incorrect[qid] >= 0) {
                serverWrong = st.incorrect[qid];
              }
            }
            if (st && st.streak3 && typeof st.streak3 === "object" && st.streak3[qid] != null) {
              if (typeof st.streak3[qid] === "number" && Number.isFinite(st.streak3[qid]) && st.streak3[qid] >= 0) {
                serverStreak3 = st.streak3[qid];
              }
            }
            if (st && st.streakLen && typeof st.streakLen === "object" && st.streakLen[qid] != null) {
              if (typeof st.streakLen[qid] === "number" && Number.isFinite(st.streakLen[qid]) && st.streakLen[qid] >= 0) {
                serverStreakLen = st.streakLen[qid];
              }
            }
            if (st && st.streak3Wrong && typeof st.streak3Wrong === "object" && st.streak3Wrong[qid] != null) {
              if (typeof st.streak3Wrong[qid] === "number" && Number.isFinite(st.streak3Wrong[qid]) && st.streak3Wrong[qid] >= 0) {
                serverStreak3Wrong = st.streak3Wrong[qid];
              }
            }
            if (st && st.streakWrongLen && typeof st.streakWrongLen === "object" && st.streakWrongLen[qid] != null) {
              if (typeof st.streakWrongLen[qid] === "number" && Number.isFinite(st.streakWrongLen[qid]) && st.streakWrongLen[qid] >= 0) {
                serverWrongStreakLen = st.streakWrongLen[qid];
              }
            }
          } catch (eSrvPick) {
            console.error("[SYNC-B:view] refresh pick server values error:", eSrvPick);
          }

          // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
          //   localå€¤ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å´ï¼‰ã‚’ localStorage ã‹ã‚‰æ‹¾ã†ï¼ˆç¢ºå®šã‚­ãƒ¼ã®ã¿ï¼‰
          var localCorrect = readIntFromLocalStorage("cscs_q_correct_total:" + qid);
          var localWrong = readIntFromLocalStorage("cscs_q_wrong_total:" + qid);
          var localStreak3 = readIntFromLocalStorage("cscs_q_correct_streak3_total:" + qid);
          var localStreakLen = readIntFromLocalStorage("cscs_q_correct_streak_len:" + qid);
          var localStreak3Wrong = readIntFromLocalStorage("cscs_q_wrong_streak3_total:" + qid);
          var localWrongStreakLen = readIntFromLocalStorage("cscs_q_wrong_streak_len:" + qid);

          // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
          //   diffï¼ˆlocal - serverï¼‰ã‚’è¨ˆç®—ï¼ˆãƒã‚¤ãƒŠã‚¹ã¯ 0 ã«ä¸¸ã‚ã‚‹ï¼‰
          var diffCorrect = Math.max(0, localCorrect - serverCorrect);
          var diffWrong = Math.max(0, localWrong - serverWrong);
          var diffStreak3 = Math.max(0, localStreak3 - serverStreak3);
          var diffStreakLen = Math.max(0, localStreakLen - serverStreakLen);
          var diffStreak3Wrong = Math.max(0, localStreak3Wrong - serverStreak3Wrong);
          var diffWrongStreakLen = Math.max(0, localWrongStreakLen - serverWrongStreakLen);

          // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
          //   Pendingï¼ˆæœªé€ä¿¡ã£ã½ã„å·®åˆ†ï¼‰ã‚’å†è¨ˆç®—ã—ã¦ payload ã«è¼‰ã›ã‚‹
          var pending = null;
          try {
            pending = computePendingFlags(st, qid);
          } catch (_ePending) {
            pending = null;
          }

          console.log("[SYNC-B:view] manual send clicked â†’ refresh HUD computed", {
            qid: qid,
            serverCorrect: serverCorrect,
            serverWrong: serverWrong,
            localCorrect: localCorrect,
            localWrong: localWrong,
            diffCorrect: diffCorrect,
            diffWrong: diffWrong,
            serverStreak3: serverStreak3,
            localStreak3: localStreak3,
            diffStreak3: diffStreak3,
            serverStreakLen: serverStreakLen,
            localStreakLen: localStreakLen,
            diffStreakLen: diffStreakLen,
            serverStreak3Wrong: serverStreak3Wrong,
            localStreak3Wrong: localStreak3Wrong,
            diffStreak3Wrong: diffStreak3Wrong,
            serverWrongStreakLen: serverWrongStreakLen,
            localWrongStreakLen: localWrongStreakLen,
            diffWrongStreakLen: diffWrongStreakLen,
            pending: pending
          });

          // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
          //   renderPanel() ã« payload ã‚’æ¸¡ã—ã¦ã€Œãƒ‘ãƒãƒ«å†…ã®å…¨å€¤ã€ã‚’ã¾ã¨ã‚ã¦æ›´æ–°
          renderPanel(box, {
            serverCorrect: serverCorrect,
            serverWrong: serverWrong,
            localCorrect: localCorrect,
            localWrong: localWrong,
            diffCorrect: diffCorrect,
            diffWrong: diffWrong,
            serverStreak3: serverStreak3,
            localStreak3: localStreak3,
            diffStreak3: diffStreak3,
            serverStreakLen: serverStreakLen,
            localStreakLen: localStreakLen,
            diffStreakLen: diffStreakLen,
            serverStreak3Wrong: serverStreak3Wrong,
            localStreak3Wrong: localStreak3Wrong,
            diffStreak3Wrong: diffStreak3Wrong,
            serverWrongStreakLen: serverWrongStreakLen,
            localWrongStreakLen: localWrongStreakLen,
            diffWrongStreakLen: diffWrongStreakLen,
            statusText: "manual click â†’ HUD refreshed",
            pending: pending,
            odoaStatusText: "__keep__"
          });

          console.log("[SYNC-B:view] manual send clicked â†’ refresh HUD done", {
            qid: qid
          });
        }).catch(function (e) {
          console.error("[SYNC-B:view] manual send clicked â†’ fetchState failed:", e);
        });
      })();
    });

    box.appendChild(title);
    box.appendChild(body);
    box.appendChild(statusDiv);
    // â˜… éè¡¨ç¤ºãƒœã‚¿ãƒ³ã ãŒã€DOM ã«å¿…ãšè¿½åŠ ã™ã‚‹ã“ã¨ã§ click() è‡ªå‹•ç™ºç«ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ä¿è¨¼ã™ã‚‹ã€‚
    box.appendChild(btn);

    return box;
  }
```
ã€CONTEXTã€‘ createPanel
HITS: 2
LINES: Â±25
MAX_MATCHES: 50

HEADER: EXTRACT_CONTEXT: 'createPanel' hit_line=2184 range_lines=2159..2209
SHA256: 6d59ea5f65541835d113d3f158be5c4ecfcc4eceefb308225421454012e40be9
```javascript
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç¦æ­¢:
      //   bootstrap å®Œäº†å¾Œã«ã‚‚ key ãŒç„¡ã„å ´åˆã¯ã€Œç•°å¸¸ã€ã¨ã—ã¦å³å¤±æ•—ã•ã›ã‚‹
      if (!key) {
        console.error("[SYNC-B:view] X-CSCS-Key missing AFTER bootstrap â†’ fetchState aborted", {
          endpoint: SYNC_STATE_ENDPOINT
        });
        throw new Error("X-CSCS-Key missing after bootstrap");
      }

      return fetch(SYNC_STATE_ENDPOINT, {
        method: "GET",
        cache: "no-store",
        credentials: "include",
        headers: {
          "X-CSCS-Key": key
        }
      });
    }).then(function (res) {
      if (!res.ok) {
        throw new Error(String(res.status));
      }
      return res.json();
    });
  }

  function createPanel() {
    var box = document.createElement("div");
    box.id = "cscs_sync_view_b";

    var title = document.createElement("div");
    title.id = "cscs_sync_view_b_title";
    title.textContent = "SYNC(B): " + info.qid;

    var body = document.createElement("div");
    body.id = "cscs_sync_view_b_body";
    body.textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";

    var statusDiv = document.createElement("div");
    statusDiv.id = "cscs_sync_view_b_status";

    // â˜…ã€è¶…é‡è¦ä»•æ§˜ï¼šã“ã®ãƒœã‚¿ãƒ³ã¯ã€Œå‰Šé™¤ç¦æ­¢ã€ã€‘
    //   - DOM ä¸Šã«å­˜åœ¨ã—ã¦ã„ã‚‹ã“ã¨ãŒçµ¶å¯¾æ¡ä»¶ï¼ˆIDå¤‰æ›´ã‚‚ç¦æ­¢ï¼‰ã€‚
    //   - setTimeout(... btn.click()) ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã§ã‚‚ã‚ã‚‹ã€‚
    //   - ã“ã“ã§ã¯ã€Œæ‰‹å‹•é€ä¿¡ç”¨ã«è¡¨ç¤ºã€ã™ã‚‹ãŒã€DOM/ID/ãƒœã‚¿ãƒ³å½¢çŠ¶ã¯ç¶­æŒã™ã‚‹ã“ã¨ã€‚
    var btn = document.createElement("button");
    btn.id = "cscs_sync_view_b_send_btn";
    btn.type = "button";
    btn.textContent = "SYNCé€ä¿¡";
    btn.className = "cscs-svb-send-btn";

```

HEADER: EXTRACT_CONTEXT: 'createPanel' hit_line=4628 range_lines=4603..4653
SHA256: d7e24c7117f6ac7e83c672a7eea1bc538c9a618edd833b57fb7d7a1d85e5fe2c
```javascript
    //   once/odoa ç³»ã‚«ãƒ¼ãƒ‰ã‚’ä¸€æ—¦ visibility:hidden ã«ã—ã¦ãŠãï¼ˆç§»å‹•ãƒ»æ•´ç†ãŒçµ‚ã‚ã£ãŸã‚‰è§£é™¤ã™ã‚‹ï¼‰
    function ensureOnceOdoaNoFlashStyle() {
      try {
        var id = "cscs_sync_view_b_once_odoa_no_flash";
        if (document.getElementById(id)) return;
        var st = document.createElement("style");
        st.id = id;
        st.type = "text/css";
        st.textContent =
          "#cscs_sync_view_b_status .svb-once-odoa-card{display:none !important;}" +
          "#cscs_sync_view_b_status .svb-once-odoa-card-local{display:none !important;}";
        document.head.appendChild(st);
      } catch (_e) {}
    }

    function clearOnceOdoaNoFlashStyle() {
      try {
        var id = "cscs_sync_view_b_once_odoa_no_flash";
        var st = document.getElementById(id);
        if (st && st.parentNode) st.parentNode.removeChild(st);
      } catch (_e) {}
    }

    ensureOnceOdoaNoFlashStyle();

    var box = createPanel();

    function append() {
      var wrap = document.querySelector("div.wrap");
      if (wrap) {
        if (!wrap.contains(box)) {
          wrap.appendChild(box);
        }
      } else {
        if (!document.body.contains(box)) {
          document.body.appendChild(box);
        }
      }

      // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
      //   æ—¢å­˜(SYNC)ã‚«ãƒ¼ãƒ‰ã®è¦‹å‡ºã—ã‚’ "(SYNC)" ã«ã—ã€ç›´ä¸‹ã« localå°‚ç”¨ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹
      ensureOnceOdoaWideTitles(box);
      ensureLocalOnceOdoaWideCard(box);

      // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
      //   once/odoa ç³»ã‚«ãƒ¼ãƒ‰ã®ç§»å‹•ãƒ»æ•´ç†ãŒå®Œäº†ã—ãŸã®ã§ã€ãƒãƒ©ã¤ãé˜²æ­¢ã®éè¡¨ç¤ºã‚’è§£é™¤ã™ã‚‹
      try {
        var id = "cscs_sync_view_b_once_odoa_no_flash";
        var st = document.getElementById(id);
        if (st && st.parentNode) st.parentNode.removeChild(st);
      } catch (_eNF) {}

```

// assets/b_sync_merge.js
// Bãƒ‘ãƒ¼ãƒˆ â†’ SYNC é€£æºï¼ˆattempt_log å»ƒæ­¢ç‰ˆï¼‰
/**
 * ã€ã‚­ãƒ¼å¯¾å¿œè¡¨ï¼ˆLocalStorage â‡” SYNC state â‡” delta payloadï¼‰ã€‘
 *  â€»ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã€Œæ–°ã—ãã‚­ãƒ¼ã‚’è¿½åŠ ï¼æ—¢å­˜ã‚­ãƒ¼åã‚’å¤‰æ›´ã€ã—ãŸå ´åˆã¯ã€
 *    å¿…ãšã“ã®è¡¨ã‚’æ›´æ–°ã™ã‚‹ã“ã¨ï¼ˆæ’ä¹…ãƒ«ãƒ¼ãƒ«ï¼‰ã€‚
 *
 * â–¼ å•é¡Œåˆ¥ç´¯è¨ˆ
 *   - localStorage: "cscs_q_correct_total:" + qid
 *       â‡” SYNC state: correct[qid]
 *       â‡” delta payload: correctDelta[qid]
 *   - localStorage: "cscs_q_wrong_total:" + qid
 *       â‡” SYNC state: incorrect[qid]
 *       â‡” delta payload: incorrectDelta[qid]
 *
 * â–¼ å•é¡Œåˆ¥ 3 é€£ç¶šæ­£è§£ï¼ˆâ­ï¸ç”¨ï¼‰
 *   - localStorage: "cscs_q_correct_streak3_total:" + qid
 *       â‡” SYNC state: streak3[qid]
 *       â‡” delta payload: streak3Delta[qid]
 *   - localStorage: "cscs_q_correct_streak_len:" + qid
 *       â‡” SYNC state: streakLen[qid]
 *       â‡” delta payload: streakLenDelta[qid]ï¼ˆã€Œå¢—åˆ†ã€ã§ã¯ãªãæœ€æ–°å€¤ï¼‰
 *   - localStorage: "cscs_q_correct_streak_max:" + qid
 *       â‡” SYNC state: streakMax[qid]
 *       â‡” delta payload: streakMaxDelta[qid]ï¼ˆã€Œå¢—åˆ†ã€ã§ã¯ãªãæœ€æ–°å€¤ï¼‰
 *   - localStorage: "cscs_q_correct_streak_max_day:" + qid
 *       â‡” SYNC state: streakMaxDay[qid]
 *       â‡” delta payload: streakMaxDayDelta[qid]ï¼ˆã€Œå¢—åˆ†ã€ã§ã¯ãªãæœ€æ–°å€¤ / JST YYYYMMDDï¼‰
 *
 * â–¼ å•é¡Œåˆ¥ 3 é€£ç¶šä¸æ­£è§£ï¼ˆğŸ’£ç”¨ï¼‰
 *   - localStorage: "cscs_q_wrong_streak3_total:" + qid
 *       â‡” SYNC state: streak3Wrong[qid]
 *       â‡” delta payload: streak3WrongDelta[qid]
 *   - localStorage: "cscs_q_wrong_streak_len:" + qid
 *       â‡” SYNC state: streakWrongLen[qid]
 *       â‡” delta payload: streakWrongLenDelta[qid]ï¼ˆã€Œå¢—åˆ†ã€ã§ã¯ãªãæœ€æ–°å€¤ï¼‰
 *   - localStorage: "cscs_q_wrong_streak_max:" + qid
 *       â‡” SYNC state: streakWrongMax[qid]
 *       â‡” delta payload: streakWrongMaxDelta[qid]ï¼ˆã€Œå¢—åˆ†ã€ã§ã¯ãªãæœ€æ–°å€¤ï¼‰
 *   - localStorage: "cscs_q_wrong_streak_max_day:" + qid
 *       â‡” SYNC state: streakWrongMaxDay[qid]
 *       â‡” delta payload: streakWrongMaxDayDelta[qid]ï¼ˆã€Œå¢—åˆ†ã€ã§ã¯ãªãæœ€æ–°å€¤ / JST YYYYMMDDï¼‰
 *
 * â–¼ Bå°‚ç”¨ã€Œå‰å› SYNC æ¸ˆã¿ç´¯è¨ˆã€ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆSYNC state ã«ã¯å­˜åœ¨ã—ãªã„ï¼‰
 *   - localStorage: "cscs_sync_last_c:"   + qid â€¦ æ­£è§£ç´¯è¨ˆã®å‰å›åŒæœŸå€¤
 *   - localStorage: "cscs_sync_last_w:"   + qid â€¦ ä¸æ­£è§£ç´¯è¨ˆã®å‰å›åŒæœŸå€¤
 *   - localStorage: "cscs_sync_last_s3:"  + qid â€¦ 3é€£ç¶šæ­£è§£ç´¯è¨ˆã®å‰å›åŒæœŸå€¤
 *   - localStorage: "cscs_sync_last_ws3:" + qid â€¦ 3é€£ç¶šä¸æ­£è§£ç´¯è¨ˆã®å‰å›åŒæœŸå€¤
 *
 * ============================================================
 * ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¸€è¦§ï¼ˆã“ã®ãƒ•ã‚¡ã‚¤ãƒ«å†…ã§ â€œæ¬ æãƒ»çŸ›ç›¾â€ ã‚’ä¸¸ã‚ã‚‹ç®‡æ‰€ã®ç´¢å¼•ï¼‰ã€‘
 * ------------------------------------------------------------
 *  Fallback-01: loadInt() ã§ localStorage miss(null) ã‚’ 0 æ‰±ã„
 *    - ç™ºç”Ÿæ¡ä»¶: localStorage.getItem(key) ãŒ null
 *    - å‡¦ç†å†…å®¹: 0 ã‚’è¿”ã—ã¦å‡¦ç†ç¶™ç¶šï¼ˆé€ä¿¡ payload ã¯å£Šã•ãªã„ï¼‰
 *    - å½±éŸ¿/æ³¨æ„: ã€Œæœ¬å½“ã¯ã‚­ãƒ¼æ¬ æï¼ˆè¨ˆæ¸¬æœªå®Ÿè¡Œ/åˆ¥namespace/åˆ¥ç«¯æœ«ï¼‰ã€ã§ã‚‚
 *                 â€œ0åŸºæº–ã®å·®åˆ†â€ ãŒæˆç«‹ã—ã¦ã—ã¾ã„ã€å•é¡ŒãŒéš ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
 *
 *  Fallback-02: loadInt() ã§ parseInt å¤±æ•—(NaNç­‰) ã‚’ 0 æ‰±ã„
 *    - ç™ºç”Ÿæ¡ä»¶: å€¤ãŒæ•°å€¤æ–‡å­—åˆ—ã§ãªã„ / ç ´æå€¤
 *    - å‡¦ç†å†…å®¹: 0 ã‚’è¿”ã—ã¦å‡¦ç†ç¶™ç¶š
 *    - å½±éŸ¿/æ³¨æ„: ç ´æå€¤ãŒå…¥ã£ã¦ã‚‚ â€œç„¡ã‹ã£ãŸã“ã¨â€ ã«ã—ã¦é€²ã‚€ãŸã‚ã€
 *                 ç›£è¦–ãªã—ã ã¨åŸå› ç©¶æ˜ãŒé…ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
 *
 *  Fallback-03: ã€Œå‰å›SYNCæ¸ˆã¿ç´¯è¨ˆ(KEY_LAST_*)ã€ãŒæœªä¿å­˜ã§ã‚‚ 0 åŸºæº–ã§å·®åˆ†è¨ˆç®—
 *    - ç™ºç”Ÿæ¡ä»¶: åˆå›åŒæœŸ / KEY_LAST_* ãŒ null
 *    - å‡¦ç†å†…å®¹: cLast/wLast/s3Last/s3WrongLast ã‚’ 0 ã¨ã—ã¦ delta ã‚’ä½œã‚‹
 *    - å½±éŸ¿/æ³¨æ„: åˆå›åŒæœŸã®åˆ©ä¾¿æ€§ã¯ä¸ŠãŒã‚‹ãŒã€
 *                 ã€ŒKEY_LAST_* ãŒæ¶ˆãˆãŸ/åˆ¥namespaceã§èª­ã‚“ã§ã„ã‚‹ã€çŠ¶æ³ã§ã‚‚
 *                 åˆå›æ‰±ã„ã§ â€œå…¨é‡å·®åˆ†â€ ãŒé€ã‚Œã¦ã—ã¾ã„ã€å•é¡ŒãŒéš ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
 *
 *  Fallback-04: s3Last > s3Now ã‚’æ¤œå‡ºã—ãŸã‚‰ KEY_LAST_S3 ã‚’ now ã« clampï¼ˆä¸‹ã’ã‚‹ï¼‰
 *    - ç™ºç”Ÿæ¡ä»¶: å‰å›åŒæœŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç¾åœ¨ç´¯è¨ˆã‚ˆã‚Šå¤§ãã„ï¼ˆçŸ›ç›¾ï¼‰
 *    - å‡¦ç†å†…å®¹: s3Last = s3Now ã«ã—ã¦ localStorage(KEY_LAST_S3) ã‚’ä¸Šæ›¸ã
 *    - å½±éŸ¿/æ³¨æ„: â€œæ¸›ç®—é€ä¿¡â€ ã‚’é¿ã‘ã‚‹ç›®çš„ã ãŒã€
 *                 ã€Œã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåˆ¥namespaceç”±æ¥ã§å¤§ãã„ã€ç­‰ã§ã‚‚
 *                 å¼·åˆ¶çš„ã«å¸³å°»ã‚’åˆã‚ã›ã¦ã—ã¾ã„ã€ã‚ºãƒ¬ã®åŸå› ãŒè¦‹ãˆã«ãããªã‚‹ã€‚
 *
 *  Fallback-05: s3WrongLast > s3WrongNow ã‚’æ¤œå‡ºã—ãŸã‚‰ KEY_LAST_S3_WRONG ã‚’ now ã« clampï¼ˆä¸‹ã’ã‚‹ï¼‰
 *    - ç™ºç”Ÿæ¡ä»¶: å‰å›åŒæœŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç¾åœ¨ç´¯è¨ˆã‚ˆã‚Šå¤§ãã„ï¼ˆçŸ›ç›¾ï¼‰
 *    - å‡¦ç†å†…å®¹: s3WrongLast = s3WrongNow ã«ã—ã¦ localStorage(KEY_LAST_S3_WRONG) ã‚’ä¸Šæ›¸ã
 *    - å½±éŸ¿/æ³¨æ„: Fallback-04 ã¨åŒæ§˜ã€‚çŸ›ç›¾ã® â€œåŸå› â€ ã‚’è¦†ã„éš ã™ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ã€‚
 *
 *  Fallback-06: delta ãŒè² ã«ãªã£ãŸã‚‰ 0 ã«ä¸¸ã‚ã‚‹ï¼ˆæ¸›ç®—é€ä¿¡ç¦æ­¢ã®ãŸã‚ï¼‰
 *    - ç™ºç”Ÿæ¡ä»¶: (now - last) < 0
 *    - å‡¦ç†å†…å®¹: Math.max(0, rawDelta) ã§ 0 ã«ã™ã‚‹
 *    - å½±éŸ¿/æ³¨æ„: â€œã‚ºãƒ¬ã¦ã„ã‚‹â€ ã“ã¨è‡ªä½“ã¯ãƒ­ã‚°ã§è­¦å‘Šã•ã‚Œã‚‹ãŒã€
 *                 çµæœã¨ã—ã¦é€ä¿¡ãŒé€²ã‚“ã§ã—ã¾ã†ãŸã‚ã€æ ¹æœ¬åŸå› ã®ç‰¹å®šãŒé…ã‚Œã‚„ã™ã„ã€‚
 *
 *  Fallback-07: SYNC_KEY ã®å–å¾—ãŒå¤±æ•—ã—ãŸå ´åˆã§ã‚‚ä¾‹å¤–ã«ã—ã¦å‡¦ç†ã‚’è½ã¨ã™ï¼ˆé€ä¿¡ã—ãªã„ï¼‰
 *    - ç™ºç”Ÿæ¡ä»¶: localStorage ä¾‹å¤– / cscs_sync_key ãŒç©º
 *    - å‡¦ç†å†…å®¹: throw("SYNC_KEY_MISSING_LOCAL") â†’ merge ã‚’å©ã‹ãªã„
 *    - å½±éŸ¿/æ³¨æ„: â€œé€ä¿¡ã§ããªã„â€ ã‚’æ˜ç¤ºã™ã‚‹ã‚¬ãƒ¼ãƒ‰ï¼ˆã“ã‚Œã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã„ã†ã‚ˆã‚Šåœæ­¢ã‚¬ãƒ¼ãƒ‰ï¼‰ã€‚
 * ============================================================
 *
 * ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ŒlocalStorage â†’ /api/sync/merge ã® delta payloadã€ã‚’çµ„ã¿ç«‹ã¦ã‚‹å½¹å‰²ã ã‘ã‚’æŒã¤ã€‚
 * SYNC å´ã®å®Œå…¨ãªæ§‹é€ ã¯ merge.ts / state.ts ã®ä»•æ§˜ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã™ã‚‹ã“ã¨ã€‚
 *
 * ã€é‡è¦ã€‘ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ /api/sync/state ã‚’å‚ç…§ã—ãªã„ãŸã‚ã€
 *          â€œã©ã® namespace / KV ã‚’è¦‹ã¦ã„ã‚‹ã‹â€ ã¯æ¤œçŸ¥ã§ããªã„ã€‚
 *          ãã®ãŸã‚ã€ä¸Šè¨˜ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒåƒãã¨ã€Œã‚ºãƒ¬ã¦ã„ã¦ã‚‚é€ã‚Œã¦ã—ã¾ã†ã€çŠ¶æ³ãŒèµ·ãã†ã‚‹ã€‚
 */

(function(){
  // Bãƒšãƒ¼ã‚¸ã® URL ã‹ã‚‰ qid = "YYYYMMDD-NNN" ã‚’å–å¾—
  function detectInfo(){
    const m = location.pathname.match(/_build_cscs_(\d{8})\/slides\/q(\d{3})_b/);
    if (!m) return null;

    const day = m[1];       // ä¾‹: "20250926"ï¼ˆæ–‡å­—åˆ—ã€‚qidç”Ÿæˆã«ä½¿ã†ï¼‰
    const n3  = m[2];       // ä¾‹: "001"
    const qid = `${day}-${n3}`;

    const dayNum = Number(day); // â˜… çµ±ä¸€: numberï¼ˆYYYYMMDDï¼‰
    if (!Number.isFinite(dayNum) || !/^\d{8}$/.test(String(dayNum))) return null;

    return { day, dayNum, n3, qid };
  }

  const info = detectInfo();
  if (!info) return;

  // b_judge_record.js ãŒç®¡ç†ã—ã¦ã„ã‚‹ã€Œæœ¬ç‰©ã®ç´¯ç©ã‚­ãƒ¼ã€
  const KEY_COR                  = `cscs_q_correct_total:${info.qid}`;
  const KEY_WRG                  = `cscs_q_wrong_total:${info.qid}`;
  const KEY_S3                   = `cscs_q_correct_streak3_total:${info.qid}`;
  const KEY_STREAK_LEN           = `cscs_q_correct_streak_len:${info.qid}`;
  const KEY_STREAK_MAX           = `cscs_q_correct_streak_max:${info.qid}`;
  const KEY_STREAK_MAX_DAY       = `cscs_q_correct_streak_max_day:${info.qid}`;
  const KEY_S3_WRONG             = `cscs_q_wrong_streak3_total:${info.qid}`;
  const KEY_STREAK_WRONG_LEN     = `cscs_q_wrong_streak_len:${info.qid}`;
  const KEY_STREAK_WRONG_MAX     = `cscs_q_wrong_streak_max:${info.qid}`;
  const KEY_STREAK_WRONG_MAX_DAY = `cscs_q_wrong_streak_max_day:${info.qid}`;

  // Bå´ã ã‘ã§ä½¿ã†ã€Œæœ€å¾Œã« SYNC æ¸ˆã¿ã ã£ãŸã¨ãã®ç´¯ç©å€¤ã€
  const KEY_LAST_COR      = `cscs_sync_last_c:${info.qid}`;
  const KEY_LAST_WRG      = `cscs_sync_last_w:${info.qid}`;
  const KEY_LAST_S3       = `cscs_sync_last_s3:${info.qid}`;
  const KEY_LAST_S3_WRONG = `cscs_sync_last_ws3:${info.qid}`;

  // Bå´ã ã‘ã§ä½¿ã†ã€Œæœ€å¾Œã« SYNC æ¸ˆã¿ã ã£ãŸã¨ãã® max / max_dayï¼ˆæœ€æ–°å€¤é€ä¿¡ã®åŸºæº–ï¼‰ã€
  const KEY_LAST_STREAK_MAX           = `cscs_sync_last_streak_max:${info.qid}`;
  const KEY_LAST_STREAK_MAX_DAY       = `cscs_sync_last_streak_max_day:${info.qid}`;
  const KEY_LAST_STREAK_WRONG_MAX     = `cscs_sync_last_streak_wmax:${info.qid}`;
  const KEY_LAST_STREAK_WRONG_MAX_DAY = `cscs_sync_last_streak_wmax_day:${info.qid}`;

  function loadInt(key){
    // Fallback-01: localStorage miss(null) â†’ 0
    // è£œè¶³: ã“ã“ã§ 0 æ‰±ã„ã«ã™ã‚‹ã¨ã€Œæœ¬å½“ã¯ã‚­ãƒ¼ãŒç„¡ã„ï¼ˆnamespaceã‚ºãƒ¬/è¨ˆæ¸¬æœªå®Ÿè¡Œ/åˆ¥ç«¯æœ«ï¼‰ã€ã§ã‚‚
    //       å‡¦ç†ãŒç¶™ç¶šã—ã€çµæœã¨ã—ã¦â€œé€ã‚Œã¦ã—ã¾ã†â€ï¼å•é¡ŒãŒéš ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
    const v = localStorage.getItem(key);
    if (v == null) {
      console.log("[SYNC/B][fallback][loadInt] localStorage miss -> 0", { key });
      return 0;
    }

    // Fallback-02: parseInt å¤±æ•—(NaNç­‰) â†’ 0
    // è£œè¶³: å€¤ã®ç ´æã‚„æƒ³å®šå¤–ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã‚‚ 0 ã¨ã—ã¦é€²ã‚€ãŸã‚ã€
    //       ç›£è¦–ãŒå¼±ã„ã¨ã€Œå£Šã‚Œã¦ã„ã‚‹ã®ã«é€ã‚Œã¦ã—ã¾ã†ã€çŠ¶æ…‹ã«ãªã‚Šã‚„ã™ã„ã€‚
    const n = parseInt(v, 10);
    if (!Number.isFinite(n)) {
      console.warn("[SYNC/B][fallback][loadInt] parseInt failed -> 0", { key, raw: v });
      return 0;
    }

    // æ­£å¸¸ç³»
    console.log("[SYNC/B][ok][loadInt] loaded", { key, raw: v, value: n });
    return n;
  }

  function loadDayOptional(key){
    const raw = localStorage.getItem(key);
    if (raw == null) {
      console.log("[SYNC/B][ok][loadDayOptional] localStorage miss -> (skip)", { key });
      return { ok: false, value: null, raw: null };
    }

    const n = parseInt(raw, 10);
    if (!Number.isFinite(n) || !/^\d{8}$/.test(String(n))) {
      console.warn("[SYNC/B][warn][loadDayOptional] invalid day -> (skip)", { key, raw });
      return { ok: false, value: null, raw: raw };
    }

    console.log("[SYNC/B][ok][loadDayOptional] loaded", { key, raw: raw, value: n });
    return { ok: true, value: n, raw: raw };
  }

  function loadIntOptional(key){
    const raw = localStorage.getItem(key);
    if (raw == null) {
      console.log("[SYNC/B][ok][loadIntOptional] localStorage miss -> (skip)", { key });
      return { ok: false, value: null, raw: null };
    }

    const n = parseInt(raw, 10);
    if (!Number.isFinite(n)) {
      console.warn("[SYNC/B][warn][loadIntOptional] parseInt failed -> (skip)", { key, raw: raw });
      return { ok: false, value: null, raw: raw };
    }

    console.log("[SYNC/B][ok][loadIntOptional] loaded", { key, raw: raw, value: n });
    return { ok: true, value: n, raw: raw };
  }

  function saveInt(key, value){
    localStorage.setItem(key, String(value));
  }
  
  async function syncFromTotals(){
    // 1) ç¾åœ¨ã®ç´¯ç©ï¼ˆb_judge_record.js ãŒæ›¸ã„ãŸå€¤ï¼‰
    const cNow              = loadInt(KEY_COR);
    const wNow              = loadInt(KEY_WRG);
    const s3Now             = loadInt(KEY_S3);
    const streakLenNow      = loadInt(KEY_STREAK_LEN);

    // max / max_day ã¯ã€Œæ¬ æã‚’ 0 ã¨ã—ã¦é€ã‚‹ã€ã¨ SYNC ã‚’æ±šã™ã®ã§ optional èª­ã¿
    const streakMaxOpt       = loadIntOptional(KEY_STREAK_MAX);
    const streakMaxDayOpt    = loadDayOptional(KEY_STREAK_MAX_DAY);

    const s3WrongNow         = loadInt(KEY_S3_WRONG);
    const streakWrongLenNow  = loadInt(KEY_STREAK_WRONG_LEN);

    const streakWrongMaxOpt    = loadIntOptional(KEY_STREAK_WRONG_MAX);
    const streakWrongMaxDayOpt = loadDayOptional(KEY_STREAK_WRONG_MAX_DAY);

    // 2) å‰å› SYNC æ™‚ç‚¹ã®å€¤ï¼ˆå­˜åœ¨ã—ãªã‘ã‚Œã° 0 æ‰±ã„ï¼‰
    // Fallback-03: KEY_LAST_* miss(null) ã‚’ loadInt() ãŒ 0 æ‰±ã„ã«ã™ã‚‹ã“ã¨ã§ã€Œåˆå›åŒæœŸã€ã¨ã—ã¦å·®åˆ†ã‚’ä½œã‚Œã‚‹ã€‚
    // è£œè¶³: ä¾¿åˆ©ã ãŒã€KEY_LAST_* ãŒæ¶ˆãˆãŸ/åˆ¥namespaceã®å€¤ã‚’è¦‹ã¦ã„ã‚‹ç­‰ã§ã‚‚ â€œåˆå›æ‰±ã„â€ ã«ãªã‚Šã€
    //       ã€Œã‚ºãƒ¬ã¦ã¦ã‚‚é€ã‚Œã¦ã—ã¾ã†ã€ï¼å•é¡ŒãŒéš ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
    const cLast       = loadInt(KEY_LAST_COR);
    const wLast       = loadInt(KEY_LAST_WRG);
    let   s3Last      = loadInt(KEY_LAST_S3);
    let   s3WrongLast = loadInt(KEY_LAST_S3_WRONG);

    console.log("[SYNC/B][ok][lastTotals] loaded last totals (0 means first sync or missing)", {
      qid: info.qid,
      KEY_LAST_COR,
      KEY_LAST_WRG,
      KEY_LAST_S3,
      KEY_LAST_S3_WRONG,
      cLast,
      wLast,
      s3Last,
      s3WrongLast
    });

    // correct å´ã® 3é€£ç¶šæ­£è§£ç´¯è¨ˆã«ã¤ã„ã¦ã€local ãŒ s3Last ã‚ˆã‚Šå°ã•ã„å ´åˆ â†’ s3Last ã‚’ local ã«å¼·åˆ¶ä¿®æ­£
    // Fallback-04: KEY_LAST_S3ï¼ˆå‰å›åŒæœŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ãŒç¾åœ¨ç´¯è¨ˆ(s3Now)ã‚’è¶…ãˆã‚‹çŸ›ç›¾ãŒå‡ºãŸã‚‰ã€
    //              â€œæ¸›ç®—é€ä¿¡â€ã‚’èµ·ã“ã•ãªã„ãŸã‚ã« KEY_LAST_S3 ã‚’ now ã« clampï¼ˆä¸‹ã’ã¦ä¸Šæ›¸ãï¼‰ã™ã‚‹ã€‚
    // è£œè¶³: ã“ã“ã§å¸³å°»ã‚’åˆã‚ã›ã‚‹ã¨ã€ŒãªãœçŸ›ç›¾ã—ãŸã‹ï¼ˆnamespaceã‚ºãƒ¬/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç ´æ/æ‰‹å‹•æ“ä½œï¼‰ã€ãŒ
    //       è¿½ã„ã«ãããªã‚‹ã€‚ï¼ã‚ºãƒ¬ã®æ ¹æœ¬åŸå› ãŒéš ã‚Œã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ã€‚
    if (s3Last > s3Now) {
      console.warn("[SYNC/B][fallback][guard] s3Last > s3Now -> clamp last to now", {
        qid: info.qid,
        KEY_LAST_S3,
        before_s3Last: s3Last,
        s3Now
      });

      s3Last = s3Now;
      saveInt(KEY_LAST_S3, s3Last);

      console.log("[SYNC/B][ok][guard] saved corrected KEY_LAST_S3", {
        qid: info.qid,
        KEY_LAST_S3,
        after_s3Last: s3Last
      });
    }

    // wrong å´ã® 3é€£ç¶šä¸æ­£è§£ç´¯è¨ˆã«ã¤ã„ã¦ã‚‚åŒæ§˜ã«ã‚¬ãƒ¼ãƒ‰
    // Fallback-05: KEY_LAST_S3_WRONGï¼ˆå‰å›åŒæœŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ãŒç¾åœ¨ç´¯è¨ˆ(s3WrongNow)ã‚’è¶…ãˆã‚‹çŸ›ç›¾ãŒå‡ºãŸã‚‰ã€
    //              â€œæ¸›ç®—é€ä¿¡â€ã‚’èµ·ã“ã•ãªã„ãŸã‚ã« KEY_LAST_S3_WRONG ã‚’ now ã« clampï¼ˆä¸‹ã’ã¦ä¸Šæ›¸ãï¼‰ã™ã‚‹ã€‚
    // è£œè¶³: Fallback-04 ã¨åŒæ§˜ã€å¸³å°»åˆã‚ã›ã«ã‚ˆã‚Šã€Œã‚ºãƒ¬ã¦ã„ã‚‹ç†ç”±ã€ãŒè¦‹ãˆã«ãããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
    if (s3WrongLast > s3WrongNow) {
      console.warn("[SYNC/B][fallback][guard] s3WrongLast > s3WrongNow -> clamp last to now", {
        qid: info.qid,
        KEY_LAST_S3_WRONG,
        before_s3WrongLast: s3WrongLast,
        s3WrongNow
      });

      s3WrongLast = s3WrongNow;
      saveInt(KEY_LAST_S3_WRONG, s3WrongLast);

      console.log("[SYNC/B][ok][guard] saved corrected KEY_LAST_S3_WRONG", {
        qid: info.qid,
        KEY_LAST_S3_WRONG,
        after_s3WrongLast: s3WrongLast
      });
    }

    // 3) å·®åˆ†ï¼ˆãƒã‚¤ãƒŠã‚¹ã¯é€ã‚‰ãªã„ï¼‰
    // Fallback-06: delta ã¯åŠ ç®—å°‚ç”¨ã®ãŸã‚ (now - last) ãŒè² ãªã‚‰ 0 ã«ä¸¸ã‚ã¦ã€Œé€ã‚‰ãªã„ã€ã€‚
    // è£œè¶³: ã“ã“ã§ â€œã‚ºãƒ¬â€ ã‚’ 0 ã«æ½°ã™ã®ã§ã€è¡¨é¢ä¸Šã¯é€ä¿¡å‡¦ç†ãŒé€²ã¿å¾—ã‚‹ã€‚
    //       ãƒ­ã‚°è­¦å‘Šã‚’è¦‹è½ã¨ã™ã¨ã€Œã‚ºãƒ¬ãŒã‚ã£ã¦ã‚‚é‹ç”¨ã§ãã¦ã—ã¾ã†ã€ï¼å•é¡ŒãŒéš ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
    const rawDc       = cNow       - cLast;
    const rawDw       = wNow       - wLast;
    const rawDs3      = s3Now      - s3Last;
    const rawDs3Wrong = s3WrongNow - s3WrongLast;

    const dc       = Math.max(0, rawDc);
    const dw       = Math.max(0, rawDw);
    const ds3      = Math.max(0, rawDs3);
    const ds3Wrong = Math.max(0, rawDs3Wrong);

    if (rawDc < 0 || rawDw < 0 || rawDs3 < 0 || rawDs3Wrong < 0) {
      console.warn("[SYNC/B][fallback][deltaClamp] negative delta detected -> clamped to 0", {
        qid: info.qid,
        rawDc,
        rawDw,
        rawDs3,
        rawDs3Wrong,
        dc,
        dw,
        ds3,
        ds3Wrong,
        cNow,
        cLast,
        wNow,
        wLast,
        s3Now,
        s3Last,
        s3WrongNow,
        s3WrongLast
      });
    } else {
      console.log("[SYNC/B][ok][delta] computed delta (all non-negative)", {
        qid: info.qid,
        dc,
        dw,
        ds3,
        ds3Wrong
      });
    }

    // streak3TodayDelta ã¯ cscs_sync_view_b.js å´ã‹ã‚‰ã®ã¿é€ä¿¡ã™ã‚‹ãŸã‚ã€
    // ã“ã“ã§ã¯ streak3Today ç³»ã¯ä¸€åˆ‡æ‰±ã‚ãªã„ã€‚
    // 3é€£ç¶šä¸æ­£è§£é–¢é€£ã‚‚ã€Œä»Šæ—¥ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ã€ã§ã¯ãªãç´¯è¨ˆãƒ»ç¾åœ¨é•·ã ã‘ã‚’æ‰±ã†ã€‚
    if (!dc && !dw && !ds3 && !ds3Wrong && streakLenNow === 0 && streakWrongLenNow === 0 && !maxChanged && !wrongMaxChanged) {
      console.log("[SYNC/B] â˜…é€ä¿¡ãªã—ï¼ˆno deltaï¼‰", {
        qid: info.qid,
        cNow,
        wNow,
        s3Now,
        streakLenNow,
        s3WrongNow,
        streakWrongLenNow,
        cLast,
        wLast,
        s3Last,
        s3WrongLast,
        maxChanged,
        wrongMaxChanged
      });
      return;
    }

    // max / max_day ã¯ã€Œæ›´æ–°ãŒèµ·ããŸã¨ãã ã‘ã€é€ä¿¡ã™ã‚‹ãŸã‚ã€å‰å›é€ä¿¡å€¤ã‚’èª­ã‚€
    const lastMaxOpt          = loadIntOptional(KEY_LAST_STREAK_MAX);
    const lastMaxDayOpt       = loadDayOptional(KEY_LAST_STREAK_MAX_DAY);
    const lastWrongMaxOpt     = loadIntOptional(KEY_LAST_STREAK_WRONG_MAX);
    const lastWrongMaxDayOpt  = loadDayOptional(KEY_LAST_STREAK_WRONG_MAX_DAY);

    const maxChanged = (
      (streakMaxOpt.ok && (!lastMaxOpt.ok || lastMaxOpt.value !== streakMaxOpt.value)) ||
      (streakMaxDayOpt.ok && (!lastMaxDayOpt.ok || lastMaxDayOpt.value !== streakMaxDayOpt.value))
    );

    const wrongMaxChanged = (
      (streakWrongMaxOpt.ok && (!lastWrongMaxOpt.ok || lastWrongMaxOpt.value !== streakWrongMaxOpt.value)) ||
      (streakWrongMaxDayOpt.ok && (!lastWrongMaxDayOpt.ok || lastWrongMaxDayOpt.value !== streakWrongMaxDayOpt.value))
    );

    // 4) /api/sync/merge ã¸ã€Œå·®åˆ†ã ã‘ã€ã‚’é€ä¿¡
    const payload = {
      // è¿½åŠ : payload ã®ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã«ç¨®åˆ¥ã‚’æ˜ç¤ºã—ã€ã€Œdiffï¼ˆå·®åˆ†ï¼‰ã€é€ä¿¡ã§ã‚ã‚‹ã“ã¨ã‚’ã‚µãƒ¼ãƒå´ã«ä¼ãˆã‚‹
      payloadType: "diff",

      // æ—¢å­˜: å·®åˆ†ï¼ˆå¢—åˆ†ï¼‰ã§é€ã‚‹ã‚­ãƒ¼ï¼ˆqidâ†’deltaï¼‰
      correctDelta:         dc       > 0 ? { [info.qid]: dc       } : {},
      incorrectDelta:       dw       > 0 ? { [info.qid]: dw       } : {},
      streak3Delta:         ds3      > 0 ? { [info.qid]: ds3      } : {},
      streak3WrongDelta:    ds3Wrong > 0 ? { [info.qid]: ds3Wrong } : {},

      // æ—¢å­˜: ã€Œå¢—åˆ†ã€ã§ã¯ãªã â€œæœ€æ–°å€¤â€ ã‚’é€ã‚‹ã‚­ãƒ¼ï¼ˆqidâ†’currentï¼‰
      streakLenDelta:                      { [info.qid]: streakLenNow },
      streakWrongLenDelta:                { [info.qid]: streakWrongLenNow },

      // â˜…è¿½åŠ : ã€Œæœ€é«˜é€£ç¶šã€(max / max_day) ã¯ â€œæ›´æ–°ãŒèµ·ããŸã¨ãã ã‘â€ æœ€æ–°å€¤é€ä¿¡ï¼ˆæ¬ æã¯é€ã‚‰ãªã„ï¼‰
      streakMaxDelta:                      (maxChanged && streakMaxOpt.ok) ? { [info.qid]: streakMaxOpt.value } : {},
      streakMaxDayDelta:                   (maxChanged && streakMaxDayOpt.ok) ? { [info.qid]: streakMaxDayOpt.value } : {},
      streakWrongMaxDelta:                 (wrongMaxChanged && streakWrongMaxOpt.ok) ? { [info.qid]: streakWrongMaxOpt.value } : {},
      streakWrongMaxDayDelta:              (wrongMaxChanged && streakWrongMaxDayOpt.ok) ? { [info.qid]: streakWrongMaxDayOpt.value } : {},

      // æ—¢å­˜: é€ä¿¡æ™‚åˆ»
      updatedAt: Date.now()
    };

    console.log("[SYNC/B] merge payload (no streak3TodayDelta)", {
      qid: info.qid,
      cNow,
      wNow,
      s3Now,
      streakLenNow,
      s3WrongNow,
      streakWrongLenNow,
      cLast,
      wLast,
      s3Last,
      s3WrongLast,
      dc,
      dw,
      ds3,
      ds3Wrong,
      payload
    });

    try{
      let _syncKey = "";
      try{
        _syncKey = localStorage.getItem("cscs_sync_key") || "";
      }catch(_){
        // è£œè¶³: localStorage ä¾‹å¤–æ™‚ã¯ã‚­ãƒ¼å–å¾—ã‚’è«¦ã‚ã¦ç©ºæ–‡å­—ã«ã™ã‚‹ï¼ˆã“ã“ã§é€ä¿¡ã¯æ­¢ã¾ã‚‹ï¼‰ã€‚
        //       â€œé€ã‚Œã¡ã‚ƒã†â€ æ–¹å‘ã®éš ã‚Œã§ã¯ãªãã€ã€Œé€ã‚Œãªã„åŸå› ã€ãŒã‚­ãƒ¼å–å¾—å¤±æ•—ã«é›†ç´„ã•ã‚Œã‚‹ç‚¹ã«æ³¨æ„ã€‚
        _syncKey = "";
      }

      // ============================================================
      // é‡è¦:
      //   /api/sync/merge ã¯ã€Œbootstrap å®Œäº†å¾Œã€ã«ã®ã¿å©ã„ã¦ã‚ˆã„ã€‚
      //   localStorage ã®å€¤ã¯ â€œbootstrap å®Œäº†å¾Œã«èª­ã‚€â€ ã“ã¨ã«æ„å‘³ãŒã‚ã‚‹ã€‚
      //   â†’ å…ˆã« promise ã‚’å¾…ã£ã¦ã€æœªæº–å‚™ãªã‚‰æ˜ç¢ºã«ç•°å¸¸åœæ­¢ã™ã‚‹ã€‚
      // ============================================================
      if (!window.__CSCS_SYNC_KEY_PROMISE__ || typeof window.__CSCS_SYNC_KEY_PROMISE__.then !== "function") {
        throw new Error("SYNC_BOOTSTRAP_NOT_READY");
      }

      await window.__CSCS_SYNC_KEY_PROMISE__;

      if (!_syncKey) {
        // è£œè¶³: bootstrap å®Œäº†å¾Œã«ã‚‚ SYNC_KEY ãŒç„¡ã„å ´åˆã¯ç•°å¸¸ã€‚
        //       ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ç¶™ç¶šã›ãšã€å•é¡Œã‚’é¡•åœ¨åŒ–ã•ã›ã‚‹åœæ­¢ã‚¬ãƒ¼ãƒ‰ã€‚
        throw new Error("SYNC_KEY_MISSING_LOCAL");
      }

      const res = await fetch("/api/sync/merge", {
        method:"POST",
        headers:{ "Content-Type":"application/json", "X-CSCS-Key": String(_syncKey) },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(String(res.status));

      // 5) æˆåŠŸã—ãŸã‚‰ã€Œä»Šå›é€ä¿¡å¾Œã®ç´¯ç©å€¤ã€ã‚’ä¿å­˜ã—ã¦æ¬¡å›å·®åˆ†ã®åŸºæº–ã«ã™ã‚‹
      if (dc)       saveInt(KEY_LAST_COR,      cNow);
      if (dw)       saveInt(KEY_LAST_WRG,      wNow);
      if (ds3)      saveInt(KEY_LAST_S3,       s3Now);
      if (ds3Wrong) saveInt(KEY_LAST_S3_WRONG, s3WrongNow);

      // max/max_day ã¯ã€Œæ›´æ–°ãŒèµ·ããŸã¨ãã ã‘ã€é€ã£ã¦ã„ã‚‹ã®ã§ã€ãã®æ™‚ã ã‘ last ã‚’æ›´æ–°ã™ã‚‹
      if (maxChanged && streakMaxOpt.ok)       saveInt(KEY_LAST_STREAK_MAX, streakMaxOpt.value);
      if (maxChanged && streakMaxDayOpt.ok)    saveInt(KEY_LAST_STREAK_MAX_DAY, streakMaxDayOpt.value);
      if (wrongMaxChanged && streakWrongMaxOpt.ok)    saveInt(KEY_LAST_STREAK_WRONG_MAX, streakWrongMaxOpt.value);
      if (wrongMaxChanged && streakWrongMaxDayOpt.ok) saveInt(KEY_LAST_STREAK_WRONG_MAX_DAY, streakWrongMaxDayOpt.value);

      console.log("[SYNC/B] â˜…é€ä¿¡æˆåŠŸï¼ˆmerge OKï¼‰", {
        qid: info.qid
      });
    }catch(e){
      console.warn("[SYNC/B] â˜…é€ä¿¡å¤±æ•—ï¼ˆmerge failedï¼‰", e);
    }
  }

  // b_judge_record.js ã®é›†è¨ˆãŒçµ‚ã‚ã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«è¿‘ã¥ã‘ã‚‹ãŸã‚ã€
  // DOM å®Œæˆå¾Œã« 1 tick é…ã‚‰ã›ã¦å®Ÿè¡Œ
  function schedule(){
    if (document.readyState === "loading") {
      window.addEventListener("DOMContentLoaded", function(){
        setTimeout(syncFromTotals, 0);
      });
    } else {
      setTimeout(syncFromTotals, 0);
    }
  }

  function showStreakStatus(){
    const localTotalCorrect  = loadInt(KEY_S3);
    const syncedTotalCorrect = loadInt(KEY_LAST_S3);
    const localTotalWrong    = loadInt(KEY_S3_WRONG);
    const syncedTotalWrong   = loadInt(KEY_LAST_S3_WRONG);

    console.log("== Bãƒ‘ãƒ¼ãƒˆ: 3é€£ç¶šæ­£è§£ / 3é€£ç¶šä¸æ­£è§£ SYNC ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ==");
    console.log("qid:", info.qid);

    // 3é€£ç¶šæ­£è§£å´ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    console.log("--- 3é€£ç¶šæ­£è§£(â­ï¸) ---");
    console.log("localStorage[KEY_S3] =", localStorage.getItem(KEY_S3), "â†’", localTotalCorrect);
    console.log("localStorage[KEY_LAST_S3] =", localStorage.getItem(KEY_LAST_S3), "â†’", syncedTotalCorrect);

    if (localTotalCorrect === 0 && syncedTotalCorrect === 0) {
      console.log("â„¹ ã¾ã ã“ã®å•é¡Œã§ã¯ 3å›é€£ç¶šæ­£è§£ãŒç™ºç”Ÿã—ã¦ã„ã¾ã›ã‚“ã€‚");
    } else if (localTotalCorrect === syncedTotalCorrect) {
      console.log("âœ… 3é€£ç¶šæ­£è§£å›æ•°: SYNC " + String(syncedTotalCorrect) + " å› / local " + String(localTotalCorrect) + " å›ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰ã§ã™ã€‚");
    } else if (syncedTotalCorrect < localTotalCorrect) {
      console.warn(
        "âš  åŒæœŸå¾…ã¡ã® 3é€£ç¶šæ­£è§£ãŒã‚ã‚Šã¾ã™ã€‚",
        "SYNC å´ =", syncedTotalCorrect, "/ local å´ =", localTotalCorrect,
        "ï¼ˆæ¬¡å›ã® Bãƒ‘ãƒ¼ãƒˆé·ç§»æ™‚ã«è¿½åŠ é€ä¿¡ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ï¼‰"
      );
    } else {
      console.error(
        "âœ• ç•°å¸¸: SYNC å´ã® 3é€£ç¶šæ­£è§£å›æ•°ã®æ–¹ãŒå¤§ãããªã£ã¦ã„ã¾ã™ (SYNC > local)ã€‚",
        "SYNC å´ =", syncedTotalCorrect, "/ local å´ =", localTotalCorrect,
        "ä¸€åº¦ãƒªã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰å†ãƒ†ã‚¹ãƒˆã—ãŸæ–¹ãŒè‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚"
      );
    }

    // 3é€£ç¶šä¸æ­£è§£å´ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆğŸ’£ï¼‰
    console.log("--- 3é€£ç¶šä¸æ­£è§£(ğŸ’£) ---");
    console.log("localStorage[KEY_S3_WRONG] =", localStorage.getItem(KEY_S3_WRONG), "â†’", localTotalWrong);
    console.log("localStorage[KEY_LAST_S3_WRONG] =", localStorage.getItem(KEY_LAST_S3_WRONG), "â†’", syncedTotalWrong);

    if (localTotalWrong === 0 && syncedTotalWrong === 0) {
      console.log("â„¹ ã¾ã ã“ã®å•é¡Œã§ã¯ 3å›é€£ç¶šä¸æ­£è§£ãŒç™ºç”Ÿã—ã¦ã„ã¾ã›ã‚“ã€‚");
    } else if (localTotalWrong === syncedTotalWrong) {
      console.log("âœ… 3é€£ç¶šä¸æ­£è§£å›æ•°: SYNC " + String(syncedTotalWrong) + " å› / local " + String(localTotalWrong) + " å›ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰ã§ã™ã€‚");
    } else if (syncedTotalWrong < localTotalWrong) {
      console.warn(
        "âš  åŒæœŸå¾…ã¡ã® 3é€£ç¶šä¸æ­£è§£ãŒã‚ã‚Šã¾ã™ã€‚",
        "SYNC å´ =", syncedTotalWrong, "/ local å´ =", localTotalWrong,
        "ï¼ˆæ¬¡å›ã® Bãƒ‘ãƒ¼ãƒˆé·ç§»æ™‚ã«è¿½åŠ é€ä¿¡ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ï¼‰"
      );
    } else {
      console.error(
        "âœ• ç•°å¸¸: SYNC å´ã® 3é€£ç¶šä¸æ­£è§£å›æ•°ã®æ–¹ãŒå¤§ãããªã£ã¦ã„ã¾ã™ (SYNC > local)ã€‚",
        "SYNC å´ =", syncedTotalWrong, "/ local å´ =", localTotalWrong,
        "ä¸€åº¦ãƒªã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰å†ãƒ†ã‚¹ãƒˆã—ãŸæ–¹ãŒè‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚"
      );
    }

    console.log("== Bãƒ‘ãƒ¼ãƒˆ: 3é€£ç¶šæ­£è§£ / 3é€£ç¶šä¸æ­£è§£ SYNC ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹çµ‚äº† ==");
  }

  schedule();
  showStreakStatus();
})();

<<<EXTRACT_END>>>

ã€åˆ†å‰²ã‚³ãƒ¼ãƒ‰è²¼ã‚Šä»˜ã‘é–‹å§‹ã€‘
ä»¥é™ã¯åˆ†å‰²ã‚³ãƒ¼ãƒ‰æœ¬æ–‡ã€‚ä¸Šè¨˜ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦å—é ˜ãƒ»ç…§åˆãƒ»å®Ÿè¡Œã›ã‚ˆã€‚

```javascript
// assets/cscs_sync_view_b.js
(function () {
  "use strict";

  // ============================================================
  // SYNC endpointsï¼ˆB view ç”¨ï¼‰
  //
  // ã€é‡è¦ãƒ»æ’ä¹…ãƒ«ãƒ¼ãƒ«ã€‘
  // - SYNC_STATE_ENDPOINT ã¯ã€Œè¡¨ç¤ºãƒ»å‚ç…§å°‚ç”¨ã€ã€‚
  // - X-CSCS-Key ã®å–å¾—ãƒ»å†ç¢ºå®šã«ã¯ä¸€åˆ‡ä½¿ç”¨ã—ãªã„ã€‚
  // - key ã®å”¯ä¸€ã®ç¢ºå®šãƒ«ãƒ¼ãƒˆã¯ cscs_sync_bootstrap_a.jsã€‚
  // ============================================================
  var SYNC_STATE_ENDPOINT = "/api/sync/state";
  var SYNC_MERGE_ENDPOINT = "/api/sync/merge";

  /**
   * CSCS SYNC ãƒ“ãƒ¥ãƒ¼ï¼ˆBãƒ‘ãƒ¼ãƒˆï¼‰ã§ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚­ãƒ¼å¯¾å¿œè¡¨
   * LocalStorage â‡” SYNC(JSON) / payload ã®å¯¾å¿œï¼ˆqid ã¯ "YYYYMMDD-NNN"ï¼‰
   *
   * ã€é‡è¦ï¼šé–‹ç™ºãƒ«ãƒ¼ãƒ«ï¼ˆæ’ä¹…ï¼‰ã€‘
   *   ğŸ“Œ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ä½¿ç”¨ã™ã‚‹ LocalStorage / SYNC ã‚­ãƒ¼åã«
   *       ã€Œå¤‰æ›´ã€ã¾ãŸã¯ã€Œæ–°è¦è¿½åŠ ã€ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€
   *       å¿…ãš **æœ¬ã‚­ãƒ¼å¯¾å¿œè¡¨ã‚³ãƒ¡ãƒ³ãƒˆã«è¿½è¨˜ã™ã‚‹ã“ã¨**ã€‚
   *   - b_judge_record.jsãƒ»SYNC Workerï¼ˆmerge/state.tsï¼‰å´ã¨
   *     ã‚­ãƒ¼ä»•æ§˜ã®ä¸æ•´åˆãŒç”Ÿã˜ã‚‹ã“ã¨ã‚’é˜²ãç›®çš„ã€‚
   *   - ã“ã“ã«æ›¸ã‹ã‚Œã¦ã„ãªã„ã‚­ãƒ¼ã¯åŸå‰‡ã¨ã—ã¦ä½¿ç”¨ç¦æ­¢ã€‚
   *
   * â–¼ å•é¡Œåˆ¥ç´¯è¨ˆ
   *   - localStorage: "cscs_q_correct_total:" + qid
   *       â‡” SYNC state: state.correct[qid]
   *   - localStorage: "cscs_q_wrong_total:" + qid
   *       â‡” SYNC state: state.incorrect[qid]
   *
   * â–¼ å•é¡Œåˆ¥ 3 é€£ç¶šæ­£è§£ï¼ˆâ­ï¸ç”¨ï¼‰
   *   - localStorage: "cscs_q_correct_streak3_total:" + qid
   *       â‡” SYNC state: state.streak3[qid]
   *   - localStorage: "cscs_q_correct_streak_len:" + qid
   *       â‡” SYNC state: state.streakLen[qid]
   *   - payload(merge): streak3Delta[qid] / streakLenDelta[qid]
   *
   * â–¼ å•é¡Œåˆ¥ 3 é€£ç¶šä¸æ­£è§£
   *   - localStorage: "cscs_q_wrong_streak3_total:" + qid
   *       â‡” SYNC state: state.streak3Wrong[qid]
   *   - localStorage: "cscs_q_wrong_streak_len:" + qid
   *       â‡” SYNC state: state.streakWrongLen[qid]
   *   - payload(merge): streak3WrongDelta[qid] / streakWrongLenDelta[qid]
   *
   * â–¼ å•é¡Œåˆ¥ é€£ç¶šä¸æ­£è§£ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«è¨ˆæ¸¬ï¼šb_judge_record.jsï¼‰
   *   - localStorage: "cscs_q_wrong_streak_max:" + qid
   *       ï¼ˆæœ€é«˜é€£ç¶šä¸æ­£è§£æ•°ï¼‰
   *   - localStorage: "cscs_q_wrong_streak_max_day:" + qid
   *       ï¼ˆãã®é”æˆæ—¥ JST YYYYMMDDï¼‰
   *
   * â–¼ ä»Šæ—¥ã®â­ï¸ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°ï¼ˆStreak3Todayï¼‰
   *   - localStorage: "cscs_streak3_today_day"ï¼ˆstring: "YYYYMMDD"ï¼‰
   *       â‡” SYNC state: state.streak3Today.dayï¼ˆstring: "YYYYMMDD"ï¼‰
   *   - localStorage: "cscs_streak3_today_qids"
   *       â‡” SYNC state: state.streak3Today.qids
   *   - localStorage: "cscs_streak3_today_unique_count"
   *       â‡” SYNC state: state.streak3Today.unique_count
   *   - payload(merge): streak3TodayDelta { day, qids }ï¼ˆday: string "YYYYMMDD"ï¼‰
   *
   * â–¼ ä»Šæ—¥ã®3é€£ç¶šä¸æ­£è§£ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°ï¼ˆStreak3WrongTodayï¼‰
   *   - localStorage: "cscs_streak3_wrong_today_day"ï¼ˆstring: "YYYYMMDD"ï¼‰
   *       â‡” SYNC state: state.streak3WrongToday.dayï¼ˆstring: "YYYYMMDD"ï¼‰
   *   - localStorage: "cscs_streak3_wrong_today_qids"
   *       â‡” SYNC state: state.streak3WrongToday.qids
   *   - localStorage: "cscs_streak3_wrong_today_unique_count"
   *       â‡” SYNC state: state.streak3WrongToday.unique_count
   *   - payload(merge): streak3WrongTodayDelta { day, qids }ï¼ˆday: string "YYYYMMDD"ï¼‰
   *
   * â–¼ 1 æ—¥ 1 å›è¨ˆæ¸¬ãƒ¢ãƒ¼ãƒ‰ï¼ˆoncePerDayTodayï¼‰
   *   - localStorage: "cscs_once_per_day_today_day"
   *       â‡” SYNC state: state.oncePerDayToday.dayï¼ˆnumber: YYYYMMDDï¼‰
   *   - localStorage: "cscs_once_per_day_today_results"
   *       â‡” SYNC state: state.oncePerDayToday.results[qid]
   *   - payload(merge): oncePerDayTodayDelta { day, results }ï¼ˆday: number YYYYMMDDï¼‰
   *
   * â–¼ å•é¡Œåˆ¥ æœ€çµ‚æ—¥æƒ…å ±ï¼ˆlastSeen / lastCorrect / lastWrongï¼‰
   *   - localStorage: "cscs_q_last_seen_day:" + qid
   *       â‡” SYNC state: state.lastSeenDay[qid]
   *   - localStorage: "cscs_q_last_correct_day:" + qid
   *       â‡” SYNC state: state.lastCorrectDay[qid]
   *   - localStorage: "cscs_q_last_wrong_day:" + qid
   *       â‡” SYNC state: state.lastWrongDay[qid]
   *   - payload(merge): lastSeenDayDelta[qid] / lastCorrectDayDelta[qid] / lastWrongDayDelta[qid]
   *
   * â–¼ ã‚°ãƒ­ãƒ¼ãƒãƒ«æƒ…å ±
   *   - localStorage: "cscs_total_questions"
   *       â‡” SYNC state: state.global.totalQuestions
   *       â‡” payload(merge): global.totalQuestions
   *
   * â–¼ O.D.O.A / æ¤œè¨¼ãƒ¢ãƒ¼ãƒ‰é–¢é€£
   *   - SYNC state: state.odoa_mode ("on" / "off")
   *   - runtime: window.CSCS_VERIFY_MODE ("on" / "off")
   *
   * â–¼ HUD(Bãƒ“ãƒ¥ãƒ¼) è¡¨ç¤ºçŠ¶æ…‹
   *   - localStorage: "cscs_sync_view_b_pending_collapsed"
   *       â†’ "1" ã®ã¨ã Pending (unsent) ã‚’æŠ˜ã‚ŠãŸãŸã¿è¡¨ç¤ºã«ã™ã‚‹
   *   - localStorage: "cscs_sync_view_b_correct_streak_collapsed"
   *       â†’ "1" ã®ã¨ã Correct Streak ã‚’æŠ˜ã‚ŠãŸãŸã¿è¡¨ç¤ºã«ã™ã‚‹
   *   - localStorage: "cscs_sync_view_b_once_odoa_collapsed"
   *       â†’ "1" ã®ã¨ã OncePerDayToday / O.D.O.A Mode ã‚’æŠ˜ã‚ŠãŸãŸã¿è¡¨ç¤ºã«ã™ã‚‹ï¼ˆè¦‹å‡ºã—ï¼‹1è¡Œç›®ã®ã¿ï¼‰
   */

  // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
  //   OncePerDayToday / O.D.O.A Mode ã®è¡¨ç¤ºã¯ã€Œbody å°‚ç”¨ã€ã«ä¸€æœ¬åŒ–ã™ã‚‹ãŸã‚ã€
  //   status(#cscs_sync_view_b_status) ç”¨ã®è¡¨ç¤ºçŠ¶æ…‹ä¿æŒã¯å»ƒæ­¢ã™ã‚‹ã€‚

  // â˜… ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«å†…ã§ç®¡ç†ã™ã‚‹ CSSï¼ˆã“ã“ã«ã©ã‚“ã©ã‚“è¿½è¨˜ã—ã¦ã„ãï¼‰
  //   - #cscs_sync_view_b ãŒç¾è¡Œã®ãƒ‘ãƒãƒ«ID
  //   - å°†æ¥ #cscs_sync_monitor_b ã«å¤‰ãˆã¦ã‚‚åŒã˜CSSãŒåŠ¹ãã‚ˆã†ã€ä¸¡æ–¹ã‚’å¯¾è±¡ã«ã—ã¦ã„ã‚‹
  var CSCS_SYNC_VIEW_B_CSS = [
    "/* cscs_sync_view_b.js injected CSS */",
    "#cscs_sync_view_b,",
    "#cscs_sync_monitor_b {",
    "  position: fixed;",
    "  right: 10px;",
    "  top: 110px;",
    "  color: #eee;",
    "  padding: 8px;",
    "  font: 11px/1.2 system-ui, -apple-system, \"Segoe UI\", Roboto, sans-serif;",
    "  max-width: 46vw;",
    "  width: 310px;",
    "  opacity: 0.55;",
    "  z-index: 2147483647;",
    "}",
    "",
    "/* --- card layout for status body --- */",
    "#cscs_sync_view_b_title {",
    "  text-align: right;",
    "  margin-right: 7px;",
    "  opacity: 0.60;",
    "  font-size: 10px;",
    "  font-weight: 400;",
    "}",
    "",
    "#cscs_sync_view_b_body {",
    "  display: grid;",
    "  grid-template-columns: 1fr;",
    "  gap: 1px;",
    "  margin-top: 6px;",
    "  padding-top: 0px;",
    "  border-top: none;",
    "}",
    "",
    "/* --- 3é€£ç¶šï¼ˆæ­£è§£/ä¸æ­£è§£ï¼‰4æšã‚’ 2åˆ—Ã—2æ®µã§å›ºå®šé…ç½® --- */",
    "#cscs_sync_view_b_body .svb-streak-quad {",
    "  display: grid;",
    "  grid-template-columns: 1fr 1fr;",
    "  gap: 1px 1px;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-streak-quad .svb-streak-card {",
    "  width: 100%;",
    "  box-sizing: border-box;",
    "}",
    "",
    "#cscs_sync_view_b_body .cscs-svb-card {",
    "    background: rgba(0,0,0,0.52);",
    "    border: 1px solid rgba(255,255,255,0.14);",
    "    box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);",
    "    border-radius: 10px;",
    "    padding: 10px 10px;",
    "    width: 100%;",
    "    box-sizing: border-box;",
    "    line-height: 1;",
    "}",
    "",
    "/* --- Counts card only: tighter padding --- */",
    "#cscs_sync_view_b_body .cscs-svb-card.svb-counts {",
    "  padding: 5px 10px;",
    "}",
    "",
    "#cscs_sync_view_b_body .cscs-svb-card.is-wide {",
    "  grid-column: 1 / -1;",
    "  font-weight: 350;",
    "}",
    "",
    "/* --- wide card: å·¦å³ã‚«ãƒ©ãƒ å¹…ã‚’åŒä¸€ã«å›ºå®šï¼ˆkey/value ã‚’ç­‰å¹…ï¼‰ --- */",
    "#cscs_sync_view_b_body .cscs-svb-card.is-wide .cscs-svb-card-grid {",
    "  grid-template-columns: minmax(0, 1fr) auto;",
    "}",
    "",
    "#cscs_sync_view_b_body .cscs-svb-card-title {",
    "  font-weight: 500;",
    "  opacity: 0.90;",
    "  margin-bottom: 5px;",
    "  letter-spacing: 0.2px;",
    "  white-space: nowrap;",
    "  overflow: hidden;",
    "  text-overflow: ellipsis;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-title-suffix {",
    "  font-size: 9px;",
    "  font-weight: 600;",
    "  opacity: 0.55;",
    "  margin-left: 6px;",
    "  white-space: nowrap;",
    "}",
    "",
    "#cscs_sync_view_b_body .cscs-svb-card-grid {",
    "  display: grid;",
    "  grid-template-columns: minmax(0, 1fr) auto;",
    "  column-gap: 0px;",
    "  row-gap: 3px;",
    "  opacity: 0.60;",
    "}",
    "",
    "/* --- Pending card only: ç¸¦ç©ã¿ï¼ˆkeyâ†’valueâ†’...ï¼‰ --- */",
    "#cscs_sync_view_b_body .svb-pending-grid {",
    "  display: grid;",
    "  grid-template-columns: 1fr;",
    "  row-gap: 4px;",
    "  opacity: 0.60;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-pending-grid .cscs-svb-k {",
    "  opacity: 0.85;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-pending-grid .cscs-svb-v {",
    "  text-align: left;",
    "  white-space: pre-line;",
    "}",
    "",
    "/* --- Pending fold (collapsible) --- */",
    "#cscs_sync_view_b_body .svb-pending-head {",
    "  display: flex;",
    "  align-items: baseline;",
    "  justify-content: space-between;",
    "  gap: 10px;",
    "  height: 13px;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-pending-toggle {",
    "  appearance: none;",
    "  -webkit-appearance: none;",
    "  border: none;",
    "  background: transparent;",
    "  color: inherit;",
    "  padding: 0;",
    "  margin: 0;",
    "  font: inherit;",
    "  cursor: pointer;",
    "  opacity: 0.80;",
    "  white-space: nowrap;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-pending-toggle:hover {",
    "  opacity: 0.95;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-pending-toggle .svb-pending-chev {",
    "  display: inline-block;",
    "  width: 1.2em;",
    "  text-align: center;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-pending-card.is-collapsed .svb-pending-grid {",
    "  display: none;",
    "}",
    "",
    "/* --- Correct Streak fold (collapsible) --- */",
    "#cscs_sync_view_b_body .svb-correct-streak-head {",
    "  display: flex;",
    "  align-items: baseline;",
    "  justify-content: space-between;",
    "  gap: 10px;",
    "  height: 13px;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-correct-streak-toggle {",
    "  appearance: none;",
    "  -webkit-appearance: none;",
    "  border: none;",
    "  background: transparent;",
    "  color: inherit;",
    "  padding: 0;",
    "  margin: 0;",
    "  font: inherit;",
    "  cursor: pointer;",
    "  opacity: 0.80;",
    "  white-space: nowrap;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-correct-streak-toggle:hover {",
    "  opacity: 0.95;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-correct-streak-toggle .svb-correct-streak-chev {",
    "  display: inline-block;",
    "  width: 1.2em;",
    "  text-align: center;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-correct-streak-card.is-collapsed .cscs-svb-card-grid {",
    "  display: none;",
    "}",
    "",
    "/* --- OncePerDayToday / O.D.O.A fold (collapsible) --- */",
    "#cscs_sync_view_b_body .svb-once-odoa-head {",
    "  display: flex;",
    "  align-items: baseline;",
    "  justify-content: space-between;",
    "  gap: 10px;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-once-odoa-toggle {",
    "  appearance: none;",
    "  -webkit-appearance: none;",
    "  border: none;",
    "  background: transparent;",
    "  color: inherit;",
    "  padding: 0;",
    "  margin: 0;",
    "  font: inherit;",
    "  cursor: pointer;",
    "  opacity: 0.80;",
    "  white-space: nowrap;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-once-odoa-toggle:hover {",
    "  opacity: 0.95;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-once-odoa-toggle .svb-once-odoa-chev {",
    "  display: inline-block;",
    "  width: 1.2em;",
    "  text-align: center;",
    "}",
    "",
    "/* æŠ˜ã‚ŠãŸãŸã¿æ™‚ï¼š1è¡Œç›®ï¼ˆæœ€åˆã®2ã‚»ãƒ«ï¼‰ã ã‘æ®‹ã™ */",
    "#cscs_sync_view_b_body .svb-once-odoa-card.is-collapsed .svb-wide-dual-grid > :nth-child(n+3) {",
    "  display: none;",
    "}",
    "",
    "#cscs_sync_view_b_body .cscs-svb-k {",
    "  opacity: 0.85;",
    "  white-space: nowrap;",
    "  overflow: hidden;",
    "  text-overflow: ellipsis;",
    "}",
    "",
    "#cscs_sync_view_b_body .cscs-svb-v {",
    "  text-align: right;",
    "  font-variant-numeric: tabular-nums;",
    "  white-space: nowrap;",
    "  overflow: hidden;",
    "  text-overflow: ellipsis;",
    "  min-width: 0;",
    "}",
    "",
    "#cscs_sync_view_b_body .cscs-svb-muted {",
    "  opacity: 0.70;",
    "}",
    "",
    "/* --- Counts: 1è¡Œï¼ˆCounts + SYNC/local/diff ã‚’æ¨ªä¸€åˆ—ï¼‰ --- */",
    "#cscs_sync_view_b_body .svb-counts-inline {",
    "  display: flex;",
    "  align-items: baseline;",
    "  gap: 10px;",
    "  white-space: nowrap;",
    "  overflow: hidden;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-counts-inline .svb-counts-head {",
    "  font-weight: 800;",
    "  opacity: 0.90;",
    "  min-width: 0;",
    "  overflow: hidden;",
    "  text-overflow: ellipsis;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-counts-inline .svb-counts-head {",
    "  font-weight: 800;",
    "  opacity: 0.90;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-counts-inline .svb-counts-part {",
    "  display: inline-flex;",
    "  align-items: baseline;",
    "  justify-content: center;",
    "  gap: 6px;",
    "  flex: 1 1 0;",
    "  min-width: 0;",
    "  text-align: center;",
    "  box-shadow: none;",
    "  background: transparent;",
    "  border: none;",
    "  padding: 0;",
    "  overflow: hidden;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-counts-inline .svb-counts-part.is-muted {",
    "  opacity: 0.78;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-counts-inline .svb-counts-k {",
    "  opacity: 0.85;",
    "  white-space: nowrap;",
    "  min-width: 0;",
    "  overflow: hidden;",
    "  text-overflow: ellipsis;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-counts-inline .svb-counts-v {",
    "  text-align: left;",
    "  font-variant-numeric: tabular-nums;",
    "  white-space: nowrap;",
    "  min-width: 0;",
    "  overflow: hidden;",
    "  text-overflow: ellipsis;",
    "}",
    "",
    "/* --- Wide card: dual-column text rows (OncePerDayToday / O.D.O.A) --- */",
    "#cscs_sync_view_b_body .svb-wide-dual-grid {",
    "  display: grid;",
    "  grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);",
    "  column-gap: 10px;",
    "  row-gap: 3px;",
    "  opacity: 0.60;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-wide-dual-cell {",
    "  min-width: 0;",
    "  white-space: nowrap;",
    "  overflow: hidden;",
    "  text-overflow: ellipsis;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-wide-dual-cell.is-right {",
    "  text-align: right;",
    "  font-variant-numeric: tabular-nums;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-wide-dual-strong {",
    "  opacity: 0.70;",
    "  font-weight: 500;",
    "}",
    "",
    "/* --- Wide card: single full-width row (ODOA line) --- */",
    "#cscs_sync_view_b_body .svb-wide-single {",
    "  grid-column: 1 / -1;",
    "  min-width: 0;",
    "  white-space: nowrap;",
    "  overflow: hidden;",
    "  text-overflow: ellipsis;",
    "}",
    "",
    "/* --- LastDay: 3 columns (label / SYNC / local) --- */",
    "#cscs_sync_view_b_body {",
    "  /* ä½•ã‚’ã—ã¦ã„ã‚‹ã‹: LastDayã®åˆ—å¹…ãƒ«ãƒ¼ãƒ«ã‚’CSSå¤‰æ•°ã¨ã—ã¦1ç®‡æ‰€ã«é›†ç´„ã—ã€è¦‹å‡ºã—/æœ¬æ–‡ã®ã‚ºãƒ¬è¦å› ã‚’æ’é™¤ã™ã‚‹ */",
    "  --svb-lastday-col-1: minmax(0, 1fr);",
    "  --svb-lastday-col-2: minmax(0, 14ch);",
    "  --svb-lastday-col-3: minmax(0, 14ch);",
    "  /* ä½•ã‚’ã—ã¦ã„ã‚‹ã‹: è¦‹å‡ºã—/æœ¬æ–‡ã§åŒä¸€ã®åˆ—é–“ã‚®ãƒ£ãƒƒãƒ—ã‚’â€œå…±æœ‰â€ã—ã€å¾®å¦™ãªã‚ºãƒ¬ã‚’é˜²ã */",
    "  --svb-lastday-col-gap: 10px;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-lastday-head {",
    "  display: grid;",
    "  /* ä½•ã‚’ã—ã¦ã„ã‚‹ã‹: è¦‹å‡ºã—/æœ¬æ–‡ã§åŒä¸€ã®åˆ—å®šç¾©(å¤‰æ•°)ã‚’ä½¿ã„ã€åˆ—å¹…ã‚’å®Œå…¨ä¸€è‡´ã•ã›ã‚‹ */",
    "  grid-template-columns: var(--svb-lastday-col-1) var(--svb-lastday-col-2) var(--svb-lastday-col-3);",
    "  /* ä½•ã‚’ã—ã¦ã„ã‚‹ã‹: ã‚°ãƒªãƒƒãƒ‰ãŒã‚«ãƒ¼ãƒ‰å¹…ã„ã£ã±ã„ã«ä¼¸ã³ã‚‹ã‚ˆã†ã«æ˜ç¤ºã—ã€å·¦ç«¯èµ·ç‚¹ã‚’æƒãˆã‚‹ */",
    "  width: 100%;",
    "  box-sizing: border-box;",
    "  /* ä½•ã‚’ã—ã¦ã„ã‚‹ã‹: 3åˆ—ãƒ–ãƒ­ãƒƒã‚¯å†…ã®â€œé–‹å§‹ä½ç½®â€ã‚’å›ºå®šã™ã‚‹ï¼ˆç¸®å°æ™‚ã®ã‚ºãƒ¬æŠ‘åˆ¶ï¼‰ */",
    "  justify-items: stretch;",
    "  column-gap: var(--svb-lastday-col-gap);",
    "  row-gap: 3px;",
    "  align-items: baseline;",
    "  opacity: 0.90;",
    "  font-weight: 500;",
    "  margin-bottom: 5px;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-lastday-head .svb-lastday-k {",
    "  min-width: 0;",
    "  white-space: nowrap;",
    "  overflow: hidden;",
    "  text-overflow: ellipsis;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-lastday-head .svb-lastday-v {",
    "  /* ä½•ã‚’ã—ã¦ã„ã‚‹ã‹: è¦‹å‡ºã—å´ã‚‚æœ¬æ–‡å´ã¨åŒæ§˜ã«ç¸®å°è€æ€§(min-width:0)ã‚’æŒãŸã›ã€åˆ—å¹…è¨ˆç®—ã®å·®ã‚’æ¶ˆã™ */",
    "  min-width: 0;",
    "  text-align: right;",
    "  justify-self: end;",
    "  font-variant-numeric: tabular-nums;",
    "  white-space: nowrap;",
    "  overflow: hidden;",
    "  text-overflow: ellipsis;",
    "}",
    "",
    "/* --- LastDay: è¦‹å‡ºã—ã®çœŸã‚“ä¸­åˆ—ï¼ˆSYNCåˆ—ï¼‰ã ã‘â€œã‚»ãƒ³ã‚¿ãƒ¼å¯„ã‚Šâ€ã«å›ºå®š --- */",
    "#cscs_sync_view_b_body .svb-lastday-head .svb-lastday-v.svb-lastday-mid {",
    "  text-align: center;",
    "  justify-self: center;",
    "}",
    "",
    "/* --- LastDay: çœŸã‚“ä¸­åˆ—ï¼ˆSYNCï¼‰ã ã‘ä¸­å¤®æƒãˆï¼ˆnth-childä¾å­˜ã‚’ã‚„ã‚ã¦classæŒ‡å®šã«ã™ã‚‹ï¼‰ --- */",
    "/* ä½•ã‚’ã—ã¦ã„ã‚‹ã‹: LastDayã®çœŸã‚“ä¸­åˆ—ã«ä»˜ä¸ã™ã‚‹ .svb-lastday-mid ã‚’ä¸­å¤®å¯„ã›ã«å›ºå®šã™ã‚‹ */",
    "#cscs_sync_view_b_body .svb-lastday-mid {",
    "  text-align: center;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-lastday-grid {",
    "  display: grid;",
    "  /* ä½•ã‚’ã—ã¦ã„ã‚‹ã‹: è¦‹å‡ºã—ã¨åŒä¸€ã®åˆ—å®šç¾©(å¤‰æ•°)ã‚’ä½¿ã„ã€æœ¬æ–‡ã®3åˆ—ãƒ–ãƒ­ãƒƒã‚¯ä½ç½®ã‚’å®Œå…¨ä¸€è‡´ã•ã›ã‚‹ */",
    "  grid-template-columns: var(--svb-lastday-col-1) var(--svb-lastday-col-2) var(--svb-lastday-col-3);",
    "  /* ä½•ã‚’ã—ã¦ã„ã‚‹ã‹: æœ¬æ–‡å´ã‚‚ã‚«ãƒ¼ãƒ‰å¹…ã„ã£ã±ã„ã«ä¼¸ã°ã—ã€åˆ—å¹…è¨ˆç®—ã®èµ·ç‚¹ã‚’ä¸€è‡´ã•ã›ã‚‹ */",
    "  width: 100%;",
    "  box-sizing: border-box;",
    "  /* ä½•ã‚’ã—ã¦ã„ã‚‹ã‹: è¦‹å‡ºã—ã¨åŒä¸€ã®â€œåˆ—é–“ã‚®ãƒ£ãƒƒãƒ—(å¤‰æ•°)â€ã‚’ä½¿ã„ã€æ¨ªä½ç½®ã‚’æƒãˆã‚‹ */",
    "  column-gap: var(--svb-lastday-col-gap);",
    "  row-gap: 3px;",
    "  opacity: 0.60;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-lastday-grid .svb-lastday-k {",
    "  opacity: 0.85;",
    "  min-width: 0;",
    "  white-space: nowrap;",
    "  overflow: hidden;",
    "  text-overflow: ellipsis;",
    "}",
    "",
    "#cscs_sync_view_b_body .svb-lastday-grid .svb-lastday-v {",
    "  text-align: right;",
    "  justify-self: end;",
    "  font-variant-numeric: tabular-nums;",
    "  white-space: nowrap;",
    "  overflow: hidden;",
    "  text-overflow: ellipsis;",
    "  min-width: 0;",
    "}",
    "",
    "/* --- LastDay: æœ¬æ–‡ã®çœŸã‚“ä¸­åˆ—ï¼ˆSYNCåˆ—ï¼‰ã ã‘â€œã‚»ãƒ³ã‚¿ãƒ¼å¯„ã‚Šâ€ã«å›ºå®š --- */",
    "#cscs_sync_view_b_body .svb-lastday-grid .svb-lastday-v.svb-lastday-mid {",
    "  text-align: center;",
    "  justify-self: center;",
    "}",
    "",
    "/* --- O.D.O.A status line: è¡¨ç¤ºã—ãªã„ï¼ˆDOMã¯æ®‹ã™ï¼‰ --- */",
    "#cscs_sync_view_b_status {",
    "  display: none !important;",
    "}",
    "/* --- SYNC send button (manual) --- */",
    "#cscs_sync_view_b_send_btn {",
    "  margin-top: 6px;",
    "  width: 100%;",
    "  padding: 8px 10px;",
    "  border-radius: 10px;",
    "  border: 1px solid rgba(255,255,255,0.14);",
    "  background: rgba(0,0,0,0.52);",
    "  color: #eee;",
    "  font: 11px/1.2 system-ui, -apple-system, \"Segoe UI\", Roboto, sans-serif;",
    "  opacity: 0.85;",
    "  cursor: pointer;",
    "}",
    "",
    "#cscs_sync_view_b_send_btn:hover {",
    "  opacity: 0.98;",
    "}",
    "",
    "#cscs_sync_view_b_send_btn:active {",
    "  transform: translateY(1px);",
    "}",
    ""
  ].join("\n");

  // â˜… styleã‚¿ã‚°ã‚’1å›ã ã‘æ³¨å…¥ï¼ˆåŒã˜idãŒã‚ã‚Œã°ä¸­èº«ã‚’æ›´æ–°ã—ã¦ä¸Šæ›¸ãï¼‰
  function upsertStyleTag(styleId, cssText) {
    try {
      var head = document.head || document.getElementsByTagName("head")[0] || null;
      if (!head) {
        return;
      }

      var el = document.getElementById(styleId);
      if (!el) {
        el = document.createElement("style");
        el.id = styleId;
        el.type = "text/css";
        head.appendChild(el);
      }

      if (el.textContent !== cssText) {
        el.textContent = cssText;
      }
    } catch (e) {
      console.error("[SYNC-B:view] upsertStyleTag failed:", e);
    }
  }

  function ensureSyncViewBStyles() {
    upsertStyleTag("cscs_sync_view_b_inline_css", CSCS_SYNC_VIEW_B_CSS);
  }

  function detectInfo() {
    var path = window.location.pathname || "";
    var m = path.match(/_build_cscs_(\d{8})\/slides\/q(\d{3})_b(?:\.html)?$/);
    if (!m) return null;
    var day = m[1];
    var num3 = m[2];
    var qid = day + "-" + num3;
    return { day: day, num3: num3, qid: qid };
  }

  var info = detectInfo();
  if (!info) {
    return;
  }

  function readIntFromLocalStorage(key) {
    try {
      var raw = window.localStorage.getItem(key);
      if (raw === null || raw === undefined) {
        return 0;
      }
      var n = parseInt(raw, 10);
      if (!Number.isFinite(n) || n < 0) {
        return 0;
      }
      return n;
    } catch (e) {
      console.error("[SYNC-B:view] failed to read int from localStorage:", key, e);
      return 0;
    }
  }

  // â˜… JST æ—¥ä»˜(YYYYMMDD) ã‚’ localStorage ã‹ã‚‰å®‰å…¨ã«èª­ã¿å‡ºã™ãƒ˜ãƒ«ãƒ‘ãƒ¼
  //   - æ­£è¦ã® "YYYYMMDD" ã§ãªã‘ã‚Œã° null ã‚’è¿”ã—ã€SYNC ã«ã¯è¼‰ã›ãªã„
  function readDayFromLocalStorage(key) {
    try {
      var raw = window.localStorage.getItem(key);
      if (raw === null || raw === undefined || raw === "") {
        return null;
      }
      if (!/^\d{8}$/.test(raw)) {
        return null;
      }
      var n = parseInt(raw, 10);
      if (!Number.isFinite(n) || n <= 0) {
        return null;
      }
      return n;
    } catch (e) {
      console.error("[SYNC-B:view] failed to read day from localStorage:", key, e);
      return null;
    }
  }

  // â˜… ç·å•é¡Œæ•° cscs_total_questions ã‚’å®‰å…¨ã«èª­ã¿å‡ºã™å°‚ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
  //   - æ­£ã®æ•´æ•°ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ã„ãªã‘ã‚Œã° null ã‚’è¿”ã—ã€é€ä¿¡ã—ãªã„
  function readTotalQuestionsFromLocalStorage() {
    var key = "cscs_total_questions";
    try {
      var raw = window.localStorage.getItem(key);
      if (raw === null || raw === undefined) {
        return null;
      }
      var n = parseInt(raw, 10);
      if (!Number.isFinite(n) || n <= 0) {
        return null;
      }
      return n;
    } catch (e) {
      console.error("[SYNC-B:view] failed to read cscs_total_questions:", e);
      return null;
    }
  }

  // â˜… oncePerDay ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚’èª­ã¿å‡ºã™
  //   - day: number | nullï¼ˆYYYYMMDDï¼‰
  //   - results: { qid: "correct" | "wrong" }
  function readOncePerDayTodayFromLocal() {
    var dayStr = null;
    try {
      dayStr = window.localStorage.getItem("cscs_once_per_day_today_day");
    } catch (_e) {
      dayStr = null;
    }

    var results = {};
    try {
      var raw = window.localStorage.getItem("cscs_once_per_day_today_results") || "{}";
      results = JSON.parse(raw);
    } catch (_e2) {
      results = {};
    }
    if (!results || typeof results !== "object") {
      results = {};
    }

    var dayNum = null;
    if (dayStr && /^\d{8}$/.test(dayStr)) {
      var n = parseInt(dayStr, 10);
      if (Number.isFinite(n)) {
        dayNum = n;
      }
    }

    return {
      day: dayNum,
      results: results
    };
  }
  
    // â˜… HUDç”¨ï¼šé€ä¿¡å¾…æ©Ÿï¼ˆSYNCæœªåæ˜ ã£ã½ã„ã‚‚ã®ï¼‰ã‚’åˆ¤å®šã—ã¦è¿”ã™
  //   - ãƒ­ãƒ¼ã‚«ãƒ«ã¨ SYNC(state) ã‚’æ¯”è¼ƒã—ã¦ã€Œæœªåæ˜ ã®å¯èƒ½æ€§ã€ã‚’æ‹¾ã†
  //   - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§åˆ¥ã‚½ãƒ¼ã‚¹ã‚’è¦‹ãªã„ï¼ˆlocalStorage ã¨ window.__cscs_sync_state ã®ã¿ï¼‰
  function computePendingFlags(syncState, qid) {
    var flags = {
      pendingDiffCounts: false,
      pendingOncePerDayToday: false,
      pendingLastSeenDay: false,
      pendingLastCorrectDay: false,
      pendingLastWrongDay: false,
      pendingStreak3Today: false,
      pendingStreak3WrongToday: false,
      details: []
    };

    try {
      // ---- oncePerDayTodayï¼ˆã“ã®qidãŒSYNCã«å…¥ã£ã¦ã‚‹ã‹ï¼‰----
      try {
        var localOnce = readOncePerDayTodayFromLocal();
        if (localOnce && typeof localOnce.day === "number" && localOnce.results && typeof localOnce.results === "object") {
          var localOnceVal = localOnce.results[qid];
          if (localOnceVal === "correct" || localOnceVal === "wrong") {
            var serverOnceVal = null;
            if (syncState &&
                syncState.oncePerDayToday &&
                typeof syncState.oncePerDayToday === "object" &&
                typeof syncState.oncePerDayToday.day === "number" &&
                syncState.oncePerDayToday.results &&
                typeof syncState.oncePerDayToday.results === "object") {
              if (syncState.oncePerDayToday.day === localOnce.day) {
                if (Object.prototype.hasOwnProperty.call(syncState.oncePerDayToday.results, qid)) {
                  serverOnceVal = syncState.oncePerDayToday.results[qid];
                }
              }
            }
            if (serverOnceVal !== localOnceVal) {
              flags.pendingOncePerDayToday = true;
              flags.details.push("oncePerDayToday");
            }
          }
        }
      } catch (_eOnce) {}

      // ---- lastDayï¼ˆlocalã«å€¤ãŒã‚ã‚Šã€SYNCã¨é•ã†ï¼‰----
      try {
        var locSeen = readDayFromLocalStorage("cscs_q_last_seen_day:" + qid);
        var locCor  = readDayFromLocalStorage("cscs_q_last_correct_day:" + qid);
        var locWro  = readDayFromLocalStorage("cscs_q_last_wrong_day:" + qid);

        var srvSeen = null;
        var srvCor  = null;
        var srvWro  = null;

        if (syncState) {
          if (syncState.lastSeenDay && typeof syncState.lastSeenDay === "object" && syncState.lastSeenDay[qid] != null) {
            if (typeof syncState.lastSeenDay[qid] === "number" && Number.isFinite(syncState.lastSeenDay[qid]) && syncState.lastSeenDay[qid] > 0) {
              srvSeen = syncState.lastSeenDay[qid];
            }
          }
          if (syncState.lastCorrectDay && typeof syncState.lastCorrectDay === "object" && syncState.lastCorrectDay[qid] != null) {
            if (typeof syncState.lastCorrectDay[qid] === "number" && Number.isFinite(syncState.lastCorrectDay[qid]) && syncState.lastCorrectDay[qid] > 0) {
              srvCor = syncState.lastCorrectDay[qid];
            }
          }
          if (syncState.lastWrongDay && typeof syncState.lastWrongDay === "object" && syncState.lastWrongDay[qid] != null) {
            if (typeof syncState.lastWrongDay[qid] === "number" && Number.isFinite(syncState.lastWrongDay[qid]) && syncState.lastWrongDay[qid] > 0) {
              srvWro = syncState.lastWrongDay[qid];
            }
          }
        }

        if (locSeen !== null && locSeen !== srvSeen) {
          flags.pendingLastSeenDay = true;
          flags.details.push("lastSeenDay");
        }
        if (locCor !== null && locCor !== srvCor) {
          flags.pendingLastCorrectDay = true;
          flags.details.push("lastCorrectDay");
        }
        if (locWro !== null && locWro !== srvWro) {
          flags.pendingLastWrongDay = true;
          flags.details.push("lastWrongDay");
        }
      } catch (_eLast) {}

      // ---- streak3Todayï¼ˆlocal qidsãŒã‚ã‚‹ã®ã«SYNCå´ã«åæ˜ ã•ã‚Œã¦ãªã•ãã†ï¼‰----
      try {
        var localDay = "";
        var localQids = [];
        try {
          localDay = localStorage.getItem("cscs_streak3_today_day") || "";
          var raw = localStorage.getItem("cscs_streak3_today_qids");
          if (raw) {
            var parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) {
              localQids = parsed.filter(function (x) { return typeof x === "string" && x; });
            }
          }
        } catch (_eS3t) {
          localDay = "";
          localQids = [];
        }

        if (localDay && localQids.length > 0) {
          var syncDay = "";
          var syncQids = [];
          if (syncState && syncState.streak3Today && typeof syncState.streak3Today === "object") {
            if (typeof syncState.streak3Today.day === "number" && Number.isFinite(syncState.streak3Today.day)) {
              syncDay = String(syncState.streak3Today.day);
            }
            if (Array.isArray(syncState.streak3Today.qids)) {
              syncQids = syncState.streak3Today.qids.filter(function (x) { return typeof x === "string" && x; });
            }
          }

          var missing = false;
          if (syncDay !== localDay) {
            missing = true;
          } else {
            var set = Object.create(null);
            for (var i = 0; i < syncQids.length; i++) {
              set[syncQids[i]] = 1;
            }
            for (var j = 0; j < localQids.length; j++) {
              if (!set[localQids[j]]) {
                missing = true;
                break;
              }
            }
          }

          if (missing) {
            flags.pendingStreak3Today = true;
            flags.details.push("streak3Today");
          }
        }
      } catch (_eS3t2) {}

      // ---- streak3WrongTodayï¼ˆlocal qidsãŒã‚ã‚‹ã®ã«SYNCå´ã«åæ˜ ã•ã‚Œã¦ãªã•ãã†ï¼‰----
      try {
        var localDayW = "";
        var localQidsW = [];
        try {
          localDayW = localStorage.getItem("cscs_streak3_wrong_today_day") || "";
          var rawW = localStorage.getItem("cscs_streak3_wrong_today_qids");
          if (rawW) {
            var parsedW = JSON.parse(rawW);
            if (Array.isArray(parsedW)) {
              localQidsW = parsedW.filter(function (x) { return typeof x === "string" && x; });
            }
          }
        } catch (_eS3w) {
          localDayW = "";
          localQidsW = [];
        }

        if (localDayW && localQidsW.length > 0) {
          var syncDayW = "";
          var syncQidsW = [];
          if (syncState && syncState.streak3WrongToday && typeof syncState.streak3WrongToday === "object") {
            if (typeof syncState.streak3WrongToday.day === "number" && Number.isFinite(syncState.streak3WrongToday.day)) {
              syncDayW = String(syncState.streak3WrongToday.day);
            }
            if (Array.isArray(syncState.streak3WrongToday.qids)) {
              syncQidsW = syncState.streak3WrongToday.qids.filter(function (x) { return typeof x === "string" && x; });
            }
          }

          var missingW = false;
          if (syncDayW !== localDayW) {
            missingW = true;
          } else {
            var setW = Object.create(null);
            for (var k = 0; k < syncQidsW.length; k++) {
              setW[syncQidsW[k]] = 1;
            }
            for (var t = 0; t < localQidsW.length; t++) {
              if (!setW[localQidsW[t]]) {
                missingW = true;
                break;
              }
            }
          }

          if (missingW) {
            flags.pendingStreak3WrongToday = true;
            flags.details.push("streak3WrongToday");
          }
        }
      } catch (_eS3w2) {}

    } catch (_eAll) {}

    return flags;
  }

  // â˜… ã‚µãƒ¼ãƒ state.oncePerDayToday ã¨æ¯”è¼ƒã—ã¦ delta ã‚’ä½œã‚‹
  //   - å·®åˆ†ãŒç„¡ã‘ã‚Œã° null ã‚’è¿”ã™
  //   - ä½•ã‹ã—ã‚‰å·®åˆ†ãŒã‚ã‚Œã° { day, results } ã‚’è¿”ã™
  function buildOncePerDayTodayDelta(syncState) {
    try {
      var local = readOncePerDayTodayFromLocal();
      if (!local.day) {
        console.log("[SYNC-B:oncePerDay] local has no valid day â†’ deltaãªã—", {
          local: local
        });
        return null;
      }

      var server = null;
      if (
        syncState &&
        syncState.oncePerDayToday &&
        typeof syncState.oncePerDayToday === "object"
      ) {
        server = syncState.oncePerDayToday;
      }

      var deltaResults = {};
      if (!server || typeof server.day !== "number" || server.day !== local.day) {
        // ã‚µãƒ¼ãƒå´ã«ãƒ‡ãƒ¼ã‚¿ãŒç„¡ã„ or åˆ¥æ—¥ â†’ å½“æ—¥ãƒ­ãƒ¼ã‚«ãƒ«ã‚’ä¸¸ã”ã¨é€ã‚‹
        deltaResults = local.results;
      } else {
        // åŒã˜æ—¥ä»˜ â†’ å€¤ãŒé•ã†ã‚‚ã®ã ã‘é€ã‚‹
        var serverResults = server.results || {};
        for (var qid in local.results) {
          if (!Object.prototype.hasOwnProperty.call(local.results, qid)) continue;
          var localVal = local.results[qid];
          var serverVal = serverResults[qid];
          if (localVal !== serverVal) {
            deltaResults[qid] = localVal;
          }
        }
      }

      var keys = Object.keys(deltaResults);
      if (!keys.length) {
        console.log("[SYNC-B:oncePerDay] server ã¨ local ã§å·®åˆ†ãªã— â†’ deltaé€ä¿¡ä¸è¦", {
          day: local.day
        });
        return null;
      }

      var delta = {
        day: local.day,
        results: deltaResults
      };

      console.log("[SYNC-B:oncePerDay] buildOncePerDayTodayDelta", {
        local: local,
        server: server,
        delta: delta
      });

      return delta;
    } catch (e) {
      console.error("[SYNC-B:oncePerDay] buildOncePerDayTodayDelta error:", e);
      return null;
    }
  }

  function clearSyncBody() {
    var body = document.getElementById("cscs_sync_view_b_body");
    if (!body) return null;

    // â˜… ä½•ã‚’ã—ã¦ã„ã‚‹ã‹:
    //   ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã®å†æç”»ã§ body ã‚’å…¨æ¶ˆã—ã™ã‚‹ã¨ Once/ODOA ã®2æšï¼ˆSYNC/localï¼‰ãŒä¸€ç¬æ¶ˆãˆã‚‹ï¼ˆã¡ã‚‰ã¤ãï¼‰ãŸã‚ã€
    //   ".svb-once-odoa-card"ï¼ˆå…ˆé ­=SYNCæƒ³å®šï¼‰ã¨ ".svb-once-odoa-card-local" ã®2æšã ã‘ã¯ DOM ä¸Šã«æ®‹ã—ã€
    //   ãã‚Œä»¥å¤–ã®å­è¦ç´ ã®ã¿å‰Šé™¤ã™ã‚‹ã€‚
    var keepSync = null;
    var keepLocal = null;
    try {
      var cards = body.querySelectorAll(".svb-once-odoa-card");
      if (cards && cards.length > 0) {
        keepSync = cards[0];
      }
      keepLocal = body.querySelector(".svb-once-odoa-card-local");
    } catch (_eKeep) {
      keepSync = null;
      keepLocal = null;
    }

    var node = body.firstChild;
    while (node) {
      var next = node.nextSibling;

      if (keepSync && node === keepSync) {
        node = next;
        continue;
      }
      if (keepLocal && node === keepLocal) {
        node = next;
        continue;
      }

      body.removeChild(node);
      node = next;
    }

    return body;
  }

  function updateSyncBodyText(text) {
    var body = clearSyncBody();
    if (!body) return;

    // ã‚¨ãƒ©ãƒ¼æ™‚ãªã©ï¼šã‚«ãƒ¼ãƒ‰1æšã§è¡¨ç¤ºï¼ˆç‹­ã„/åºƒã„ä¸¡æ–¹ã§å´©ã‚Œã«ãã„ï¼‰
    var card = document.createElement("div");
    card.className = "cscs-svb-card is-wide";

    var title = document.createElement("div");
    title.className = "cscs-svb-card-title";
    title.textContent = "Status";

    var grid = document.createElement("div");
    grid.className = "cscs-svb-card-grid";

    var k = document.createElement("div");
    k.className = "cscs-svb-k cscs-svb-muted";
    k.textContent = "message";

    var v = document.createElement("div");
    v.className = "cscs-svb-v";
    v.textContent = String(text);

    grid.appendChild(k);
    grid.appendChild(v);

    card.appendChild(title);
    card.appendChild(grid);
    body.appendChild(card);
  }

  function appendGridRow(gridEl, key, value, keyClass, valClass) {
    var k = document.createElement("div");
    k.className = "cscs-svb-k" + (keyClass ? " " + keyClass : "");
    k.textContent = key;

    var v = document.createElement("div");
    v.className = "cscs-svb-v" + (valClass ? " " + valClass : "");
    v.textContent = value;

    gridEl.appendChild(k);
    gridEl.appendChild(v);
  }

  function appendGridSection(body, title, options) {
    options = options || {};
    var wide = !!options.wide;

    var card = document.createElement("div");
    card.className = "cscs-svb-card" + (wide ? " is-wide" : "");

    var h = document.createElement("div");
    h.className = "cscs-svb-card-title";
    h.textContent = title;

    var grid = document.createElement("div");
    grid.className = "cscs-svb-card-grid";

    card.appendChild(h);
    card.appendChild(grid);
    body.appendChild(card);

    return grid;
  }


```
<<<PART_END>>>
ã€RECEIPT_INPUTï¼ˆã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã ã‘ã‚’çœŸã¨ã™ã‚‹ï¼‰ã€‘
EXPECTED_TOTAL: 5
RECEIVED_TOTAL: 1

CUMULATIVE_RECEIVED_PARTIDS:
- CSCSJS-06411020-P01-of-05

ã€ChatGPTã¸ã®å¼·åˆ¶ãƒ«ãƒ¼ãƒ«ã€‘
ãƒ»å—é ˜ç¢ºèªã¯ã€ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã® CUMULATIVE_RECEIVED_PARTIDS ã¨ EXPECTED_PARTIDS ã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã€‚
ãƒ»ä¼šè©±å±¥æ­´ã‹ã‚‰ PartID ã‚’å†åé›†ã—ãªã„ã“ã¨ï¼ˆç¦æ­¢ï¼‰ã€‚
ãƒ»å—é ˜ç¢ºèªOKå‰ã«ã€ã‚³ãƒ¼ãƒ‰å†…å®¹ã®è§£é‡ˆãƒ»è¦ç´„ãƒ»æ¨æ¸¬ãƒ»ä¿®æ­£æ¡ˆæç¤ºã‚’ã—ãªã„ã“ã¨ï¼ˆç¦æ­¢ï¼‰ã€‚

RECEIPT_REQUIRED_RESPONSE_TEMPLATE:
ACK: <PartID> <PartSHA256_8> / WAITING_NEXT

ã€åˆ†å‰²ã‚³ãƒ¼ãƒ‰(1)ã®çµ‚äº†ã€‘â†’ æ¬¡ã¯ åˆ†å‰²ã‚³ãƒ¼ãƒ‰(2) ã‚’é€ã‚Šã¾ã™
ã€ChatGPTã¸ã®æŒ‡ç¤ºã€‘è§£é‡ˆãƒ»è¦ç´„ãƒ»æ¨æ¸¬ãƒ»ä¿®æ­£æ¡ˆæç¤ºã¯ç¦æ­¢ã€‚è¿”ç­”ã¯æ¬¡ã®ã¿ã€‚
ACK: <PartID> / WAITING_NEXT
